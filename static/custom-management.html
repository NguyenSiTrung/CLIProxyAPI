<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLI Proxy API - Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d0d1a;
      --bg-secondary: #141428;
      --bg-card: rgba(25, 25, 55, 0.8);
      --bg-card-hover: rgba(35, 35, 75, 0.85);
      --bg-input: rgba(10, 10, 25, 0.6);
      --border-color: rgba(140, 140, 220, 0.35);
      --border-glow: rgba(0, 212, 255, 0.4);
      --text-primary: #f0f0ff;
      --text-secondary: #b8b8d8;
      --text-muted: #8888aa;
      --accent-cyan: #00e5ff;
      --accent-purple: #a78bfa;
      --accent-green: #22d3a0;
      --accent-yellow: #fbbf24;
      --accent-red: #f87171;
      --accent-blue: #60a5fa;
      --sidebar-width: 240px;
      --sidebar-collapsed: 64px;
      --header-height: 64px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: var(--bg-primary);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 48px;
      width: 100%;
      max-width: 420px;
      text-align: center;
    }

    .login-card h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-card p {
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15);
      background: rgba(15, 15, 35, 0.8);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid rgba(160, 160, 240, 0.5);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: rgba(40, 40, 80, 0.9);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .btn-danger:hover {
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.4);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .app {
      display: none;
    }

    .app.active {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-color);
      padding: 20px 12px;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      margin-bottom: 24px;
    }

    .sidebar-logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-text {
      font-weight: 600;
      font-size: 16px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(0, 212, 255, 0.1);
      color: var(--accent-cyan);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-secondary);
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      opacity: 0.08;
      transform: translate(30%, -30%);
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .stat-card:hover::before {
      opacity: 0.12;
      transform: translate(25%, -25%) scale(1.1);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-icon svg {
      width: 24px;
      height: 24px;
    }

    .stat-content {
      flex: 1;
      min-width: 0;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .stat-card.cyan::before { background: var(--accent-cyan); }
    .stat-card.cyan .stat-value { color: var(--accent-cyan); }
    .stat-card.cyan .stat-icon { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }

    .stat-card.purple::before { background: var(--accent-purple); }
    .stat-card.purple .stat-value { color: var(--accent-purple); }
    .stat-card.purple .stat-icon { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }

    .stat-card.green::before { background: var(--accent-green); }
    .stat-card.green .stat-value { color: var(--accent-green); }
    .stat-card.green .stat-icon { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }

    .stat-card.yellow::before { background: var(--accent-yellow); }
    .stat-card.yellow .stat-value { color: var(--accent-yellow); }
    .stat-card.yellow .stat-icon { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }

    /* Dashboard Page Header */
    #page-dashboard .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .dashboard-welcome {
      flex: 1;
    }

    /* Health Indicator */
    .health-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      background: rgba(34, 211, 160, 0.1);
      border: 1px solid rgba(34, 211, 160, 0.3);
      border-radius: 30px;
      transition: all 0.3s;
    }

    .health-indicator.offline {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .health-pulse {
      width: 10px;
      height: 10px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .health-indicator.offline .health-pulse {
      background: var(--accent-red);
      animation: none;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 211, 160, 0.6); }
      70% { box-shadow: 0 0 0 8px rgba(34, 211, 160, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 211, 160, 0); }
    }

    .health-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-green);
    }

    .health-indicator.offline .health-text {
      color: var(--accent-red);
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .quick-action-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    .quick-action-btn span {
      font-size: 13px;
      font-weight: 500;
    }

    .quick-action-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .quick-action-icon svg {
      width: 22px;
      height: 22px;
    }

    .quick-action-btn:hover .quick-action-icon {
      transform: scale(1.1);
    }

    .quick-action-icon.cyan { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }
    .quick-action-icon.purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
    .quick-action-icon.green { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }
    .quick-action-icon.yellow { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }
    .quick-action-icon.blue { background: rgba(96, 165, 250, 0.15); color: var(--accent-blue); }
    .quick-action-icon.red { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }

    /* Server Status Card */
    .server-status-card .card-header {
      margin-bottom: 16px;
    }

    .server-status-card .card-title {
      display: flex;
      align-items: center;
    }

    .server-status-grid {
      display: grid;
      gap: 12px;
    }

    .server-status-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .server-status-item:hover {
      border-color: var(--border-color);
      background: rgba(255, 255, 255, 0.02);
    }

    .status-icon-wrapper {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .status-icon-wrapper svg {
      width: 20px;
      height: 20px;
    }

    .status-icon-wrapper.cyan { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }
    .status-icon-wrapper.purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
    .status-icon-wrapper.green { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }

    .status-info {
      flex: 1;
      min-width: 0;
    }

    .status-info h4 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .status-info p {
      font-size: 14px;
      color: var(--text-primary);
      margin: 0;
      word-break: break-word;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.04);
    }

    td {
      color: var(--text-primary);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-green {
      background: rgba(34, 211, 160, 0.2);
      color: var(--accent-green);
      border: 1px solid rgba(34, 211, 160, 0.3);
    }

    .badge-yellow {
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .badge-red {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
      border: 1px solid rgba(248, 113, 113, 0.3);
    }

    .badge-cyan {
      background: rgba(0, 229, 255, 0.2);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .badge-purple {
      background: rgba(167, 139, 250, 0.2);
      color: var(--accent-purple);
      border: 1px solid rgba(167, 139, 250, 0.3);
    }

    .badge-blue {
      background: rgba(96, 165, 250, 0.2);
      color: var(--accent-blue);
      border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .date-range-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .date-range-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .date-range-btn.active {
      background: var(--accent-cyan);
      color: #0d0d1a;
    }

    .chart-view-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-view-btn:hover {
      color: var(--text-primary);
    }

    .chart-view-btn.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: rgba(100, 100, 150, 0.3);
      border-radius: 26px;
      transition: all 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .toggle input:checked+.toggle-slider {
      background: var(--accent-cyan);
    }

    .toggle input:checked+.toggle-slider::before {
      transform: translateX(22px);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-row:last-child {
      border-bottom: none;
    }

    .settings-info h4 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .settings-info p {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab.active {
      color: var(--accent-cyan);
      background: rgba(0, 212, 255, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 100%;
      max-width: 500px;
      margin: 20px;
      /* removed overflow-y: auto and max-height to allow dropdowns to overflow */
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
    }

    .toast {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-left: 3px solid var(--accent-green);
    }

    .toast.error {
      border-left: 3px solid var(--accent-red);
    }

    .toast.info {
      border-left: 3px solid var(--accent-cyan);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .oauth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .oauth-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid rgba(160, 160, 240, 0.45);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .oauth-btn:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }

    .code-editor {
      width: 100%;
      min-height: 400px;
      padding: 16px;
      background: rgba(5, 5, 15, 0.7);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: #e0e0f0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
    }

    .code-editor:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.1);
    }

    /* Log Viewer Enhanced Styles */
    .log-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--bg-card);
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }

    .log-filter-group {
      display: flex;
      gap: 4px;
      background: rgba(0, 0, 0, 0.2);
      padding: 4px;
      border-radius: var(--radius-sm);
    }

    .log-filter-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .log-filter-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .log-filter-btn.active {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .log-filter-btn.active.filter-error {
      color: var(--accent-red);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .log-filter-btn.active.filter-warn {
      color: var(--accent-yellow);
      border-color: rgba(251, 191, 36, 0.3);
    }

    .log-filter-btn.active.filter-info {
      color: var(--accent-blue);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .log-filter-btn.active.filter-debug {
      color: var(--accent-green);
      border-color: rgba(34, 211, 160, 0.3);
    }

    .log-search-container {
      flex: 1;
      position: relative;
      min-width: 200px;
    }

    .log-search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }

    .log-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      width: 16px;
      height: 16px;
    }

    .terminal-window {
      background: #09090b;
      /* Deep black/gray */
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      height: calc(100vh - 180px);
      /* Dynamic height */
      min-height: 500px;
    }

    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
      position: relative;
      /* Ensure positioning context */
    }

    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: #181825;
      border-bottom: 1px solid var(--border-color);
    }

    .terminal-title {
      font-size: 12px;
      color: var(--text-secondary);
      font-family: 'Monaco', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .terminal-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.active {
      background: var(--accent-green);
      box-shadow: 0 0 8px rgba(34, 211, 160, 0.6);
      animation: pulse 2s infinite;
    }

    .log-viewer-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      scroll-behavior: smooth;
    }

    .log-entry {
      display: grid;
      grid-template-columns: 85px 60px 1fr;
      /* Time, Level, Msg */
      gap: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 2px;
      transition: background 0.1s;
      align-items: start;
      border-left: 2px solid transparent;
    }

    .log-entry:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .log-time {
      color: #6c7086;
      font-size: 11px;
      white-space: nowrap;
    }

    .log-lvl {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 1px 6px;
      border-radius: 3px;
      text-align: center;
      width: fit-content;
    }

    .log-lvl.info {
      color: #89b4fa;
      background: rgba(137, 180, 250, 0.1);
    }

    .log-lvl.warn {
      color: #f9e2af;
      background: rgba(249, 226, 175, 0.1);
    }

    .log-lvl.error {
      color: #f38ba8;
      background: rgba(243, 139, 168, 0.1);
    }

    .log-lvl.debug {
      color: #a6e3a1;
      background: rgba(166, 227, 161, 0.1);
    }

    .log-msg {
      color: #cdd6f4;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .log-entry.error {
      border-left-color: var(--accent-red);
      background: rgba(248, 113, 113, 0.05);
    }

    .log-entry.warn {
      border-left-color: var(--accent-yellow);
      background: rgba(251, 191, 36, 0.05);
    }

    /* Scrollbar customization for logs */
    .log-viewer-content::-webkit-scrollbar {
      width: 10px;
    }

    .log-viewer-content::-webkit-scrollbar-track {
      background: #09090b;
    }

    .log-viewer-content::-webkit-scrollbar-thumb {
      background: #313244;
      border-radius: 5px;
      border: 2px solid #09090b;
    }

    .log-viewer-content::-webkit-scrollbar-thumb:hover {
      background: #45475a;
    }

    .empty-logs {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      gap: 12px;
      opacity: 0.7;
    }

    .log-entry {
      cursor: pointer;
    }

    .log-count-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
    }

    .log-count-badge.error {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
    }

    .log-count-badge.warn {
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    /* API Keys Page Styles */
    .keys-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .keys-page-header .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keys-page-header .page-title svg {
      width: 28px;
      height: 28px;
      color: var(--accent-cyan);
    }

    .keys-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 6px;
      background: rgba(20, 20, 45, 0.6);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      width: fit-content;
    }

    .keys-tab {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
    }

    .keys-tab svg {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }

    .keys-tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.06);
    }

    .keys-tab.active {
      color: white;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }

    .keys-tab.active svg {
      opacity: 1;
    }

    .keys-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .keys-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .keys-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .keys-section-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keys-section-title h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .keys-section-title .key-count {
      background: rgba(0, 229, 255, 0.15);
      color: var(--accent-cyan);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .keys-grid {
      display: grid;
      gap: 12px;
    }

    .key-card {
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.9), rgba(25, 25, 55, 0.95));
      border: 1px solid rgba(160, 160, 240, 0.25);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .key-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent-cyan), var(--accent-purple));
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .key-card:hover {
      border-color: rgba(0, 229, 255, 0.4);
      transform: translateX(4px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .key-card:hover::before {
      opacity: 1;
    }

    .key-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.15), rgba(167, 139, 250, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .key-icon svg {
      width: 20px;
      height: 20px;
      color: var(--accent-cyan);
    }

    .key-info {
      flex: 1;
      min-width: 0;
    }

    .key-value {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .key-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .key-actions {
      display: flex;
      gap: 8px;
    }

    .key-action-btn {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
    }

    .key-action-btn.copy {
      background: rgba(34, 211, 160, 0.15);
      color: var(--accent-green);
      border-color: rgba(34, 211, 160, 0.3);
    }

    .key-action-btn.copy:hover {
      background: rgba(34, 211, 160, 0.25);
      box-shadow: 0 0 12px rgba(34, 211, 160, 0.2);
    }

    .key-action-btn.delete {
      background: rgba(248, 113, 113, 0.15);
      color: var(--accent-red);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .key-action-btn.delete:hover {
      background: rgba(248, 113, 113, 0.25);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.2);
    }

    .key-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .keys-empty-state {
      text-align: center;
      padding: 48px 24px;
      background: linear-gradient(135deg, rgba(25, 25, 55, 0.5), rgba(20, 20, 45, 0.6));
      border: 1px dashed rgba(160, 160, 240, 0.3);
      border-radius: var(--radius-lg);
    }

    .keys-empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .keys-empty-state h4 {
      color: var(--text-secondary);
      font-size: 16px;
      margin-bottom: 8px;
    }

    .keys-empty-state p {
      color: var(--text-muted);
      font-size: 13px;
      max-width: 280px;
      margin: 0 auto;
    }

    .btn-add-key {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.25);
    }

    .btn-add-key:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.35);
    }

    .btn-add-key svg {
      width: 16px;
      height: 16px;
    }

    /* Configuration Page Styles */
    .config-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .config-page-header .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .config-page-header .page-title svg {
      width: 28px;
      height: 28px;
      color: var(--accent-purple);
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
    }

    .config-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .config-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.6), rgba(25, 25, 55, 0.4));
      border-bottom: 1px solid var(--border-color);
    }

    .config-section-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(0, 229, 255, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .config-section-icon svg {
      width: 20px;
      height: 20px;
      color: var(--accent-purple);
    }

    .config-section-icon.cyan svg {
      color: var(--accent-cyan);
    }

    .config-section-title h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .config-section-title p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .config-settings-list {
      padding: 8px 0;
    }

    .config-setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .config-setting-item:hover {
      background: rgba(255, 255, 255, 0.03);
      border-left-color: var(--accent-cyan);
    }

    .config-setting-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .config-setting-icon {
      width: 36px;
      height: 36px;
      background: rgba(100, 100, 150, 0.15);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .config-setting-icon svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .config-setting-text h4 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .config-setting-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Enhanced Toggle Switch */
    .toggle-enhanced {
      position: relative;
      width: 52px;
      height: 28px;
      cursor: pointer;
    }

    .toggle-enhanced input {
      display: none;
    }

    .toggle-enhanced-slider {
      position: absolute;
      inset: 0;
      background: rgba(80, 80, 120, 0.4);
      border-radius: 28px;
      transition: all 0.3s ease;
      border: 1px solid rgba(120, 120, 180, 0.3);
    }

    .toggle-enhanced-slider::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      left: 2px;
      top: 2px;
      background: linear-gradient(135deg, #fff, #e8e8f0);
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-enhanced input:checked+.toggle-enhanced-slider {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-color: transparent;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    .toggle-enhanced input:checked+.toggle-enhanced-slider::before {
      transform: translateX(24px);
    }

    /* Config Editor Section */
    .config-editor-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .config-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.6), rgba(25, 25, 55, 0.4));
      border-bottom: 1px solid var(--border-color);
    }

    .config-editor-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .config-editor-title .icon-box {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.2), rgba(167, 139, 250, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .config-editor-title .icon-box svg {
      width: 20px;
      height: 20px;
      color: var(--accent-cyan);
    }

    .config-editor-title h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .config-editor-title p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .btn-save-config {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-green), #1a9a7a);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(34, 211, 160, 0.25);
    }

    .btn-save-config:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 211, 160, 0.35);
    }

    .btn-save-config svg {
      width: 16px;
      height: 16px;
    }

    .config-editor-content {
      padding: 0;
    }

    .config-editor-content .code-editor {
      border: none;
      border-radius: 0;
      min-height: 350px;
      background: rgba(5, 5, 15, 0.5);
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }

      .sidebar-logo-text,
      .nav-item span {
        display: none;
      }

      .main {
        margin-left: var(--sidebar-collapsed);
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Amp Page Styles */
    .amp-hero {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.1), rgba(167, 139, 250, 0.1));
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      position: relative;
      overflow: hidden;
    }

    .amp-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(0, 229, 255, 0.05) 0%, transparent 50%);
      animation: rotate 20s linear infinite;
    }

    .amp-hero-content {
      position: relative;
      z-index: 1;
      max-width: 600px;
    }

    .amp-hero h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--text-primary), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .amp-hero p {
      color: var(--text-secondary);
      font-size: 16px;
      line-height: 1.6;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      transition: color 0.2s;
      pointer-events: none;
    }

    .input-with-icon .form-input {
      padding-left: 44px;
    }

    .input-with-icon .form-input:focus~.input-icon {
      color: var(--accent-cyan);
    }

    .btn-save-amp {
      margin-top: 16px;
      width: 100%;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      box-shadow: 0 4px 15px rgba(0, 229, 255, 0.2);
      color: #fff;
      font-weight: 600;
    }

    .btn-save-amp:hover {
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.3);
      transform: translateY(-2px);
    }

    .mappings-list {
      display: grid;
      gap: 12px;
    }

    .mapping-card {
      background: rgba(20, 20, 40, 0.5);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      transition: all 0.2s;
    }

    .mapping-card:hover {
      border-color: var(--accent-cyan);
      background: rgba(30, 30, 60, 0.6);
    }

    .mapping-flow {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .mapping-source,
    .mapping-target {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .mapping-arrow {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .mapping-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .mapping-card:hover .mapping-actions {
      opacity: 1;
    }

    .mapping-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.05);
    }

    .mapping-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .mapping-action-btn.edit {
      color: var(--accent-cyan);
    }

    .mapping-action-btn.edit:hover {
      background: rgba(0, 229, 255, 0.15);
      border-color: var(--accent-cyan);
    }

    .mapping-action-btn.delete {
      color: var(--accent-red);
    }

    .mapping-action-btn.delete:hover {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--accent-red);
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1>CLI Proxy API</h1>
      <p>Enter your management key to continue</p>
      <div class="form-group"><label>Management Key</label><input type="password" id="loginKey" class="form-input"
          placeholder="Enter your secret key" autofocus></div><button class="btn btn-primary"
        onclick="login()">Authenticate</button>
      <p id="loginError" style="color: var(--accent-red); margin-top: 16px; display: none;"></p>
    </div>
  </div>
  <div id="app" class="app">
    <nav class="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">CP</div><span class="sidebar-logo-text">CLI Proxy</span>
      </div><a class="nav-item active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
        </svg><span>Dashboard</span></a><a class="nav-item" data-page="models"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
          <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
          <line x1="12" y1="22.08" x2="12" y2="12" />
        </svg><span>Models</span></a><a class="nav-item" data-page="auth"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
        </svg><span>Authentication</span></a><a class="nav-item" data-page="keys"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg><span>API Keys</span></a><a class="nav-item" data-page="config"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </svg><span>Configuration</span></a><a class="nav-item" data-page="usage"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 20V10m-6 10V4M6 20v-6" />
        </svg><span>Usage Stats</span></a><a class="nav-item" data-page="analytics"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg><span>Analytics</span></a><a class="nav-item" data-page="amp"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
        </svg><span>Amp Code</span></a><a class="nav-item" data-page="logs"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <path d="M14 2v6h6" />
          <path d="M16 13H8m8 4H8m2-8H8" />
        </svg><span>Logs</span></a>
      <div class="sidebar-footer"><a class="nav-item" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9" />
          </svg><span>Logout</span></a></div>
    </nav>
    <main class="main">
      <div id="page-dashboard" class="page active">
        <div class="page-header">
          <div class="dashboard-welcome">
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Server overview and quick actions</p>
          </div>
          <div class="health-indicator" id="healthIndicator">
            <div class="health-pulse"></div>
            <span class="health-text">Online</span>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card cyan">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statModels">-</div>
              <div class="stat-label">Available Models</div>
            </div>
          </div>
          <div class="stat-card purple">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <path d="M9 12l2 2 4-4"></path>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statAuthFiles">-</div>
              <div class="stat-label">Auth Files</div>
            </div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statRequests">-</div>
              <div class="stat-label">Total Requests</div>
            </div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statSuccess">-</div>
              <div class="stat-label">Success Rate</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="quick-actions-grid">
            <button class="quick-action-btn" onclick="navigateTo('models')">
              <div class="quick-action-icon cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
              </div>
              <span>View Models</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('auth')">
              <div class="quick-action-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
              </div>
              <span>Add Auth</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('usage')">
              <div class="quick-action-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"></line>
                  <line x1="12" y1="20" x2="12" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
              </div>
              <span>View Usage</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('logs')">
              <div class="quick-action-icon yellow">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </div>
              <span>View Logs</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('keys')">
              <div class="quick-action-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                </svg>
              </div>
              <span>API Keys</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('config')">
              <div class="quick-action-icon red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
              </div>
              <span>Settings</span>
            </button>
          </div>
        </div>
        <div class="card server-status-card">
          <div class="card-header">
            <h3 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                <line x1="6" y1="6" x2="6.01" y2="6"></line>
                <line x1="6" y1="18" x2="6.01" y2="18"></line>
              </svg>
              Server Status
            </h3>
            <button class="btn btn-secondary btn-sm" onclick="loadDashboard()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Refresh
            </button>
          </div>
          <div class="server-status-grid">
            <div class="server-status-item">
              <div class="status-icon-wrapper cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                  <line x1="16" y1="8" x2="2" y2="22"></line>
                  <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
              </div>
              <div class="status-info">
                <h4>Server Version</h4>
                <p id="serverVersion">Loading...</p>
              </div>
              <span class="badge badge-cyan" id="versionBadge">-</span>
            </div>
            <div class="server-status-item">
              <div class="status-icon-wrapper purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="status-info">
                <h4>Build Date</h4>
                <p id="buildDate">-</p>
              </div>
            </div>
            <div class="server-status-item">
              <div class="status-icon-wrapper green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </div>
              <div class="status-info">
                <h4>Latest Version</h4>
                <p id="latestVersion">-</p>
              </div>
              <button class="btn btn-secondary btn-sm" onclick="checkLatestVersion()">Check Update</button>
            </div>
          </div>
        </div>
      </div>
      <div id="page-models" class="page">
        <div class="page-header">
          <h1 class="page-title">Available Models</h1>
          <p class="page-subtitle">AI models accessible through the proxy</p>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Models List</h3><button class="btn btn-secondary btn-sm"
              onclick="loadModels()">Refresh</button>
          </div>
          <div class="form-group" style="margin-bottom:16px"><input type="text" id="modelSearch" class="form-input"
              placeholder="Search models..." oninput="filterModels()"></div>
          <div id="modelsContainer">
            <p style="color:var(--text-secondary)">Loading models...</p>
          </div>
        </div>
      </div>
      <div id="page-auth" class="page">
        <div class="page-header">
          <h1 class="page-title">Authentication</h1>
          <p class="page-subtitle">Manage OAuth logins and auth files</p>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">OAuth Login</h3>
          </div>
          <div class="oauth-grid"><button class="oauth-btn" onclick="startOAuth('anthropic')"><span
                style="font-size:20px"></span>Anthropic</button><button class="oauth-btn"
              onclick="startOAuth('gemini-cli')"><span style="font-size:20px"></span>Gemini CLI</button><button
              class="oauth-btn" onclick="startOAuth('codex')"><span
                style="font-size:20px"></span>Codex</button><button class="oauth-btn"
              onclick="startOAuth('antigravity')"><span style="font-size:20px"></span>Antigravity</button><button
              class="oauth-btn" onclick="startOAuth('qwen')"><span style="font-size:20px"></span>Qwen</button><button
              class="oauth-btn" onclick="startOAuth('iflow')"><span style="font-size:20px"></span>IFlow</button></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Upload Auth File</h3>
          </div>
          <div id="uploadDropzone"
            style="border: 2px dashed var(--border-color); border-radius: var(--radius-md); padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;"
            onclick="document.getElementById('authFileInput').click()"
            ondragover="event.preventDefault(); this.style.borderColor='var(--accent-cyan)'; this.style.background='rgba(0,212,255,0.05)';"
            ondragleave="this.style.borderColor='var(--border-color)'; this.style.background='transparent';"
            ondrop="handleFileDrop(event)">
            <div style="font-size: 40px; margin-bottom: 12px;"></div>
            <p style="color: var(--text-secondary); margin-bottom: 8px;">Drop auth file here or click to upload</p>
            <p style="color: var(--text-muted); font-size: 12px;">Supports JSON auth files (claude.json, gemini.json,
              etc.)</p><input type="file" id="authFileInput" accept=".json" style="display:none"
              onchange="handleFileSelect(this.files[0])">
          </div>
          <div id="uploadStatus" style="margin-top: 12px; display: none;"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Auth Files</h3>
            <div style="display:flex;gap:8px"><button class="btn btn-secondary btn-sm"
                onclick="loadAuthFiles()">Refresh</button><button class="btn btn-danger btn-sm"
                onclick="deleteAllAuthFiles()">Delete All</button></div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Provider</th>
                  <th>Email / Filename</th>
                  <th>Project / Region</th>
                  <th>Last Refresh</th>
                  <th>Requests / Failed</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="authFilesTable">
                <tr>
                  <td colspan="7" class="empty-state">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="page-keys" class="page">
        <div class="keys-page-header">
          <div>
            <h1 class="page-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
              </svg>API Keys </h1>
            <p class="page-subtitle">Manage your access and provider API keys</p>
          </div>
        </div>
        <div class="keys-tabs">
          <div class="keys-tab active" data-keytab="access"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
            </svg>Access Keys </div>
          <div class="keys-tab" data-keytab="gemini"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>Gemini </div>
          <div class="keys-tab" data-keytab="claude"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M8 14s1.5 2 4 2 4-2 4-2" />
              <line x1="9" y1="9" x2="9.01" y2="9" />
              <line x1="15" y1="9" x2="15.01" y2="9" />
            </svg>Claude </div>
          <div class="keys-tab" data-keytab="codex"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6" />
              <polyline points="8 6 2 12 8 18" />
            </svg>Codex </div>
        </div>
        <div id="keytab-access" class="keys-content active">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Access API Keys</h3><span class="key-count" id="accessKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('access')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="accessKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-gemini" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Gemini API Keys</h3><span class="key-count" id="geminiKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('gemini')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="geminiKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-claude" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Claude API Keys</h3><span class="key-count" id="claudeKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('claude')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="claudeKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-codex" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Codex API Keys</h3><span class="key-count" id="codexKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('codex')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="codexKeysList" class="keys-grid"></div>
          </div>
        </div>
      </div>
      <div id="page-config" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
            <h1 class="page-title" style="margin:0">Configuration</h1>
          </div>
          <p class="page-subtitle">Manage server behavior and global settings</p>
        </div>
        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20h9" />
                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                </svg></div>
              <div class="config-section-title">
                <h3>General Settings</h3>
                <p>Core system toggles</p>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="23" x2="12" y2="10"></line>
                      <line x1="18" y1="20" x2="18" y2="4"></line>
                      <line x1="6" y1="20" x2="6" y2="16"></line>
                      <rect x="3" y="2" width="18" height="2" rx="1"></rect>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Debug Mode</h4>
                    <p>Enable verbose logging</p>
                  </div>
                </div><label class="toggle-enhanced"><input type="checkbox" id="toggleDebug"
                    onchange="toggleSetting('debug', this.checked)"><span class="toggle-enhanced-slider"></span></label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 20V10m-6 10V4M6 20v-6" />
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Usage Statistics</h4>
                    <p>Track request metrics</p>
                  </div>
                </div><label class="toggle-enhanced"><input type="checkbox" id="toggleUsageStats"
                    onchange="toggleSetting('usage-statistics-enabled', this.checked)"><span
                    class="toggle-enhanced-slider"></span></label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10 9 9 9 8 9"></polyline>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Logging to File</h4>
                    <p>Write logs to disk</p>
                  </div>
                </div><label class="toggle-enhanced"><input type="checkbox" id="toggleLogging"
                    onchange="toggleSetting('logging-to-file', this.checked)"><span
                    class="toggle-enhanced-slider"></span></label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="8" x2="12" y2="12"></line>
                      <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Request Log</h4>
                    <p>Log all request details</p>
                  </div>
                </div><label class="toggle-enhanced"><input type="checkbox" id="toggleRequestLog"
                    onchange="toggleSetting('request-log', this.checked)"><span
                    class="toggle-enhanced-slider"></span></label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1 10-10z"></path>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>WebSocket Auth</h4>
                    <p>Require auth for WS</p>
                  </div>
                </div><label class="toggle-enhanced"><input type="checkbox" id="toggleWsAuth"
                    onchange="toggleSetting('ws-auth', this.checked)"><span
                    class="toggle-enhanced-slider"></span></label>
              </div>
            </div>
          </div>
          <div class="config-editor-section">
            <div class="config-editor-header">
              <div class="config-editor-title">
                <div class="icon-box"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                  </svg></div>
                <div>
                  <h3>Advanced Configuration</h3>
                  <p>Edit full YAML configuration</p>
                </div>
              </div><button class="btn-save-config" onclick="saveConfig()"><svg xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>Save </button>
            </div>
            <div class="config-editor-content"><textarea id="configEditor" class="code-editor"
                placeholder="Loading config..." style="height: 100%; min-height: 480px;"></textarea></div>
          </div>
        </div>
      </div>
      <div id="page-usage" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <path d="M18 20V10m-6 10V4M6 20v-6" />
            </svg>
            <h1 class="page-title" style="margin:0">Usage Statistics</h1>
          </div>
          <p class="page-subtitle">Detailed request and usage analytics</p>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Overview</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="date-range-selector" style="display:flex;gap:4px;background:rgba(20,20,40,0.6);padding:4px;border-radius:8px">
                <button class="date-range-btn active" data-range="all" onclick="setUsageDateRange('all')">All</button>
                <button class="date-range-btn" data-range="30d" onclick="setUsageDateRange('30d')">30d</button>
                <button class="date-range-btn" data-range="7d" onclick="setUsageDateRange('7d')">7d</button>
                <button class="date-range-btn" data-range="today" onclick="setUsageDateRange('today')">Today</button>
              </div>
              <button class="btn btn-secondary btn-sm" onclick="exportUsageData()" title="Export usage data"
                style="display:flex;align-items:center;gap:6px"><svg xmlns="http://www.w3.org/2000/svg" width="14"
                  height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>Export</button>
              <button class="btn btn-secondary btn-sm" onclick="loadUsageStats()"
                style="display:flex;align-items:center;gap:6px"><svg xmlns="http://www.w3.org/2000/svg" width="14"
                  height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6" />
                  <path d="M1 20v-6h6" />
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                </svg>Refresh</button>
            </div>
          </div>
          <div class="stats-grid" style="margin-bottom:0">
            <div class="stat-card cyan">
              <div class="stat-value" id="usageTotalRequests">-</div>
              <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-card green">
              <div class="stat-value" id="usageSuccessful">-</div>
              <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card" style="--stat-color: var(--accent-red)">
              <div class="stat-value" style="color: var(--accent-red)" id="usageFailed">-</div>
              <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card purple">
              <div class="stat-value" id="usageSuccessRate">-</div>
              <div class="stat-label">Success Rate</div>
            </div>
          </div>
        </div>
        <div class="metrics-grid"
          style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px; margin-bottom:24px;">
          <div class="card"
            style="margin:0; background: linear-gradient(145deg, rgba(20, 20, 40, 0.6) 0%, rgba(10, 10, 25, 0.8) 100%);">
            <div class="card-header" style="border-bottom:none; padding-bottom:0">
              <div>
                <h3 class="card-title" style="font-size:15px; color:var(--text-secondary)">Request Trends</h3>
                <div class="stat-value" id="trendRequestTotal" style="font-size:24px; margin-top:4px">-</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="chart-view-toggle" style="display:flex;gap:2px;background:rgba(20,20,40,0.8);padding:3px;border-radius:6px">
                  <button class="chart-view-btn active" data-view="daily" onclick="setChartView('daily')">Daily</button>
                  <button class="chart-view-btn" data-view="hourly" onclick="setChartView('hourly')">Hourly</button>
                </div>
                <div style="padding:6px; background:rgba(0, 229, 255, 0.1); border-radius:8px; color:var(--accent-cyan)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                  <polyline points="17 18 23 18 23 12"></polyline>
                </svg>
              </div>
              </div>
            </div>
            <div style="height:240px; width:100%; position:relative; padding-top:16px">
              <canvas id="requestsChart"></canvas>
            </div>
          </div>

          <div class="card"
            style="margin:0; background: linear-gradient(145deg, rgba(20, 20, 40, 0.6) 0%, rgba(10, 10, 25, 0.8) 100%);">
            <div class="card-header" style="border-bottom:none; padding-bottom:0">
              <div>
                <h3 class="card-title" style="font-size:15px; color:var(--text-secondary)">Token Usage</h3>
                <div class="stat-value" id="trendTokenTotal" style="font-size:24px; margin-top:4px">-</div>
              </div>
              <div
                style="padding:6px; background:rgba(167, 139, 250, 0.1); border-radius:8px; color:var(--accent-purple)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path
                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                  </path>
                </svg>
              </div>
            </div>
            <div style="height:240px; width:100%; position:relative; padding-top:16px">
              <canvas id="tokensChart"></canvas>
            </div>
          </div>
        </div>
        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <circle cx="12" cy="14" r="4"></circle>
                </svg></div>
              <div class="config-section-title">
                <h3>Token Usage</h3>
                <p>Detailed token breakdown</p>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item" style="background:rgba(0,229,255,0.05);border-radius:8px;margin-bottom:8px">
                <div class="config-setting-info">
                  <div class="config-setting-icon" style="background:rgba(0,229,255,0.15)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                      <path d="M2 12l10 5 10-5"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4 style="color:var(--accent-cyan)">Total Tokens</h4>
                    <p>All tokens consumed</p>
                  </div>
                </div><span class="badge badge-cyan" style="font-size:14px;padding:6px 12px" id="usageTotalTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="13 17 18 12 13 7"></polyline>
                      <polyline points="6 17 11 12 6 7"></polyline>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Input Tokens</h4>
                    <p>Sent to AI providers</p>
                  </div>
                </div><span class="badge badge-cyan" id="usageInputTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="11 17 6 12 11 7"></polyline>
                      <polyline points="18 17 13 12 18 7"></polyline>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Output Tokens</h4>
                    <p>Received from AI providers</p>
                  </div>
                </div><span class="badge badge-purple" id="usageOutputTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Reasoning Tokens</h4>
                    <p>Used for chain-of-thought reasoning</p>
                  </div>
                </div><span class="badge badge-blue" id="usageReasoningTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                      </path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Cache Read</h4>
                    <p>Tokens served from cache</p>
                  </div>
                </div><span class="badge badge-green" id="usageCacheRead">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2v20M2 12h20"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Cache Write</h4>
                    <p>Tokens written to cache</p>
                  </div>
                </div><span class="badge badge-yellow" id="usageCacheWrite">-</span>
              </div>
            </div>
          </div>
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg></div>
              <div class="config-section-title">
                <h3>Provider Usage</h3>
                <p>Requests by provider/key</p>
              </div>
            </div>
            <div id="providerStats" style="max-height:300px;overflow-y:auto">
              <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:20px">
          <div class="card-header">
            <div class="keys-section-title">
              <h3>Model Usage</h3>
            </div>
          </div>
          <div id="modelStats" class="table-container">
            <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
          </div>
        </div>
      </div>
      <div id="page-analytics" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              style="color:var(--accent-red)">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
              <line x1="12" y1="9" x2="12" y2="13" />
              <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>
            <h1 class="page-title" style="margin:0">Failure Analytics</h1>
          </div>
          <p class="page-subtitle">Analyze failed requests to identify and fix issues</p>
        </div>

        <!-- Analytics Summary Cards -->
        <div class="stats-grid" style="margin-bottom:24px">
          <div class="stat-card" style="border-left:3px solid var(--accent-red)">
            <div class="stat-value" id="analyticsFailedTotal" style="color:var(--accent-red)">0</div>
            <div class="stat-label">Total Failed</div>
          </div>
          <div class="stat-card" style="border-left:3px solid var(--accent-yellow)">
            <div class="stat-value" id="analyticsFailedToday" style="color:var(--accent-yellow)">0</div>
            <div class="stat-label">Failed Today</div>
          </div>
          <div class="stat-card" style="border-left:3px solid var(--accent-cyan)">
            <div class="stat-value" id="analyticsSuccessRate" style="color:var(--accent-cyan)">100%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-card" style="border-left:3px solid var(--accent-purple)">
            <div class="stat-value" id="analyticsTopFailProvider" style="color:var(--accent-purple);font-size:16px">-
            </div>
            <div class="stat-label">Most Failed Provider</div>
          </div>
        </div>

        <!-- Filters and Controls -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Filters</h3>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-secondary btn-sm" onclick="loadAnalytics()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6"></path>
                  <path d="M1 20v-6h6"></path>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh
              </button>
              <button class="btn btn-danger btn-sm" onclick="exportAnalytics()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export CSV
              </button>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:16px;">
            <div class="form-group" style="margin:0">
              <label>Provider</label>
              <select id="analyticsProviderFilter" class="form-input" style="padding:10px" onchange="filterAnalytics()">
                <option value="">All Providers</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label>Model</label>
              <select id="analyticsModelFilter" class="form-input" style="padding:10px" onchange="filterAnalytics()">
                <option value="">All Models</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label>Time Range</label>
              <select id="analyticsTimeFilter" class="form-input" style="padding:10px" onchange="filterAnalytics()">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label>Search</label>
              <input type="text" id="analyticsSearchFilter" class="form-input" placeholder="Search..."
                oninput="filterAnalytics()">
            </div>
          </div>
        </div>

        <!-- Failure Breakdown Charts -->
        <div
          style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:20px">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Failures by Provider</h3>
            </div>
            <div id="failuresByProvider" style="min-height:150px">
              <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Failures by Model</h3>
            </div>
            <div id="failuresByModel" style="min-height:150px">
              <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Failed Requests Table -->
        <div class="card" style="margin-top:20px">
          <div class="card-header">
            <h3 class="card-title">Failed Request Log</h3>
            <span id="analyticsResultCount" style="color:var(--text-secondary);font-size:13px">0 failures</span>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Provider</th>
                  <th>Model</th>
                  <th>Source / User</th>
                  <th>Status</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="analyticsTable">
                <tr>
                  <td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px">Loading failure
                    data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="page-amp" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              style="color:var(--accent-cyan)">
              <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
              <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
              <line x1="6" y1="6" x2="6.01" y2="6"></line>
              <line x1="6" y1="18" x2="6.01" y2="18"></line>
            </svg>
            <h1>Amp Code Configuration</h1>
          </div>
        </div>
        <div class="amp-hero">
          <div class="amp-hero-content">
            <h2>Supercharge your Proxy</h2>
            <p>Connect to Amp Code upstream service to access premium models,
              fallback capabilities,
              and unified usage tracking. Enter your credentials below to get started.</p>
          </div><svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none"
            stroke="rgba(0, 229, 255, 0.1)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
            style="position:absolute;right:-20px;bottom:-20px;transform:rotate(-15deg)">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
          <div class="card">
            <div class="card-header">
              <div class="keys-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" style="color:var(--accent-green)">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="2" y1="12" x2="22" y2="12"></line>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                  </path>
                </svg>
                <h3>Upstream Connection</h3>
              </div>
            </div>
            <div class="form-group"><label>Upstream URL</label>
              <div class="input-with-icon"><input type="text" id="ampUpstreamUrl" class="form-input"
                  placeholder="https://api.ampcode.com"><svg class="input-icon" xmlns="http://www.w3.org/2000/svg"
                  width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg></div>
            </div>
            <div class="form-group"><label>Upstream API Key</label>
              <div class="input-with-icon"><input type="password" id="ampUpstreamKey" class="form-input"
                  placeholder=""><svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="24"
                  height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg></div>
            </div><button class="btn btn-save-amp" onclick="saveAmpSettings()"><svg xmlns="http://www.w3.org/2000/svg"
                width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>Save Connection </button>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="keys-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  style="color:var(--accent-blue)">
                  <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                  </path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <h3>Amp Settings</h3>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item" style="border-bottom: 1px solid var(--border-color)">
                <div class="config-setting-info">
                  <div class="config-setting-text">
                    <h4>Force Model Mappings</h4>
                    <p>Prioritize mappings over local keys</p>
                  </div>
                </div>
                <label class="toggle-enhanced">
                  <input type="checkbox" id="ampForce"
                    onchange="toggleAmpSetting('force-model-mappings', this.checked)">
                  <span class="toggle-enhanced-slider"></span>
                </label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-text">
                    <h4>Restrict Management</h4>
                    <p>Only allow localhost for management</p>
                  </div>
                </div>
                <label class="toggle-enhanced">
                  <input type="checkbox" id="ampRestrict"
                    onchange="toggleAmpSetting('restrict-management-to-localhost', this.checked)">
                  <span class="toggle-enhanced-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Removed extra div closures here to keep next card inside page-amp -->

        <!-- Full width mappings section -->
        <div class="card" style="margin-top:24px">
          <div class="card-header">
            <div class="keys-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="color:var(--accent-purple)">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" y1="20" x2="21" y2="3"></line>
              </svg>
              <h3>Model Mappings</h3>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:32px; align-items:start">

            <!-- Section 1: Mappings List -->
            <div>
              <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border-color)">
                <h4 style="font-size:14px; color:var(--text-secondary); font-weight:600">Active Mappings (<span
                    id="mappingCount">0</span>)</h4>
                <button class="btn btn-secondary btn-sm" onclick="openAddMappingModal()">
                  <span style="margin-right:4px">+</span> Add Mapping
                </button>
              </div>
              <div id="modelMappings" class="mappings-list"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:12px"></div>
            </div>

            <!-- Section 2: Combos -->
            <div class="combos-panel"
              style="background: linear-gradient(145deg, rgba(20, 20, 40, 0.4) 0%, rgba(30, 30, 60, 0.4) 100%); border:1px solid var(--border-color); border-radius:var(--radius-lg); padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1)">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                <div style="display:flex; align-items:center; gap:8px">
                  <div
                    style="width:32px; height:32px; background:rgba(167, 139, 250, 0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--accent-purple)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2"><img width="0" height="0" />
                      <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                  </div>
                  <div>
                    <h4 style="font-size:15px; color:var(--text-primary); font-weight:600; margin:0">Quick Combos</h4>
                    <p style="font-size:11px; color:var(--text-secondary); margin:0">Switch configurations instantly</p>
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm" style="font-size:12px" onclick="openManageCombosModal()">Manage
                  All</button>
              </div>

              <div id="combosSidePanel"
                style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto">
                <!-- Combos rendered here -->
                <div
                  style="padding:24px; text-align:center; color:var(--text-secondary); font-size:13px; border:1px dashed var(--border-color); border-radius:8px; background:rgba(0,0,0,0.1)">
                  No combos created yet.<br>
                  <a href="javascript:void(0)" onclick="openAddComboModal()"
                    style="color:var(--accent-cyan); text-decoration:none; display:inline-block; margin-top:4px">Create
                    your first combo</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- Close page-amp -->

      <div id="page-logs" class="page">
        <div class="page-header">
          <div class="page-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              style="color:var(--text-secondary); margin-right:12px">
              <polyline points="4 17 10 11 4 5"></polyline>
              <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            System Logs
          </div>
          <p class="page-subtitle">Monitor server activity and debug issues in real-time</p>
        </div>

        <div class="log-controls">
          <div class="log-search-container">
            <svg class="log-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" class="log-search-input" id="logSearch" placeholder="Search logs (regex supported)..."
              oninput="filterLogs()">
          </div>

          <div class="log-filter-group">
            <button class="log-filter-btn active" onclick="setLogFilter('ALL')" id="filter-ALL">ALL</button>
            <button class="log-filter-btn filter-debug" onclick="setLogFilter('DEBUG')" id="filter-DEBUG">DEBUG</button>
            <button class="log-filter-btn filter-info" onclick="setLogFilter('INFO')" id="filter-INFO">INFO</button>
            <button class="log-filter-btn filter-warn" onclick="setLogFilter('WARN')" id="filter-WARN">WARN</button>
            <button class="log-filter-btn filter-error" onclick="setLogFilter('ERROR')" id="filter-ERROR">ERROR</button>
          </div>

          <div style="height:24px; width:1px; background:var(--border-color); margin:0 8px;"></div>

          <div style="display:flex; align-items:center; gap:8px; margin-right:8px">
            <label class="toggle-enhanced">
              <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh(this.checked)">
              <span class="toggle-enhanced-slider"></span>
            </label>
            <span style="font-size:12px; color:var(--text-secondary)">Live</span>
          </div>

          <button class="btn btn-secondary btn-sm" onclick="loadLogs()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Refresh
          </button>
          <button class="btn btn-secondary btn-sm" onclick="exportLogs()" title="Download logs as text file">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
          <button class="btn btn-secondary btn-sm" onclick="jumpToNextError()" title="Jump to errors">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Errors
          </button>
          <button class="btn btn-danger btn-sm" onclick="clearLogs()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear
          </button>
        </div>

        <div class="terminal-window">
          <div class="terminal-header">
            <div class="terminal-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
              </svg>
              cliproxy-server  /var/log/syslog
            </div>
            <div class="terminal-status">
              <span id="logCount" style="color:var(--text-secondary);margin-right:8px">0 lines</span>
              <button onclick="scrollLogsToBottom()" title="Scroll to bottom"
                style="background:none; border:none; cursor:pointer; padding:2px 6px; color:var(--text-secondary); margin-right:8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="7 13 12 18 17 13"></polyline>
                  <polyline points="7 6 12 11 17 6"></polyline>
                </svg>
              </button>
              <div id="liveStatusDot" class="status-dot"></div>
              <span id="liveStatusText" style="color:var(--text-muted)">Offline</span>
            </div>
          </div>
          <div id="logViewer" class="log-viewer-content">
            <div class="empty-logs">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <p>Waiting for logs...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()">&times;
        </button>
      </div>
      <div id="modalContent"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>
  <div id="toastContainer" class="toast-container"></div>
  <script>let apiKey = localStorage.getItem('managementKey') || '';

    let serverInfo = {}

      ;

    async function api(method, endpoint, body = null) {
      const opts = {
        method,
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        }
      };
      if (body) opts.body = typeof body === 'string' ? body : JSON.stringify(body);
      const res = await fetch(`/v0/management${endpoint}`, opts);
      if (!res.ok) throw new Error(await res.text() || `HTTP ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    function toast(msg, type = 'info') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    async function login() {
      const key = document.getElementById('loginKey').value;
      if (!key) return;
      apiKey = key;

      try {
        await api('GET', '/config');
        localStorage.setItem('managementKey', key);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').classList.add('active');
        loadDashboard();
        toast('Successfully authenticated', 'success');
      }

      catch (e) {
        document.getElementById('loginError').textContent = 'Invalid management key';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('managementKey');
      location.reload();
    }

    async function checkAuth() {
      if (apiKey) {
        try {
          await api('GET', '/config');
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('app').classList.add('active');
          loadDashboard();
        }

        catch {
          localStorage.removeItem('managementKey');
          apiKey = '';
        }
      }
    }

    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');

        // Stop log auto-refresh when navigating away from logs tab
        if (page !== 'logs') {
          stopLogAutoRefresh();
        }

        if (page === 'dashboard') loadDashboard();
        if (page === 'models') loadModels();
        if (page === 'auth') loadAuthFiles();
        if (page === 'keys') loadKeys();
        if (page === 'config') loadConfig();
        if (page === 'usage') loadUsageStats();
        if (page === 'analytics') loadAnalytics();
        if (page === 'amp') loadAmpSettings();
        if (page === 'logs') loadLogs();
      });
    });

    function navigateTo(page) {
      const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
      if (navItem) navItem.click();
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // API Keys tabs handler
    document.querySelectorAll('.keys-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.keys-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.keys-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`keytab-${tab.dataset.keytab}`).classList.add('active');
      });
    });

    async function loadDashboard() {
      try {

        // Fetch config with full response to get headers
        const configRes = await fetch('/v0/management/config', {
          headers: {
            'Authorization': `Bearer ${apiKey
              }

            `, 'Content-Type': 'application/json'
          }
        });
        const version = configRes.headers.get('X-CPA-VERSION') || '-';
        const commit = configRes.headers.get('X-CPA-COMMIT') || '-';
        const buildDate = configRes.headers.get('X-CPA-BUILD-DATE') || '-';
        const config = await configRes.json();
        serverInfo = config;
        accessApiKeys = config['api-keys'] || config.api_keys || [];

        // Fetch usage
        const usage = await api('GET', '/usage').catch(() => ({
          usage: {}
        }));

        document.getElementById('statRequests').textContent = (usage.usage?.total_requests || 0).toLocaleString();
        const total = usage.usage?.total_requests || 0,
          failed = usage.usage?.failed_requests || usage.failed_requests || 0;
        document.getElementById('statSuccess').textContent = (total > 0 ? ((total - failed) / total * 100).toFixed(1) : '100') + '%';

        document.getElementById('serverVersion').textContent = `Version: ${version
          }

    | Commit: ${commit.slice(0, 7)
          }

    `;
        document.getElementById('versionBadge').textContent = version;
        document.getElementById('buildDate').textContent = buildDate;

        // Load auth files count
        api('GET', '/auth-files').then(d => document.getElementById('statAuthFiles').textContent = (d.files || []).length).catch(() => { });

        // Load models count
        fetchModels().then(models => {
          document.getElementById('statModels').textContent = models.length;
          allModels = models;
        }).catch(() => document.getElementById('statModels').textContent = '-');
      }

      catch (e) {
        toast('Failed to load dashboard: ' + e.message, 'error');
      }
    }

    let allModels = [];
    let accessApiKeys = [];

    async function fetchModels() {

      // Try with management key first
      let res = await fetch('/v1/models', {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (res.ok) {
        const data = await res.json();
        return data.data || data.models || [];
      }

      // Try with access keys from config
      if (accessApiKeys.length > 0) {
        for (const key of accessApiKeys) {
          res = await fetch('/v1/models', {
            headers: {
              'Authorization': `Bearer ${key}`
            }
          });

          if (res.ok) {
            const data = await res.json();
            return data.data || data.models || [];
          }
        }
      }

      // Try without auth
      res = await fetch('/v1/models');

      if (res.ok) {
        const data = await res.json();
        return data.data || data.models || [];
      }

      throw new Error('API authentication required');
    }

    async function loadModels() {
      try {

        // First try to get access keys from config
        const cfg = await api('GET', '/config').catch(() => ({}));
        accessApiKeys = cfg['api-keys'] || cfg.api_keys || [];
        const models = await fetchModels();
        allModels = models;
        renderModels(models);
      }

      catch (e) {
        document.getElementById('modelsContainer').innerHTML = ` <div style="text-align:center;padding:24px"><p style="color:var(--accent-yellow);margin-bottom:12px"> Could not load models</p><p style="color:var(--text-secondary);font-size:13px">The /v1/models endpoint requires API authentication.</p><p style="color:var(--text-secondary);font-size:13px;margin-top:8px">Add access keys in the <strong>API Keys</strong>tab or check your auth files.</p></div>`;
      }
    }

    function renderModels(models) {
      const container = document.getElementById('modelsContainer');

      if (!models.length) {
        container.innerHTML = '<p style="color:var(--text-secondary)">No models available</p>';
        return;
      }

      // Group by provider/owner
      const grouped = {}

        ;

      models.forEach(m => {
        const id = m.id || m.name || 'unknown';
        const owner = m.owned_by || m.provider || 'other';
        if (!grouped[owner]) grouped[owner] = [];
        grouped[owner].push(id);
      });

      container.innerHTML = Object.entries(grouped).map(([owner, modelList]) => ` <div style="margin-bottom:20px" > <h4 style="color:var(--accent-cyan);margin-bottom:12px;text-transform:capitalize" >${owner
        } (${modelList.length
        })</h4> <div style="display:flex;flex-wrap:wrap;gap:8px" > ${modelList.map(id => `<span class="badge badge-purple" style="cursor:pointer" onclick="copyToClipboard('${id}')" title="Click to copy">${id}</span>`).join('')
        } </div> </div> `).join('');
    }

    function filterModels() {
      const search = document.getElementById('modelSearch').value.toLowerCase();

      if (!search) {
        renderModels(allModels);
        return;
      }

      const filtered = allModels.filter(m => {
        const id = (m.id || m.name || '').toLowerCase();
        const owner = (m.owned_by || m.provider || '').toLowerCase();
        return id.includes(search) || owner.includes(search);
      });
      renderModels(filtered);
    }

    async function checkLatestVersion() {
      try {
        const d = await api('GET', '/latest-version');
        document.getElementById('latestVersion').textContent = d['latest-version'] || '-';
        toast('Version check complete', 'success');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function loadUsageStats() {
      try {
        const d = await api('GET', '/usage');

        const u = d.usage || {}

          ;

        // Top level stats
        const total = u.total_requests || 0;
        const success = u.success_count || 0;
        const failed = u.failure_count || 0;
        const rate = total > 0 ? ((success / total) * 100).toFixed(1) : '100';

        document.getElementById('usageTotalRequests').textContent = total.toLocaleString();
        document.getElementById('usageSuccessful').textContent = success.toLocaleString();
        document.getElementById('usageFailed').textContent = failed.toLocaleString();
        document.getElementById('usageSuccessRate').textContent = rate + '%';

        // Deep aggregation
        let totalInput = 0;
        let totalOutput = 0;
        let totalReasoning = 0;
        let totalCacheRead = 0;
        let totalCacheWrite = 0;

        const providerUsage = {}

          ;

        const modelUsage = {}

          ;

        const apis = u.apis || {}

          ;

        for (const [apiKey, apiStats] of Object.entries(apis)) {
          // Provider stats
          const pKey = apiKey || 'unknown';

          if (!providerUsage[pKey]) providerUsage[pKey] = {
            requests: 0, tokens: 0
          }

            ;
          providerUsage[pKey].requests += (apiStats.total_requests || 0);
          providerUsage[pKey].tokens += (apiStats.total_tokens || 0);

          // Models inside this API
          const models = apiStats.models || {}

            ;

          for (const [modelName, modelStats] of Object.entries(models)) {
            if (!modelUsage[modelName]) modelUsage[modelName] = {
              requests: 0, tokens: 0
            }

              ;
            modelUsage[modelName].requests += (modelStats.total_requests || 0);
            modelUsage[modelName].tokens += (modelStats.total_tokens || 0);

            // Details for token breakdown
            const details = modelStats.details || [];

            for (const detail of details) {
              const t = detail.tokens || {}

                ;
              totalInput += (t.input_tokens || 0);
              totalOutput += (t.output_tokens || 0);
              totalReasoning += (t.reasoning_tokens || 0);
              totalCacheRead += (t.cached_tokens || 0);
            }
          }
        }

        document.getElementById('usageTotalTokens').textContent = (totalInput + totalOutput + totalReasoning).toLocaleString();
        document.getElementById('usageInputTokens').textContent = totalInput.toLocaleString();
        document.getElementById('usageOutputTokens').textContent = totalOutput.toLocaleString();
        document.getElementById('usageReasoningTokens').textContent = totalReasoning.toLocaleString();
        document.getElementById('usageCacheRead').textContent = totalCacheRead.toLocaleString();
        document.getElementById('usageCacheWrite').textContent = totalCacheWrite > 0 ? totalCacheWrite.toLocaleString() : '-';

        // Render Providers
        const providerContainer = document.getElementById('providerStats');
        const pEntries = Object.entries(providerUsage).sort((a, b) => b[1].requests - a[1].requests);

        if (pEntries.length === 0) {
          providerContainer.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-secondary)">No data available</div>';
        }

        else {
          providerContainer.innerHTML = '<div class="config-settings-list">' + pEntries.map(([name, stats]) => ` <div class="config-setting-item" style="padding:12px 24px" > <div class="config-setting-info" > <div class="config-setting-text" > <h4 style="font-family:monospace;font-size:13px" title="${name}">${name.length > 25 ? name.slice(0, 22) + '...' : name
            }</h4> <p>${stats.tokens.toLocaleString()
            } tokens</p> </div> </div> <span class="badge badge-purple" >${stats.requests
            }</span> </div> `).join('') + '</div>';
        }

        // Render Models
        const modelContainer = document.getElementById('modelStats');
        const mEntries = Object.entries(modelUsage).sort((a, b) => b[1].requests - a[1].requests);

        if (mEntries.length === 0) {
          modelContainer.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-secondary)">No data available</div>';
        }

        else {
          modelContainer.innerHTML = ` <table><thead><tr><th>Model Name</th><th>Requests</th><th>Total Tokens</th></tr></thead><tbody>${mEntries.map(([name, stats]) => ` <tr> <td><span style="color:var(--accent-cyan);font-weight:500" >${name
            }</span></td> <td>${stats.requests.toLocaleString()
            }</td> <td style="font-family:monospace" >${stats.tokens.toLocaleString()
            }</td> </tr> `).join('')
            }</tbody></table>`;
        }

        renderUsageCharts(u);
        usageState.rawData = u;

      }

      catch (e) {
        toast('Failed to load usage stats: ' + e.message, 'error');
        console.error(e);
      }
    }

    let requestsChartInstance = null;
    let tokensChartInstance = null;

    function renderUsageCharts(usageData) {
      const reqData = usageData.requests_by_day || {};
      const tokData = usageData.tokens_by_day || {};

      const dates = [...new Set([...Object.keys(reqData), ...Object.keys(tokData)])].sort();

      const reqValues = dates.map(d => reqData[d] || 0);
      const tokValues = dates.map(d => tokData[d] || 0);

      // Update totals in UI headers
      const totalReq = reqValues.reduce((a, b) => a + b, 0);
      const totalTok = tokValues.reduce((a, b) => a + b, 0);
      if (document.getElementById('trendRequestTotal'))
        document.getElementById('trendRequestTotal').innerText = totalReq.toLocaleString();
      if (document.getElementById('trendTokenTotal'))
        document.getElementById('trendTokenTotal').innerText = (totalTok < 1000000 ? (totalTok / 1000).toFixed(1) + 'k' : (totalTok / 1000000).toFixed(2) + 'M');

      // Chart styling
      Chart.defaults.color = '#8888aa';
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';

      const ctxReq = document.getElementById('requestsChart').getContext('2d');
      const gradReq = ctxReq.createLinearGradient(0, 0, 0, 240);
      gradReq.addColorStop(0, 'rgba(0, 229, 255, 0.2)');
      gradReq.addColorStop(1, 'rgba(0, 229, 255, 0)');

      if (requestsChartInstance) requestsChartInstance.destroy();
      requestsChartInstance = new Chart(ctxReq, {
        type: 'line',
        data: {
          labels: dates.map(d => d.slice(5)), // Show MM-DD
          datasets: [{
            label: 'Requests',
            data: reqValues,
            borderColor: '#00e5ff',
            backgroundColor: gradReq,
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointBackgroundColor: '#0d0d1a',
            pointBorderColor: '#00e5ff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(20, 20, 35, 0.9)', titleColor: '#fff', bodyColor: '#ccc', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, border: { display: false } }
          }
        }
      });

      const ctxTok = document.getElementById('tokensChart').getContext('2d');
      // Bar gradient
      const gradTok = ctxTok.createLinearGradient(0, 0, 0, 240);
      gradTok.addColorStop(0, '#a78bfa');
      gradTok.addColorStop(1, 'rgba(167, 139, 250, 0.1)');

      if (tokensChartInstance) tokensChartInstance.destroy();
      tokensChartInstance = new Chart(ctxTok, {
        type: 'bar',
        data: {
          labels: dates.map(d => d.slice(5)),
          datasets: [{
            label: 'Tokens',
            data: tokValues,
            backgroundColor: gradTok,
            borderRadius: 4,
            borderSkipped: false,
            barThickness: 'flex',
            maxBarThickness: 30,
            hoverBackgroundColor: '#8b5cf6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(20, 20, 35, 0.9)', borderWidth: 1, borderColor: 'rgba(255,255,255,0.1)' } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, border: { display: false }, ticks: { callback: function (value) { return value >= 1000 ? (value / 1000).toFixed(0) + 'k' : value; } } }
          }
        }
      });
    }

    // Usage stats state
    let usageState = {
      dateRange: 'all',
      chartView: 'daily',
      rawData: null
    };

    function setUsageDateRange(range) {
      usageState.dateRange = range;
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
      });
      if (usageState.rawData) {
        renderFilteredUsageData(usageState.rawData);
      }
    }

    function setChartView(view) {
      usageState.chartView = view;
      document.querySelectorAll('.chart-view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      if (usageState.rawData) {
        renderUsageChartsWithView(usageState.rawData);
      }
    }

    function filterDataByDateRange(data, range) {
      if (range === 'all') return data;
      
      const now = new Date();
      let cutoff;
      
      if (range === 'today') {
        cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      } else if (range === '7d') {
        cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else if (range === '30d') {
        cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      }
      
      const filtered = {};
      for (const [key, value] of Object.entries(data)) {
        const date = new Date(key);
        if (date >= cutoff) {
          filtered[key] = value;
        }
      }
      return filtered;
    }

    function renderFilteredUsageData(usageData) {
      const range = usageState.dateRange;
      
      // Filter requests_by_day and tokens_by_day
      const reqByDay = filterDataByDateRange(usageData.requests_by_day || {}, range);
      const tokByDay = filterDataByDateRange(usageData.tokens_by_day || {}, range);
      
      // Recalculate totals based on filtered data
      const filteredReqTotal = Object.values(reqByDay).reduce((a, b) => a + b, 0);
      const filteredTokTotal = Object.values(tokByDay).reduce((a, b) => a + b, 0);
      
      // Update trend displays
      if (document.getElementById('trendRequestTotal'))
        document.getElementById('trendRequestTotal').innerText = filteredReqTotal.toLocaleString();
      if (document.getElementById('trendTokenTotal'))
        document.getElementById('trendTokenTotal').innerText = (filteredTokTotal < 1000000 ? (filteredTokTotal / 1000).toFixed(1) + 'k' : (filteredTokTotal / 1000000).toFixed(2) + 'M');
      
      renderUsageChartsWithView(usageData);
    }

    function renderUsageChartsWithView(usageData) {
      const view = usageState.chartView;
      const range = usageState.dateRange;
      
      let reqData, tokData, labelFormatter;
      
      if (view === 'hourly') {
        reqData = usageData.requests_by_hour || {};
        tokData = usageData.tokens_by_hour || {};
        labelFormatter = (h) => `${h}:00`;
      } else {
        reqData = filterDataByDateRange(usageData.requests_by_day || {}, range);
        tokData = filterDataByDateRange(usageData.tokens_by_day || {}, range);
        labelFormatter = (d) => d.slice(5);
      }
      
      const keys = [...new Set([...Object.keys(reqData), ...Object.keys(tokData)])].sort();
      const reqValues = keys.map(k => reqData[k] || 0);
      const tokValues = keys.map(k => tokData[k] || 0);
      
      // Chart styling
      Chart.defaults.color = '#8888aa';
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';
      
      const ctxReq = document.getElementById('requestsChart').getContext('2d');
      const gradReq = ctxReq.createLinearGradient(0, 0, 0, 240);
      gradReq.addColorStop(0, 'rgba(0, 229, 255, 0.2)');
      gradReq.addColorStop(1, 'rgba(0, 229, 255, 0)');
      
      if (requestsChartInstance) requestsChartInstance.destroy();
      requestsChartInstance = new Chart(ctxReq, {
        type: 'line',
        data: {
          labels: keys.map(labelFormatter),
          datasets: [{
            label: 'Requests',
            data: reqValues,
            borderColor: '#00e5ff',
            backgroundColor: gradReq,
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointBackgroundColor: '#0d0d1a',
            pointBorderColor: '#00e5ff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(20, 20, 35, 0.9)', titleColor: '#fff', bodyColor: '#ccc', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, border: { display: false } }
          }
        }
      });
      
      const ctxTok = document.getElementById('tokensChart').getContext('2d');
      const gradTok = ctxTok.createLinearGradient(0, 0, 0, 240);
      gradTok.addColorStop(0, '#a78bfa');
      gradTok.addColorStop(1, 'rgba(167, 139, 250, 0.1)');
      
      if (tokensChartInstance) tokensChartInstance.destroy();
      tokensChartInstance = new Chart(ctxTok, {
        type: 'bar',
        data: {
          labels: keys.map(labelFormatter),
          datasets: [{
            label: 'Tokens',
            data: tokValues,
            backgroundColor: gradTok,
            borderRadius: 4,
            borderSkipped: false,
            barThickness: 'flex',
            maxBarThickness: 30,
            hoverBackgroundColor: '#8b5cf6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(20, 20, 35, 0.9)', borderWidth: 1, borderColor: 'rgba(255,255,255,0.1)' } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, border: { display: false }, ticks: { callback: function (value) { return value >= 1000 ? (value / 1000).toFixed(0) + 'k' : value; } } }
          }
        }
      });
    }

    function exportUsageData() {
      if (!usageState.rawData) {
        toast('No usage data available to export', 'info');
        return;
      }
      
      const data = usageState.rawData;
      const exportObj = {
        exported_at: new Date().toISOString(),
        summary: {
          total_requests: data.total_requests || 0,
          success_count: data.success_count || 0,
          failure_count: data.failure_count || 0,
          total_tokens: data.total_tokens || 0
        },
        requests_by_day: data.requests_by_day || {},
        tokens_by_day: data.tokens_by_day || {},
        apis: data.apis || {}
      };
      
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cliproxy-usage-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Usage data exported successfully', 'success');
    }

    // Analytics page state
    let analyticsData = { failures: [], allFailures: [] };

    async function loadAnalytics() {
      try {
        const d = await api('GET', '/usage');
        const u = d.usage || {};
        const apis = u.apis || {};

        // Collect all failed requests
        const failures = [];
        const providerFailures = {};
        const modelFailures = {};
        const providers = new Set();
        const models = new Set();

        const total = u.total_requests || 0;
        const failed = u.failure_count || 0;
        const today = new Date().toISOString().split('T')[0];
        let failedToday = 0;

        for (const [apiKey, apiStats] of Object.entries(apis)) {
          const modelsData = apiStats.models || {};

          for (const [modelName, modelStats] of Object.entries(modelsData)) {
            const details = modelStats.details || [];

            for (const detail of details) {
              models.add(modelName);

              // Determine provider from source or apiKey
              const provider = detail.source || apiKey || 'unknown';
              providers.add(provider);

              if (detail.failed) {
                const timestamp = detail.timestamp || new Date().toISOString();
                const dateOnly = timestamp.split('T')[0];

                failures.push({
                  timestamp,
                  provider,
                  model: modelName,
                  source: detail.source || '-',
                  authIndex: detail.auth_index,
                  tokens: detail.tokens || {},
                  errorCode: detail.error_code || '',
                  errorMessage: detail.error_message || '',
                  httpStatus: detail.http_status || 0
                });

                // Count by provider
                providerFailures[provider] = (providerFailures[provider] || 0) + 1;
                // Count by model
                modelFailures[modelName] = (modelFailures[modelName] || 0) + 1;

                // Count today's failures
                if (dateOnly === today) {
                  failedToday++;
                }
              }
            }
          }
        }

        // Sort failures by timestamp descending (most recent first)
        failures.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // Store for filtering
        analyticsData.failures = failures;
        analyticsData.allFailures = failures;

        // Update summary cards
        document.getElementById('analyticsFailedTotal').textContent = failed.toLocaleString();
        document.getElementById('analyticsFailedToday').textContent = failedToday.toLocaleString();
        const successRate = total > 0 ? (((total - failed) / total) * 100).toFixed(1) : '100';
        document.getElementById('analyticsSuccessRate').textContent = successRate + '%';

        // Find top failed provider
        const topProvider = Object.entries(providerFailures).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('analyticsTopFailProvider').textContent = topProvider ?
          (topProvider[0].length > 15 ? topProvider[0].slice(0, 12) + '...' : topProvider[0]) : '-';

        // Populate filter dropdowns
        const providerSelect = document.getElementById('analyticsProviderFilter');
        providerSelect.innerHTML = '<option value="">All Providers</option>' +
          [...providers].sort().map(p => `<option value="${p}">${p.length > 30 ? p.slice(0, 27) + '...' : p}</option>`).join('');

        const modelSelect = document.getElementById('analyticsModelFilter');
        modelSelect.innerHTML = '<option value="">All Models</option>' +
          [...models].sort().map(m => `<option value="${m}">${m}</option>`).join('');

        // Render failure breakdown by provider
        renderFailureBreakdown('failuresByProvider', providerFailures, 'No provider failures');

        // Render failure breakdown by model
        renderFailureBreakdown('failuresByModel', modelFailures, 'No model failures');

        // Render table
        renderAnalyticsTable(failures);

      } catch (e) {
        toast('Failed to load analytics: ' + e.message, 'error');
        console.error(e);
      }
    }

    function renderFailureBreakdown(containerId, data, emptyMessage) {
      const container = document.getElementById(containerId);
      const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);

      if (entries.length === 0) {
        container.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-secondary)">${emptyMessage}</div>`;
        return;
      }

      const maxVal = entries[0][1];
      container.innerHTML = entries.slice(0, 8).map(([name, count]) => {
        const pct = maxVal > 0 ? (count / maxVal * 100) : 0;
        const displayName = name.length > 25 ? name.slice(0, 22) + '...' : name;
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-color)">
            <span style="flex:0 0 120px;font-size:12px;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${name}">${displayName}</span>
            <div style="flex:1;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden">
              <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--accent-red),var(--accent-yellow));border-radius:4px"></div>
            </div>
            <span class="badge badge-red" style="min-width:40px;text-align:center">${count}</span>
          </div>
        `;
      }).join('');
    }

    function renderAnalyticsTable(failures) {
      const tbody = document.getElementById('analyticsTable');
      document.getElementById('analyticsResultCount').textContent = `${failures.length} failure${failures.length !== 1 ? 's' : ''}`;

      if (failures.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:40px">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--accent-green);margin-bottom:12px">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg><br>
          No failed requests found!
        </td></tr>`;
        return;
      }

      tbody.innerHTML = failures.slice(0, 100).map(f => {
        const ts = new Date(f.timestamp);
        const timeStr = isNaN(ts) ? f.timestamp : ts.toLocaleString();
        const shortSource = f.source.length > 25 ? f.source.slice(0, 22) + '...' : f.source;

        // Determine status badge color based on HTTP status
        let statusBadge = '<span class="badge badge-red">Error</span>';
        if (f.httpStatus) {
          const badgeClass = f.httpStatus >= 500 ? 'badge-red' : f.httpStatus >= 400 ? 'badge-yellow' : 'badge-cyan';
          statusBadge = `<span class="badge ${badgeClass}">${f.httpStatus}</span>`;
        } else if (f.errorCode) {
          statusBadge = `<span class="badge badge-red" title="${f.errorCode}">${f.errorCode.slice(0, 10)}</span>`;
        }

        return `<tr>
          <td style="font-size:12px;color:var(--text-secondary)">${timeStr}</td>
          <td><span class="badge badge-purple">${f.provider.length > 15 ? f.provider.slice(0, 12) + '...' : f.provider}</span></td>
          <td><span style="color:var(--accent-cyan);font-weight:500">${f.model}</span></td>
          <td title="${f.source}" style="font-size:12px">${shortSource}</td>
          <td>${statusBadge}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="showFailureDetails(${JSON.stringify(f).replace(/"/g, '&quot;')})" title="View Details"></button>
          </td>
        </tr>`;
      }).join('');

      if (failures.length > 100) {
        tbody.innerHTML += `<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:16px">
          Showing first 100 of ${failures.length} failures. Use filters to narrow down results.
        </td></tr>`;
      }
    }

    function filterAnalytics() {
      const provider = document.getElementById('analyticsProviderFilter').value;
      const model = document.getElementById('analyticsModelFilter').value;
      const timeRange = document.getElementById('analyticsTimeFilter').value;
      const search = document.getElementById('analyticsSearchFilter').value.toLowerCase();

      let filtered = [...analyticsData.allFailures];

      // Filter by provider
      if (provider) {
        filtered = filtered.filter(f => f.provider === provider);
      }

      // Filter by model
      if (model) {
        filtered = filtered.filter(f => f.model === model);
      }

      // Filter by time range
      if (timeRange !== 'all') {
        const now = new Date();
        let cutoff;
        if (timeRange === 'today') {
          cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        } else if (timeRange === 'week') {
          cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (timeRange === 'month') {
          cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        if (cutoff) {
          filtered = filtered.filter(f => new Date(f.timestamp) >= cutoff);
        }
      }

      // Filter by search term
      if (search) {
        filtered = filtered.filter(f =>
          f.provider.toLowerCase().includes(search) ||
          f.model.toLowerCase().includes(search) ||
          f.source.toLowerCase().includes(search)
        );
      }

      analyticsData.failures = filtered;
      renderAnalyticsTable(filtered);
    }

    function showFailureDetails(failure) {
      document.getElementById('modalTitle').textContent = 'Failure Details';

      // Build error section HTML
      let errorSection = '';
      if (failure.httpStatus || failure.errorCode || failure.errorMessage) {
        errorSection = `
          <div style="background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:8px;padding:16px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span style="font-weight:600;color:var(--accent-red)">Error Response</span>
            </div>
            ${failure.httpStatus ? `
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span style="color:var(--text-secondary);font-size:12px;min-width:100px">HTTP Status:</span>
                <span class="badge ${failure.httpStatus >= 500 ? 'badge-red' : failure.httpStatus >= 400 ? 'badge-yellow' : 'badge-green'}">${failure.httpStatus}</span>
              </div>
            ` : ''}
            ${failure.errorCode ? `
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span style="color:var(--text-secondary);font-size:12px;min-width:100px">Error Code:</span>
                <code style="background:rgba(0,0,0,0.3);padding:4px 8px;border-radius:4px;font-size:12px">${failure.errorCode}</code>
              </div>
            ` : ''}
            ${failure.errorMessage ? `
              <div style="margin-top:12px">
                <span style="color:var(--text-secondary);font-size:12px;display:block;margin-bottom:8px">Error Message:</span>
                <pre style="background:rgba(0,0,0,0.4);padding:12px;border-radius:8px;overflow-x:auto;font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto;margin:0;color:var(--accent-red)">${failure.errorMessage}</pre>
              </div>
            ` : ''}
          </div>
        `;
      } else {
        errorSection = `
          <div style="background:rgba(136,136,170,0.1);border:1px solid rgba(136,136,170,0.3);border-radius:8px;padding:16px;margin-bottom:16px;text-align:center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin-bottom:8px">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <p style="color:var(--text-muted);font-size:13px;margin:0">No detailed error information captured.<br>Error details will appear here for future failures.</p>
          </div>
        `;
      }

      document.getElementById('modalContent').innerHTML = `
        <div style="display:grid;gap:16px">
          ${errorSection}
          <div class="form-group" style="margin:0">
            <label style="color:var(--text-secondary);font-size:12px">Timestamp</label>
            <div style="font-family:monospace;font-size:14px">${new Date(failure.timestamp).toLocaleString()}</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group" style="margin:0">
              <label style="color:var(--text-secondary);font-size:12px">Provider</label>
              <div><span class="badge badge-purple">${failure.provider}</span></div>
            </div>
            <div class="form-group" style="margin:0">
              <label style="color:var(--text-secondary);font-size:12px">Model</label>
              <div style="color:var(--accent-cyan);font-weight:500">${failure.model}</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="form-group" style="margin:0">
              <label style="color:var(--text-secondary);font-size:12px">Source / User</label>
              <div style="font-size:13px;word-break:break-all">${failure.source}</div>
            </div>
            <div class="form-group" style="margin:0">
              <label style="color:var(--text-secondary);font-size:12px">Auth Index</label>
              <div><span class="badge badge-yellow">${failure.authIndex !== undefined ? failure.authIndex : '-'}</span></div>
            </div>
          </div>
          <div class="form-group" style="margin:0">
            <label style="color:var(--text-secondary);font-size:12px">Token Information</label>
            <pre style="background:rgba(0,0,0,0.4);padding:12px;border-radius:8px;overflow-x:auto;font-size:12px;margin:8px 0 0">${JSON.stringify(failure.tokens, null, 2)}</pre>
          </div>
        </div>
      `;
      document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
      document.getElementById('modal').classList.add('active');
    }

    function exportAnalytics() {
      const failures = analyticsData.failures;
      if (failures.length === 0) {
        toast('No data to export', 'info');
        return;
      }

      // Create CSV content
      const headers = ['Timestamp', 'Provider', 'Model', 'Source', 'Auth Index', 'HTTP Status', 'Error Code', 'Error Message', 'Input Tokens', 'Output Tokens'];
      const rows = failures.map(f => [
        new Date(f.timestamp).toISOString(),
        f.provider,
        f.model,
        f.source,
        f.authIndex !== undefined ? f.authIndex : '',
        f.httpStatus || '',
        f.errorCode || '',
        f.errorMessage || '',
        f.tokens?.input_tokens || 0,
        f.tokens?.output_tokens || 0
      ]);

      const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))].join('\n');

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `failure-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      toast(`Exported ${failures.length} failures to CSV`, 'success');
    }

    async function loadAuthFiles() {
      try {
        const [d, usageRes] = await Promise.all([
          api('GET', '/auth-files'),
          api('GET', '/usage').catch(() => ({ usage: {} }))
        ]);

        const usageApis = (usageRes.usage && usageRes.usage.apis) || {};
        const tbody = document.getElementById('authFilesTable');

        if (!d.files?.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No auth files</td></tr>';
          return;
        }

        // Build a map of auth_index to stats by aggregating from all usage details
        const statsByAuthIndex = {};
        Object.values(usageApis).forEach(apiStats => {
          if (apiStats.models) {
            Object.values(apiStats.models).forEach(modelStats => {
              if (modelStats.details) {
                modelStats.details.forEach(detail => {
                  const idx = detail.auth_index;
                  if (idx !== undefined && idx !== null) {
                    if (!statsByAuthIndex[idx]) {
                      statsByAuthIndex[idx] = { requests: 0, failed: 0 };
                    }
                    statsByAuthIndex[idx].requests++;
                    if (detail.failed) {
                      statsByAuthIndex[idx].failed++;
                    }
                  }
                });
              }
            });
          }
        });

        tbody.innerHTML = d.files.map(f => {
          const provider = f.provider || f.type || 'unknown';
          const email = f.email || '-';
          const filename = f.name || '-';
          const project = f.project || f.project_id || '-';
          const region = f.region || '-';

          // Try to find stats using multiple lookup strategies:
          // 1. Direct lookup by various identifiable fields
          let stats = usageApis[f.id] || usageApis[f.name] || usageApis[f.email] || usageApis[f.account] || usageApis[project] || {};
          let requests = stats.total_requests || 0;
          let failed = 0;

          // 2. If direct lookup found stats, count failed requests from details
          if (stats.models) {
            Object.values(stats.models).forEach(m => {
              if (m.details) {
                m.details.forEach(d => {
                  if (d.failed) failed++;
                });
              }
            });
          }

          // 3. Also check by auth_index if available
          const authIndex = f.auth_index;
          if (authIndex !== undefined && authIndex !== null && statsByAuthIndex[authIndex]) {
            // Use auth_index based stats, which may be more accurate
            requests = statsByAuthIndex[authIndex].requests;
            failed = statsByAuthIndex[authIndex].failed;
          }

          const projectRegion = project !== '-' ? `${project}${region !== '-' ? ' / ' + region : ''}` : (region !== '-' ? region : '-');
          // Format last refresh
          let lastRefresh = '-';
          const lr = f.last_refresh || f.lastRefresh || f.last_refreshed_at || f.lastRefreshedAt;

          if (lr) {
            const date = new Date(lr);

            if (!isNaN(date)) {
              lastRefresh = date.toLocaleString();
            }

            else {
              lastRefresh = lr;
            }
          }

          return `<tr> <td><span class="badge badge-purple">${provider}</span></td> <td><div style="font-size:13px">${email}</div><div style="font-size:11px;color:var(--text-muted)">${filename}</div></td> <td style="font-size:13px">${projectRegion}</td> <td><span style="font-size:12px;color:var(--text-secondary)">${lastRefresh}</span></td> <td><div style="display:flex;gap:6px"><span class="badge badge-cyan" title="Total Requests">${requests.toLocaleString()}</span>${failed > 0 ? `<span class="badge badge-red" title="Failed Requests">${failed.toLocaleString()}</span>` : ''}</div></td> <td><span class="badge ${f.expired ? 'badge-red' : 'badge-green'}">${f.expired ? 'Expired' : 'Active'}</span></td> <td> <button class="btn btn-secondary btn-sm" onclick="viewAuthFile('${f.name}')" title="View"></button> <button class="btn btn-secondary btn-sm" onclick="downloadAuth('${f.name}')" title="Download"></button> <button class="btn btn-danger btn-sm" onclick="deleteAuth('${f.name}')" title="Delete"></button> </td> </tr>`;
        }).join('');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function viewAuthFile(name) {
      try {
        const res = await fetch(`/v0/management/auth-files/download?name=${encodeURIComponent(name)}`, {
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        });
        const data = await res.json();

        document.getElementById('modalTitle').textContent = `Auth File: ${name}`;

        document.getElementById('modalContent').innerHTML = `<pre style="background:rgba(0,0,0,0.4);padding:16px;border-radius:8px;overflow-x:auto;font-size:12px;max-height:400px;overflow-y:auto">${JSON.stringify(data, null, 2)}</pre>`;
        document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
        document.getElementById('modal').classList.add('active');
      }

      catch (e) {
        toast('Failed to view: ' + e.message, 'error');
      }
    }

    function downloadAuth(name) {
      window.open(`/v0/management/auth-files/download?name=${encodeURIComponent(name)}`, '_blank');
    }

    async function deleteAuth(name) {
      if (!confirm(`Delete ${name}?`)) return;

      try {
        await api('DELETE', `/auth-files?name=${encodeURIComponent(name)}`);
        toast('Deleted', 'success');
        loadAuthFiles();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function deleteAllAuthFiles() {
      if (!confirm('Delete ALL auth files? This cannot be undone!')) return;

      try {
        const d = await api('GET', '/auth-files');

        for (const f of (d.files || [])) {
          await api('DELETE', `/auth-files?name=${encodeURIComponent(f.name)}`);
        }

        toast('All auth files deleted', 'success');
        loadAuthFiles();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function handleFileDrop(e) {
      e.preventDefault();
      e.target.style.borderColor = 'var(--border-color)';
      e.target.style.background = 'transparent';
      const file = e.dataTransfer.files[0];
      if (file) handleFileSelect(file);
    }

    async function handleFileSelect(file) {
      if (!file) return;

      if (!file.name.endsWith('.json')) {
        toast('Please upload a JSON file', 'error');
        return;
      }

      const status = document.getElementById('uploadStatus');
      status.style.display = 'block';

      status.innerHTML = `<p style="color:var(--accent-cyan)"> Uploading ${file.name}...</p>`;

      try {
        await uploadAuthFile(file);

        status.innerHTML = `<p style="color:var(--accent-green)"> ${file.name} uploaded successfully !</p>`;
        toast('Auth file uploaded', 'success');
        loadAuthFiles();
        // Reset file input
        document.getElementById('authFileInput').value = '';
        setTimeout(() => status.style.display = 'none', 3000);
      }

      catch (e) {
        status.innerHTML = `<p style="color:var(--accent-red)"> Failed: ${e.message}</p>`;
        toast('Upload failed: ' + e.message, 'error');
      }
    }

    async function uploadAuthFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      const res = await fetch('/v0/management/auth-files', {

        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }

        ,
        body: formData
      });

      if (!res.ok) {
        const text = await res.text();

        throw new Error(text || `HTTP ${res.status}`);
      }

      return res.json();
    }

    async function startOAuth(provider) {
      const ep = {
        'anthropic': '/anthropic-auth-url', 'gemini-cli': '/gemini-cli-auth-url', 'codex': '/codex-auth-url', 'antigravity': '/antigravity-auth-url', 'qwen': '/qwen-auth-url', 'iflow': '/iflow-auth-url'
      }

      [provider];

      try {
        toast(`Starting ${provider} OAuth...`, 'info');
        const d = await api('GET', ep);

        if (d.url || d.auth_url) {
          window.open(d.url || d.auth_url, '_blank');
          toast('Complete login in new window', 'info');
        }

        else if (d.message) toast(d.message, 'info');
      }

      catch (e) {
        toast('OAuth failed: ' + e.message, 'error');
      }
    }

    async function loadKeys() {
      try {

        const [a,
          g,
          c,
          x] = await Promise.all([api('GET', '/api-keys').catch(() => ({})),
          api('GET', '/gemini-api-key').catch(() => ({})),
          api('GET', '/claude-api-key').catch(() => ({})),
          api('GET', '/codex-api-key').catch(() => ({}))]);
        const accessKeys = a['api-keys'] || [];
        const geminiKeys = g['gemini-api-key'] || [];
        const claudeKeys = c['claude-api-key'] || [];
        const codexKeys = x['codex-api-key'] || [];

        renderKeyList('accessKeysList', accessKeys, 'access');
        renderKeyList('geminiKeysList', geminiKeys, 'gemini');
        renderKeyList('claudeKeysList', claudeKeys, 'claude');
        renderKeyList('codexKeysList', codexKeys, 'codex');

        // Update key counts
        document.getElementById('accessKeyCount').textContent = `${accessKeys.length} key${accessKeys.length !== 1 ? 's' : ''}`;

        document.getElementById('geminiKeyCount').textContent = `${geminiKeys.length} key${geminiKeys.length !== 1 ? 's' : ''}`;

        document.getElementById('claudeKeyCount').textContent = `${claudeKeys.length} key${claudeKeys.length !== 1 ? 's' : ''}`;

        document.getElementById('codexKeyCount').textContent = `${codexKeys.length} key${codexKeys.length !== 1 ? 's' : ''}`;
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function renderKeyList(id, keys, type) {
      const container = document.getElementById(id);

      if (!keys.length) {
        container.innerHTML = ` <div class="keys-empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></svg><h4>No keys configured</h4><p>Add your first ${type === 'access' ? 'access' : type.charAt(0).toUpperCase() + type.slice(1)} API key to get started</p></div>`;
        return;
      }

      container.innerHTML = keys.map((k, i) => {
        const fullKey = typeof k === 'string' ? k : (k.key || k.api_key || JSON.stringify(k));
        const maskedKey = fullKey.length > 12 ? fullKey.slice(0, 6) + '' + fullKey.slice(-4) : '';
        const keyMeta = typeof k === 'object' ? (k.project || k.name || 'API Key') : 'API Key';

        return ` <div class="key-card" > <div class="key-icon" > <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" > <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /> </svg> </div> <div class="key-info" > <div class="key-value" >${maskedKey
          }</div> <div class="key-meta" >${keyMeta
          }</div> </div> <div class="key-actions" > <button class="key-action-btn copy" onclick="copyToClipboard('${fullKey.replace(/'/g, " \\'")}')">
 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>Copy </button><button class="key-action-btn delete" onclick="deleteKey('${type}', ${i})"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>Delete </button></div></div>`;
      }).join('');
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('Copied to clipboard', 'success');

      }).catch(() => {
        toast('Failed to copy', 'error');
      });
    }

    function openAddKeyModal(type) {
      document.getElementById('modalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)} Key`;
      document.getElementById('modalContent').innerHTML = `<div class="form-group"><label>API Key</label><input type="text" id="newKeyValue" class="form-input" placeholder="Enter API key"></div>`;
      document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="addKey('${type}')">Add</button>`;
      document.getElementById('modal').classList.add('active');
    }

    async function addKey(type) {
      const v = document.getElementById('newKeyValue').value;
      if (!v) return;

      try {
        const epMap = {
          access: '/api-keys', gemini: '/gemini-api-key', claude: '/claude-api-key', codex: '/codex-api-key'
        };
        const ep = epMap[type];

        await api('PATCH', ep, {
          old: '',
          new: v
        });
        closeModal();
        toast('Added', 'success');
        loadKeys();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function deleteKey(type, idx) {
      if (!confirm('Delete?')) return;

      try {
        const epMap = {
          access: '/api-keys', gemini: '/gemini-api-key', claude: '/claude-api-key', codex: '/codex-api-key'
        };
        const ep = epMap[type];
        await api('DELETE', `${ep}?index=${idx}`);
        toast('Deleted', 'success');
        loadKeys();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    async function loadConfig() {
      try {
        const [cfg,
          yaml] = await Promise.all([api('GET', '/config'), api('GET', '/config.yaml')]);
        document.getElementById('toggleDebug').checked = cfg.debug || false;
        document.getElementById('toggleUsageStats').checked = cfg.usage_statistics_enabled || cfg['usage-statistics-enabled'] || false;
        document.getElementById('toggleLogging').checked = cfg.logging_to_file || cfg['logging-to-file'] || false;
        document.getElementById('toggleRequestLog').checked = cfg.request_log || cfg['request-log'] || false;
        document.getElementById('toggleWsAuth').checked = cfg.websocket_auth || cfg['websocket-auth'] || false;
        document.getElementById('configEditor').value = yaml;
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function toggleSetting(s, v) {
      try {
        await api('PUT', `/${s}`, {
          value: v
        });

        toast(`${s} updated`, 'success');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function saveConfig() {
      try {
        await fetch('/v0/management/config.yaml', {
          method: 'PUT', headers: {
            'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/yaml'
          }

          , body: document.getElementById('configEditor').value
        });
        toast('Saved', 'success');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function loadAmpSettings() {
      try {
        const res = await api('GET', '/ampcode');
        const d = res.ampcode || {};
        document.getElementById('ampUpstreamUrl').value = d.upstream_url || d['upstream-url'] || '';
        document.getElementById('ampUpstreamKey').value = d.upstream_api_key || d['upstream-api-key'] || '';

        // Toggles
        document.getElementById('ampForce').checked = d.force_model_mappings || d['force-model-mappings'] || false;
        document.getElementById('ampRestrict').checked = d.restrict_management_to_localhost || d['restrict-management-to-localhost'] || false;

        const m = d.model_mappings || d['model-mappings'] || [];
        const c = document.getElementById('modelMappings');
        const countEl = document.getElementById('mappingCount');

        if (countEl) countEl.textContent = m.length;

        // Helper to parse reasoning effort from target
        function parseTarget(to) {
          const match = to.match(/:reasoning=(\w+)$/);
          if (match) {
            return { model: to.replace(/:reasoning=\w+$/, ''), reasoning: match[1] };
          }
          return { model: to, reasoning: null };
        }

        // Helper to format reasoning effort badge
        function reasoningBadge(effort) {
          if (!effort) return '';
          const colors = { low: 'yellow', medium: 'blue', high: 'purple' };
          return `<span class="badge badge-${colors[effort] || 'cyan'}" style="margin-left:8px;font-size:10px;"> ${effort}</span>`;
        }

        if (m.length === 0) {
          c.innerHTML = ` <div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:16px;opacity:0.5;color:var(--text-secondary)"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg><h4>No Model Mappings</h4><p>Configure model aliases to map incoming model names to upstream models.</p></div>`;
        } else {
          c.innerHTML = m.map(item => {
            const parsed = parseTarget(item.to);
            return `
            <div class="mapping-card">
              <div class="mapping-flow">
                <div class="mapping-source">${item.from}</div>
                <svg class="mapping-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <div class="mapping-target">${parsed.model}${reasoningBadge(parsed.reasoning)}</div>
              </div>
              <div class="mapping-actions">
                <button class="mapping-action-btn edit" onclick="openEditMappingModal('${item.from}', '${item.to}')" title="Edit mapping">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="mapping-action-btn delete" onclick="deleteAmpMapping('${item.from}')" title="Delete mapping">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </div>
          `}).join('');
        }

        // Render combos side panel
        renderCombosSidePanel();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function saveAmpSettings() {
      try {
        const u = document.getElementById('ampUpstreamUrl').value,
          k = document.getElementById('ampUpstreamKey').value;

        if (u) await api('PUT', '/ampcode/upstream-url', {
          value: u
        });

        if (k) await api('PUT', '/ampcode/upstream-api-key', {
          value: k
        });
        toast('Saved', 'success');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }



    async function toggleAmpSetting(key, value) {
      try {
        await api('PUT', `/ampcode/${key}`, { value });
        toast('Setting updated', 'success');
      } catch (e) {
        toast('Failed to update: ' + e.message, 'error');
        // Revert toggle visually if failed
        loadAmpSettings();
      }
    }

    async function openAddMappingModal(oldFrom = null, oldTo = null, oldReasoningEffort = null) {
      document.getElementById('modalTitle').textContent = 'Add Model Mapping';

      // Always try to fetch fresh models if list is empty
      if (!allModels || allModels.length === 0) {
        try {
          // Try to load config to get access keys first if needed
          const cfg = await api('GET', '/config').catch(() => ({}));
          accessApiKeys = cfg['api-keys'] || cfg.api_keys || [];
          allModels = await fetchModels();
        } catch (e) {
          console.error("Failed to fetch models for dropdown", e);
          // Fallback: allow manual entry if fetch fails
        }
      }

      const presets = getPresets();
      const presetOptions = presets.map(p => `<option value="${p.value}">${p.label}</option>`).join('');

      // If no models available, show a placeholder or just let it be empty
      // Group models by provider
      const groupedModels = {};
      if (allModels && allModels.length > 0) {
        allModels.forEach(m => {
          const owner = m.owned_by || m.provider || 'Other';
          if (!groupedModels[owner]) groupedModels[owner] = [];
          groupedModels[owner].push(m.id || m.name);
        });
      }

      // Models that support reasoning effort
      const reasoningModels = [
        'o1', 'o1-preview', 'o1-mini', 'o3', 'o3-mini', 'o4-mini',
        'claude-3-7-sonnet', 'claude-sonnet-4',
        'gemini-2.0-flash-thinking', 'gemini-2.5-pro', 'gemini-2.5-flash'
      ];

      document.getElementById('modalContent').innerHTML = `
        <style>
          .model-selector { position: relative; }
          .model-search { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; }
          .model-list { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; z-index: 100; margin-top: 4px; }
          .model-list.active { display: block; }
          .model-group-title { padding: 8px 12px; background: rgba(255,255,255,0.05); font-weight: bold; font-size: 12px; color: var(--accent-cyan); text-transform: uppercase; }
          .model-option { padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
          .model-option:hover { background: rgba(255,255,255,0.1); }
          .model-option.selected { background: var(--accent-purple); color: white; }
          .input-mode-toggle { display: flex; gap: 8px; margin-bottom: 8px; }
          .input-mode-btn { padding: 6px 12px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
          .input-mode-btn.active { background: var(--accent-cyan); color: #0d0d1a; border-color: var(--accent-cyan); }
          .input-mode-btn:hover:not(.active) { border-color: var(--accent-cyan); color: var(--text-primary); }
          .reasoning-effort-group { margin-top: 12px; padding: 12px; background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3); border-radius: 8px; display: none; }
          .reasoning-effort-group.visible { display: block; }
          .reasoning-effort-group label { color: var(--accent-purple); font-size: 13px; margin-bottom: 8px; display: block; }
          .reasoning-effort-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        </style>
        <div class="form-group">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin-bottom:0">Source Model (From)</label>
            <a href="javascript:void(0)" onclick="openManagePresetsModal()" style="font-size:12px; color:var(--accent-cyan); text-decoration:none; display:flex; align-items:center; gap:4px">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                Manage Presets
            </a>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
             <select class="form-input" style="flex:1" onchange="if(this.value) document.getElementById('mappingFrom').value = this.value">
                <option value="">Select a preset...</option>
                ${presetOptions}
             </select>
          </div>
          <input type="text" id="mappingFrom" class="form-input" placeholder="Or type manually (e.g. gpt-4)">
        </div>
        <div class="form-group">
          <label>Target Model (To)</label>
          <div class="input-mode-toggle">
            <button type="button" class="input-mode-btn active" onclick="setTargetInputMode('select')">Select from list</button>
            <button type="button" class="input-mode-btn" onclick="setTargetInputMode('manual')">Manual input</button>
          </div>
          <div id="targetSelectMode" class="model-selector">
            <input type="text" id="modelSearchInput" class="model-search" placeholder="Search and select model..." autocomplete="off">
            <div id="modelListDropdown" class="model-list"></div>
          </div>
          <div id="targetManualMode" style="display:none;">
            <input type="text" id="mappingToManual" class="form-input" placeholder="Enter model ID (e.g. gpt-4o, claude-sonnet-4)" oninput="updateReasoningEffortVisibility(this.value)">
          </div>
          <input type="hidden" id="mappingTo">
          <div id="reasoningEffortGroup" class="reasoning-effort-group">
            <label>
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
              Reasoning Effort (Extended Thinking)
            </label>
            <select id="reasoningEffort" class="form-input">
              <option value="">Default (model decides)</option>
              <option value="low">Low - Faster responses</option>
              <option value="medium">Medium - Balanced</option>
              <option value="high">High - More thorough reasoning</option>
            </select>
            <div class="reasoning-effort-hint">
              Controls how much time the model spends on extended thinking. Higher effort = more thorough but slower.
            </div>
          </div>
        </div>
      `;

      // Render the custom list
      const listContainer = document.getElementById('modelListDropdown');
      const searchInput = document.getElementById('modelSearchInput');
      const hiddenInput = document.getElementById('mappingTo');

      function renderList(filter = '') {
        const f = filter.toLowerCase();
        let html = '';
        const sortedOwners = Object.keys(groupedModels).sort();

        let hasMatches = false;

        sortedOwners.forEach(owner => {
          const models = groupedModels[owner].filter(id => id.toLowerCase().includes(f));
          if (models.length > 0) {
            hasMatches = true;
            html += `<div class="model-group-title">${owner}</div>`;
            models.forEach(id => {
              html += `<div class="model-option" onclick="selectModel('${id}')">${id}</div>`;
            });
          }
        });

        if (!hasMatches) {
          html = '<div style="padding:12px;color:var(--text-secondary);text-align:center">No models found</div>';
        }

        listContainer.innerHTML = html;
      }

      // Initial render (hidden until focus)
      renderList();

      // Event Listeners
      searchInput.addEventListener('focus', () => listContainer.classList.add('active'));
      searchInput.addEventListener('input', (e) => {
        listContainer.classList.add('active');
        renderList(e.target.value);
        // Update hidden input for manual typing in search
        hiddenInput.value = e.target.value;
        updateReasoningEffortVisibility(e.target.value);
      });

      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeList(e) {
          if (!e.target.closest('.model-selector')) {
            listContainer.classList.remove('active');
          }
        });
      }, 0);

      // Check if a model supports reasoning effort
      window.modelSupportsReasoning = function(modelId) {
        if (!modelId) return false;
        const m = modelId.toLowerCase();
        return reasoningModels.some(rm => m.includes(rm.toLowerCase()));
      };

      window.updateReasoningEffortVisibility = function(modelId) {
        const group = document.getElementById('reasoningEffortGroup');
        if (modelSupportsReasoning(modelId)) {
          group.classList.add('visible');
        } else {
          group.classList.remove('visible');
        }
      };

      window.setTargetInputMode = function(mode) {
        const btns = document.querySelectorAll('.input-mode-toggle .input-mode-btn');
        btns.forEach(b => b.classList.remove('active'));
        if (mode === 'select') {
          btns[0].classList.add('active');
          document.getElementById('targetSelectMode').style.display = 'block';
          document.getElementById('targetManualMode').style.display = 'none';
          // Sync value
          hiddenInput.value = searchInput.value;
          updateReasoningEffortVisibility(searchInput.value);
        } else {
          btns[1].classList.add('active');
          document.getElementById('targetSelectMode').style.display = 'none';
          document.getElementById('targetManualMode').style.display = 'block';
          // Sync value
          const manualInput = document.getElementById('mappingToManual');
          hiddenInput.value = manualInput.value;
          updateReasoningEffortVisibility(manualInput.value);
        }
      };

      window.selectModel = function (id) {
        hiddenInput.value = id;
        searchInput.value = id;
        listContainer.classList.remove('active');
        updateReasoningEffortVisibility(id);
      };

      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveAmpMapping('${oldFrom || ''}')">${oldFrom ? 'Save Changes' : 'Add Mapping'}</button>
      `;
      document.getElementById('modal').classList.add('active');

      // Pre-fill values if editing
      if (oldFrom) {
        document.getElementById('mappingFrom').value = oldFrom;
        // Trigger search/select logic for target
        if (oldTo) {
          selectModel(oldTo);
          document.getElementById('mappingToManual').value = oldTo;
        }
      }
      // Pre-fill reasoning effort
      if (oldReasoningEffort) {
        document.getElementById('reasoningEffort').value = oldReasoningEffort;
      }
    }

    async function openEditMappingModal(from, to) {
      // Parse reasoning effort from target if present
      let reasoningEffort = '';
      let cleanTo = to;
      const reasoningMatch = to.match(/:reasoning=(\w+)$/);
      if (reasoningMatch) {
        reasoningEffort = reasoningMatch[1];
        cleanTo = to.replace(/:reasoning=\w+$/, '');
      }
      await openAddMappingModal(from, cleanTo, reasoningEffort);
      document.getElementById('modalTitle').textContent = 'Edit Model Mapping';
    }

    // --- Preset Management ---

    function getPresets() {
      let p = localStorage.getItem('amp_source_presets');
      if (!p) {
        const defaults = [
          { id: 1, label: 'Smart', value: 'claude-opus-4-5-20251101' },
          { id: 2, label: 'Librarian', value: 'claude-sonnet-4-5-20250929' },
          { id: 3, label: 'Search and title', value: 'claude-haiku-4-5-20251001' }
        ];
        localStorage.setItem('amp_source_presets', JSON.stringify(defaults));
        return defaults;
      }
      return JSON.parse(p);
    }

    function openManagePresetsModal() {
      const presets = getPresets();
      document.getElementById('modalTitle').textContent = 'Manage Source Presets';

      const content = `
            <div class="presets-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
                <table style="width:100%; border-collapse: separate; border-spacing: 0 8px;">
                    <thead>
                        <tr style="color: var(--text-secondary); font-size: 12px;">
                            <th style="padding: 0 8px; text-align: left;">Label</th>
                            <th style="padding: 0 8px; text-align: left;">Source Model ID</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="presetsTableBody">
                        ${presets.map(p => `
                            <tr class="preset-row" id="preset-${p.id}">
                                <td>
                                    <input type="text" class="form-input" value="${p.label}" placeholder="Label" onchange="markUnsaved()">
                                </td>
                                <td>
                                    <input type="text" class="form-input" value="${p.value}" placeholder="Model ID" onchange="markUnsaved()">
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); markUnsaved();" style="padding: 8px 12px;"></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="addPresetRow()" style="width: 100%; border-style: dashed;">+ Add New Preset</button>
            <p id="presetStatus" style="font-size:12px; color:var(--text-muted); margin-top:8px; text-align:right; opacity:0; transition:opacity 0.2s">Unsaved changes</p>
        `;

      document.getElementById('modalContent').innerHTML = content;

      document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="openAddMappingModal()">Back</button>
            <button class="btn btn-primary" onclick="saveAllPresets()">Save Changes</button>
        `;
    }

    function addPresetRow() {
      const tbody = document.getElementById('presetsTableBody');
      const tr = document.createElement('tr');
      tr.className = 'preset-row';
      tr.innerHTML = `
            <td><input type="text" class="form-input" placeholder="Label" autofocus></td>
            <td><input type="text" class="form-input" placeholder="Model ID"></td>
            <td style="text-align: right;">
                <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); markUnsaved();" style="padding: 8px 12px;"></button>
            </td>
        `;
      tbody.appendChild(tr);
      markUnsaved();
    }

    function markUnsaved() {
      const el = document.getElementById('presetStatus');
      if (el) el.style.opacity = '1';
    }

    function saveAllPresets() {
      const rows = document.querySelectorAll('.preset-row');
      const newPresets = [];
      let valid = true;

      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const label = inputs[0].value.trim();
        const value = inputs[1].value.trim();

        if (label && value) {
          newPresets.push({
            id: Date.now() + Math.random(),
            label,
            value
          });
        } else if (label || value) {
          // If one is filled but not the other, it's an error
          valid = false;
          inputs[0].style.borderColor = !label ? 'var(--accent-red)' : '';
          inputs[1].style.borderColor = !value ? 'var(--accent-red)' : '';
        }
      });

      if (!valid) {
        toast('Please fill in both fields for all presets', 'error');
        return;
      }

      localStorage.setItem('amp_source_presets', JSON.stringify(newPresets));
      toast('Presets saved', 'success');
      openAddMappingModal(); // Go back to the main modal
    }

    // -------------------------

    async function saveAmpMapping(oldFromKey) {
      const from = document.getElementById('mappingFrom').value.trim();
      // Get target value from hidden input (synced by both modes) or fallback to manual input
      let to = document.getElementById('mappingTo').value.trim();
      const manualInput = document.getElementById('mappingToManual');
      if (!to && manualInput) {
        to = manualInput.value.trim();
      }
      // Get reasoning effort if set
      const reasoningEffortEl = document.getElementById('reasoningEffort');
      const reasoningEffort = reasoningEffortEl ? reasoningEffortEl.value : '';

      if (!from || !to) {
        toast('Both fields are required', 'error');
        return;
      }

      // Append reasoning effort to target if specified
      let finalTo = to;
      if (reasoningEffort) {
        // Format: model_id:reasoning=effort (e.g., o3-mini:reasoning=high)
        // Remove any existing reasoning suffix first
        finalTo = to.replace(/:reasoning=\w+$/, '');
        finalTo = `${finalTo}:reasoning=${reasoningEffort}`;
      }

      try {
        // Check for duplicates
        // Note: We need to fetch current mappings to verify because the list in DOM might be stale or incomplete
        const res = await api('GET', '/ampcode/model-mappings');
        const currentMappings = res['model-mappings'] || [];

        const exists = currentMappings.some(m => m.from === from);

        // If it's a new mapping (no oldKey) AND it exists -> Duplicate
        // If it's an edit (oldKey present) AND key changed (oldKey != from) AND new key exists -> Duplicate
        if ((!oldFromKey && exists) || (oldFromKey && oldFromKey !== from && exists)) {
          toast(`Mapping for source "${from}" already exists.`, 'error');
          return;
        }
        // If editing and key changed, delete old one first
        if (oldFromKey && oldFromKey !== from) {
          await api('DELETE', '/ampcode/model-mappings', { value: [oldFromKey] });
        }

        await api('PATCH', '/ampcode/model-mappings', {
          value: [{ from, to: finalTo }]
        });
        closeModal();
        toast('Mapping saved', 'success');
        loadAmpSettings();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function deleteAmpMapping(from) {
      if (!confirm(`Delete mapping for ${from}?`)) return;
      try {
        // DELETE requires a body with the list of 'from' values to remove
        await fetch('/v0/management/ampcode/model-mappings', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: [from] })
        });
        toast('Mapping deleted', 'success');
        loadAmpSettings();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    // --- Combo Management ---

    function getCombos() {
      const c = localStorage.getItem('amp_mapping_combos');
      return c ? JSON.parse(c) : [];
    }

    function saveCombos(combos) {
      localStorage.setItem('amp_mapping_combos', JSON.stringify(combos));
      renderCombosSidePanel();
    }

    function renderCombosSidePanel() {
      const combos = getCombos();
      const el = document.getElementById('combosSidePanel');
      if (!el) return;

      if (combos.length === 0) {
        el.innerHTML = `
                <div style="padding:24px; text-align:center; color:var(--text-secondary); font-size:13px; border:1px dashed var(--border-color); border-radius:8px; background:rgba(0,0,0,0.1)">
                  No combos created yet.<br>
                  <a href="javascript:void(0)" onclick="openAddComboModal()" style="color:var(--accent-cyan); text-decoration:none; display:inline-block; margin-top:4px">Create your first combo</a>
                </div>
            `;
        return;
      }

      el.innerHTML = combos.map(c => `
            <div class="combo-item" style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:12px; display:flex; align-items:center; justify-content:space-between; transition:all 0.2s; cursor:default; position:relative; overflow:hidden">
                <div style="display:flex; align-items:center; gap:12px">
                    <div style="width:32px; height:32px; background:rgba(255,255,255,0.03); border-radius:6px; display:flex; align-items:center; justify-content:center; color:var(--text-secondary)">
                        <span style="font-weight:bold; font-size:14px">${c.name.charAt(0).toUpperCase()}</span>
                    </div>
                    <div>
                        <div style="font-size:14px; font-weight:600; color:var(--text-primary); margin-bottom:2px">${c.name}</div>
                        <div style="font-size:11px; color:var(--text-secondary)">${c.mappings.length} mapping${c.mappings.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" style="padding:4px 12px; font-size:12px; opacity:0; transform:translateX(10px); transition:all 0.2s" onclick="applyCombo('${c.id}')">Apply</button>
                <style>
                    .combo-item:hover { border-color: var(--accent-purple); box-shadow: 0 2px 8px rgba(167, 139, 250, 0.1); }
                    .combo-item:hover .btn-primary { opacity: 1; transform: translateX(0); }
                </style>
            </div>
        `).join('');
    }

    function openManageCombosModal() {
      const combos = getCombos();
      document.getElementById('modalTitle').textContent = 'Model Mapping Combos';

      const content = `
            <div style="margin-bottom:16px">
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">Combos allow you to apply multiple model mappings at once. Applying a combo will update existing mappings with matching source models.</p>
                ${combos.length === 0 ?
          `<div class="empty-state" style="padding:24px;border:1px dashed var(--border-color);border-radius:8px">No combos saved</div>` :
          `<div class="combos-list" style="display:grid;gap:12px">
                        ${combos.map(c => `
                            <div class="mapping-card">
                                <div style="flex:1">
                                    <div style="font-weight:600;color:var(--text-primary)">${c.name}</div>
                                    <div style="font-size:12px;color:var(--text-secondary)">${c.mappings.length} mappings</div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn btn-secondary btn-sm" onclick="openAddComboModal('${c.id}')" title="Edit"></button>
                                    <button class="btn btn-primary btn-sm" onclick="applyCombo('${c.id}')" title="Apply Combo">Apply</button>
                                    <button class="btn btn-secondary btn-sm" onclick="deleteCombo('${c.id}')" title="Delete"></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`
        }
            </div>
            <button class="btn btn-secondary btn-sm" style="width:100%;border-style:dashed" onclick="openAddComboModal()">+ Create New Combo</button>
        `;

      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
      document.getElementById('modal').classList.add('active');
    }

    function openAddComboModal(editId = null) {
      // Setup simple combo editor
      document.getElementById('modalTitle').textContent = editId ? 'Edit Combo' : 'Create Combo';

      // We need the presets for the dropdowns
      const presets = getPresets();
      const presetOptions = presets.map(p => `<option value="${p.value}">${p.label} (${p.value})</option>`).join('');

      let comboName = '';
      let mappings = [];

      if (editId) {
        const combos = getCombos();
        const c = combos.find(x => x.id === editId);
        if (c) {
          comboName = c.name;
          mappings = c.mappings;
        }
      }

      document.getElementById('modalContent').innerHTML = `
            <div class="form-group">
                <label>Combo Name</label>
                <input type="text" id="comboName" class="form-input" placeholder="e.g. Creative Suite" value="${comboName}">
            </div>
            <label style="display:block;margin-bottom:8px;font-size:14px;font-weight:500">Mappings</label>
            <div id="comboMappingsList" style="max-height:300px;overflow-y:auto;margin-bottom:12px;display:grid;gap:8px">
                <!-- Rows will be added here -->
            </div>
            <button class="btn btn-secondary btn-sm" onclick="addComboRow()" style="width:100%">+ Add Row</button>
            <template id="comboRowTemplate">
                <div class="combo-row" style="display:flex;gap:8px;align-items:center">
                    <select class="form-input" style="flex:1" onchange="this.nextElementSibling.value=this.value">
                        <option value="">Select source...</option>
                        ${presetOptions}
                    </select>
                    <input type="text" class="form-input" style="flex:1" placeholder="Source (From)">
                    <input type="text" class="form-input" style="flex:1" placeholder="Target (To)">
                    <button class="btn btn-danger btn-sm" onclick="this.closest('.combo-row').remove()"></button>
                </div>
            </template>
        `;

      document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="openManageCombosModal()">Back</button>
            <button class="btn btn-primary" onclick="saveCombo('${editId || ''}')">${editId ? 'Save Changes' : 'Save Combo'}</button>
        `;

      // Add rows
      if (mappings.length > 0) {
        mappings.forEach(m => addComboRow(m.from, m.to));
      } else {
        addComboRow();
      }
    }

    function addComboRow(from = '', to = '') {
      const tmpl = document.getElementById('comboRowTemplate');
      const div = tmpl.content.cloneNode(true);
      const inputs = div.querySelectorAll('input');
      if (from) inputs[0].value = from;
      if (to) inputs[1].value = to;
      document.getElementById('comboMappingsList').appendChild(div);
    }

    function saveCombo(editId) {
      const name = document.getElementById('comboName').value.trim();
      if (!name) return toast('Combo name is required', 'error');

      const rows = document.querySelectorAll('.combo-row');
      const mappings = [];

      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const from = inputs[0].value.trim();
        const to = inputs[1].value.trim();
        if (from && to) mappings.push({ from, to });
      });

      if (mappings.length === 0) return toast('Add at least one mapping', 'error');

      const combos = getCombos();

      if (editId) {
        const idx = combos.findIndex(c => c.id === editId);
        if (idx >= 0) {
          combos[idx].name = name;
          combos[idx].mappings = mappings;
        }
      } else {
        combos.push({
          id: Date.now().toString(),
          name,
          mappings
        });
      }

      saveCombos(combos);
      toast('Combo saved', 'success');
      openManageCombosModal();
    }

    function deleteCombo(id) {
      if (!confirm('Delete this combo?')) return;
      const combos = getCombos().filter(c => c.id !== id);
      saveCombos(combos);
      openManageCombosModal();
    }

    async function applyCombo(id) {
      if (!confirm('Apply this combo? This will update target models for any matching sources.')) return;

      try {
        const combo = getCombos().find(c => c.id === id);
        if (!combo) return;

        // Get current mappings
        const res = await api('GET', '/ampcode/model-mappings');
        const currentMappings = res['model-mappings'] || [];

        // Merge logic
        let updatedCount = 0;
        let addedCount = 0;
        const newMappings = [...currentMappings];

        combo.mappings.forEach(cm => {
          const idx = newMappings.findIndex(m => m.from === cm.from);
          if (idx >= 0) {
            // Update target if different
            if (newMappings[idx].to !== cm.to) {
              newMappings[idx].to = cm.to;
              updatedCount++;
            }
          } else {
            // Add new
            newMappings.push({ from: cm.from, to: cm.to });
            addedCount++;
          }
        });

        if (updatedCount === 0 && addedCount === 0) {
          toast('No changes needed', 'info');
          return;
        }

        // DELETE all existing first to handle clean slate for the merge?
        // Wait, we need to be careful. The patch logic I wrote in `saveAmpMapping` was deleting one-offs.
        // The API likely just overwrites the list if we use PUT, or appends if PATCH?
        // Checking previous `saveAmpMapping`: it deletes old then PATCHes.
        // The backend endpoint `/v0/management/ampcode/model-mappings` likely accepts a list to ADD/UPDATE.
        // But to be safe and ensure clean state matching our "merged" view, we might need a way to set the whole list.
        // However, the user asked for *replace*.
        // Let's rely on patching individually or batch patching.
        // Re-reading `saveAmpMapping`: `await api('PATCH', ... { value: [{from, to}] })`
        // So PATCH takes a list. It probably upserts.

        // Let's just send the `combo.mappings` to PATCH. This will update existing keys and add new ones.
        // It won't remove keys that are NOT in the combo (which is correct for "Update").

        await api('PATCH', '/ampcode/model-mappings', { value: combo.mappings });
        toast(`Applied: ${updatedCount} updated, ${addedCount} added`, 'success');
        closeModal();
        loadAmpSettings();

      } catch (e) {
        toast('Failed to apply combo: ' + e.message, 'error');
      }
    }
    // Enhanced Log Management
    let logState = {
      allLogs: [],
      filter: 'ALL',
      search: '',
      autoRefreshInterval: null,
      latestTimestamp: 0,
      searchDebounceTimer: null,
      errorCount: 0,
      warnCount: 0
    };

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function parseLogLine(line) {
      let level = 'INFO';
      let time = '';
      let message = line; // Default to full line

      // Parse bracket-style log format: [2025-12-12 18:35:19] [level] [source:line] message
      const bracketMatch = line.match(/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]\s*\[(\w+)\]\s*(?:\[[^\]]+\]\s*)?(.*)$/);

      if (bracketMatch) {
        time = bracketMatch[1];
        const levelStr = bracketMatch[2].toLowerCase();
        if (levelStr === 'error' || levelStr === 'erro') level = 'ERROR';
        else if (levelStr === 'warn' || levelStr === 'warning') level = 'WARN';
        else if (levelStr === 'debug' || levelStr === 'debu') level = 'DEBUG';
        else if (levelStr === 'info') level = 'INFO';
        message = bracketMatch[3] || '';
      } else {
        // Fallback: Heuristic for log level
        if (line.includes('level=error') || line.includes('ERROR') || line.includes('[ERRO')) level = 'ERROR';
        else if (line.includes('level=warn') || line.includes('WARN') || line.includes('[WARN')) level = 'WARN';
        else if (line.includes('level=debug') || line.includes('DEBUG') || line.includes('[DEBU')) level = 'DEBUG';

        // Fallback: Heuristic for timestamp
        // Match ISO strings like 2024-12-11T... or Go default format
        const timeMatch = line.match(/time="([^"]+)"/) ||
          line.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})/) ||
          line.match(/(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})/);

        if (timeMatch) {
          time = timeMatch[1] || timeMatch[0];
        }
      }

      return { raw: line, time, level, message };
    }

    async function loadLogs(isAuto = false) {
      const v = document.getElementById('logViewer');
      if (!isAuto && (!logState.allLogs.length)) {
        v.innerHTML = '<div class="empty-logs"><p class="spinner">Loading...</p></div>';
      }

      try {
        // Use incremental loading if we have a latest timestamp
        let url = '/logs?limit=500';
        if (isAuto && logState.latestTimestamp > 0) {
          url += '&after=' + logState.latestTimestamp;
        }

        const d = await api('GET', url);
        const lines = d.lines || [];
        const newLogs = lines
          .filter(l => !l.includes('/v0/management/logs'))
          .map(parseLogLine);

        if (isAuto && logState.latestTimestamp > 0 && newLogs.length > 0) {
          // Incremental update - append new logs
          logState.allLogs = [...logState.allLogs, ...newLogs].slice(-1000);
        } else {
          // Full refresh
          logState.allLogs = newLogs;
        }

        // Update latest timestamp for incremental loading
        if (d['latest-timestamp']) {
          logState.latestTimestamp = d['latest-timestamp'];
        }

        // Update error/warn counts
        logState.errorCount = logState.allLogs.filter(l => l.level === 'ERROR').length;
        logState.warnCount = logState.allLogs.filter(l => l.level === 'WARN').length;

        renderLogs();

        // Update live status UI
        updateLogStatusUI();

      } catch (e) {
        if (!isAuto) toast('Failed to load logs: ' + e.message, 'error');
      }
    }

    function updateLogStatusUI() {
      const statusText = document.getElementById('liveStatusText');
      if (logState.autoRefreshInterval) {
        statusText.innerText = 'Live';
        statusText.style.color = 'var(--accent-green)';
      } else {
        statusText.innerText = 'Last updated: ' + new Date().toLocaleTimeString();
        statusText.style.color = 'var(--text-muted)';
      }

      // Update error count badge on ERROR filter button
      const errorBtn = document.getElementById('filter-ERROR');
      if (errorBtn) {
        if (logState.errorCount > 0) {
          errorBtn.innerHTML = `ERROR <span class="log-count-badge error">${logState.errorCount}</span>`;
        } else {
          errorBtn.textContent = 'ERROR';
        }
      }

      const warnBtn = document.getElementById('filter-WARN');
      if (warnBtn) {
        if (logState.warnCount > 0) {
          warnBtn.innerHTML = `WARN <span class="log-count-badge warn">${logState.warnCount}</span>`;
        } else {
          warnBtn.textContent = 'WARN';
        }
      }
    }

    function renderLogs() {
      const v = document.getElementById('logViewer');
      const filter = logState.filter;
      const search = logState.search.toLowerCase();
      let searchRegex = null;

      try {
        if (search) searchRegex = new RegExp(search, 'i');
      } catch (e) { }

      const filtered = logState.allLogs.filter(l => {
        if (filter !== 'ALL' && l.level !== filter) return false;
        if (search) {
          if (searchRegex) return searchRegex.test(l.raw);
          return l.raw.toLowerCase().includes(search);
        }
        return true;
      });

      document.getElementById('logCount').innerText = `${filtered.length} lines`;

      if (filtered.length === 0) {
        v.innerHTML = '<div class="empty-logs"><p>No logs found matching filters</p></div>';
        return;
      }

      // We only render the last 500 filtered items to prevent DOM overload if array is huge
      const linesToRender = filtered.slice(-500);

      const html = linesToRender.map((l, idx) => {
        let lvlClass = l.level.toLowerCase();
        // Use the extracted message (without timestamp/level prefix) for cleaner display
        let displayTime = l.time ? (l.time.length > 15 ? l.time.substring(11, 19) : l.time) : '--:--:--';

        return `
           <div class="log-entry ${lvlClass}" data-log-idx="${idx}" onclick="copyLogEntry(this)" title="Click to copy">
             <div class="log-time" title="${escapeHtml(l.time)}">${escapeHtml(displayTime)}</div>
             <div class="log-lvl ${lvlClass}">${l.level}</div>
             <div class="log-msg">${escapeHtml(l.message)}</div> 
           </div>
         `;
      }).join('');

      const wasAtBottom = v.scrollTop + v.clientHeight >= v.scrollHeight - 50;
      v.innerHTML = html;

      // Scroll to bottom if we were at bottom or if it's the first load
      if (wasAtBottom || !v.getAttribute('data-loaded')) {
        v.scrollTop = v.scrollHeight;
        v.setAttribute('data-loaded', 'true');
      }
    }

    function copyLogEntry(element) {
      const timeEl = element.querySelector('.log-time');
      const levelEl = element.querySelector('.log-lvl');
      const msgEl = element.querySelector('.log-msg');

      const logText = `[${timeEl?.getAttribute('title') || timeEl?.textContent || ''}] [${levelEl?.textContent || ''}] ${msgEl?.textContent || ''}`;

      navigator.clipboard.writeText(logText).then(() => {
        // Visual feedback - brief highlight
        element.style.background = 'rgba(0, 229, 255, 0.15)';
        setTimeout(() => {
          element.style.background = '';
        }, 300);
        toast('Log entry copied to clipboard', 'success');
      }).catch(() => {
        toast('Failed to copy log entry', 'error');
      });
    }

    function setLogFilter(filter) {
      logState.filter = filter;
      document.querySelectorAll('.log-filter-btn').forEach(b => {
        b.classList.toggle('active', b.id === 'filter-' + filter);
      });
      renderLogs();
    }

    function filterLogs() {
      // Debounce search to avoid excessive re-renders
      if (logState.searchDebounceTimer) {
        clearTimeout(logState.searchDebounceTimer);
      }
      logState.searchDebounceTimer = setTimeout(() => {
        logState.search = document.getElementById('logSearch').value;
        renderLogs();
      }, 150);
    }

    function toggleAutoRefresh(enabled) {
      if (logState.autoRefreshInterval) clearInterval(logState.autoRefreshInterval);
      logState.autoRefreshInterval = null;

      const dot = document.getElementById('liveStatusDot');
      if (dot) dot.classList.toggle('active', enabled);

      if (enabled) {
        loadLogs(true);
        logState.autoRefreshInterval = setInterval(() => loadLogs(true), 2000);
      } else {
        updateLogStatusUI(); // Update status text properly when toggled off
      }
    }

    function stopLogAutoRefresh() {
      // Called when navigating away from logs tab
      if (logState.autoRefreshInterval) {
        clearInterval(logState.autoRefreshInterval);
        logState.autoRefreshInterval = null;
        const toggle = document.getElementById('autoRefreshToggle');
        if (toggle) toggle.checked = false;
        const dot = document.getElementById('liveStatusDot');
        if (dot) dot.classList.remove('active');
      }
    }

    function scrollLogsToBottom() {
      const v = document.getElementById('logViewer');
      if (v) {
        v.scrollTop = v.scrollHeight;
      }
    }

    function exportLogs() {
      if (logState.allLogs.length === 0) {
        toast('No logs to export', 'info');
        return;
      }

      const logText = logState.allLogs.map(l => `[${l.time || ''}] [${l.level}] ${l.message}`).join('\n');
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cliproxy-logs-${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Logs exported successfully', 'success');
    }

    function jumpToNextError() {
      const errorLogs = logState.allLogs.filter(l => l.level === 'ERROR');
      if (errorLogs.length === 0) {
        toast('No errors found', 'info');
        return;
      }
      setLogFilter('ERROR');
      scrollLogsToBottom();
    }

    // Add keyboard shortcuts for logs
    document.addEventListener('keydown', (e) => {
      // Only when logs tab is active
      const logsPage = document.getElementById('page-logs');
      if (!logsPage || !logsPage.classList.contains('active')) return;

      if (e.key === 'Escape') {
        // Clear search on Escape
        const searchInput = document.getElementById('logSearch');
        if (searchInput && searchInput.value) {
          searchInput.value = '';
          filterLogs();
        }
      }
    });

    function clearLogs(confirmed = false) {
      if (!confirmed) {
        document.getElementById('modalTitle').textContent = 'Clear System Logs';
        document.getElementById('modalContent').innerHTML = `
            <div style="text-align:center; padding: 24px 0;">
                <div style="width:64px; height:64px; background:rgba(248, 113, 113, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </div>
                <h4 style="margin-bottom:8px; font-size:18px;">Clear all logs?</h4>
                <p style="color:var(--text-secondary); font-size:14px; max-width:300px; margin:0 auto;">This action will permanently delete the current log history. This cannot be undone.</p>
            </div>
         `;
        document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-danger" onclick="clearLogs(true)">Yes, Clear All</button>
         `;
        document.getElementById('modal').classList.add('active');
        return;
      }

      closeModal();
      api('DELETE', '/logs')
        .then(() => {
          toast('Logs cleared successfully', 'success');
          // Reset log state for fresh start
          logState.latestTimestamp = 0;
          logState.allLogs = [];
          logState.errorCount = 0;
          logState.warnCount = 0;
          loadLogs();
        })
        .catch(e => {
          toast('Failed to clear logs: ' + e.message, 'error');
        });
    }

    document.getElementById('loginKey').addEventListener('keypress', e => {
      if (e.key === 'Enter') login();
    });
    checkAuth();
  </script>
</body>

</html>