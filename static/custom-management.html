<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>CLI Proxy API - Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d0d1a;
      --bg-secondary: #141428;
      --bg-card: rgba(25, 25, 55, 0.8);
      --bg-card-hover: rgba(35, 35, 75, 0.85);
      --bg-input: rgba(10, 10, 25, 0.6);
      --border-color: rgba(140, 140, 220, 0.35);
      --border-glow: rgba(0, 212, 255, 0.4);
      --text-primary: #f0f0ff;
      --text-secondary: #b8b8d8;
      --text-muted: #8888aa;
      --accent-cyan: #00e5ff;
      --accent-purple: #a78bfa;
      --accent-green: #22d3a0;
      --accent-yellow: #fbbf24;
      --accent-red: #f87171;
      --accent-blue: #60a5fa;
      --sidebar-width: 240px;
      --sidebar-collapsed: 64px;
      --header-height: 64px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: var(--bg-primary);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 48px;
      width: 100%;
      max-width: 420px;
      text-align: center;
    }

    .login-card h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-card p {
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15);
      background: rgba(15, 15, 35, 0.8);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid rgba(160, 160, 240, 0.5);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: rgba(40, 40, 80, 0.9);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .btn-danger:hover {
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.4);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .app {
      display: none;
    }

    .app.active {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-color);
      padding: 20px 12px;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      margin-bottom: 24px;
    }

    .sidebar-logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-text {
      font-weight: 600;
      font-size: 16px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(0, 212, 255, 0.1);
      color: var(--accent-cyan);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-secondary);
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      opacity: 0.08;
      transform: translate(30%, -30%);
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .stat-card:hover::before {
      opacity: 0.12;
      transform: translate(25%, -25%) scale(1.1);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-icon svg {
      width: 24px;
      height: 24px;
    }

    .stat-content {
      flex: 1;
      min-width: 0;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .stat-card.cyan::before { background: var(--accent-cyan); }
    .stat-card.cyan .stat-value { color: var(--accent-cyan); }
    .stat-card.cyan .stat-icon { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }

    .stat-card.purple::before { background: var(--accent-purple); }
    .stat-card.purple .stat-value { color: var(--accent-purple); }
    .stat-card.purple .stat-icon { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }

    .stat-card.green::before { background: var(--accent-green); }
    .stat-card.green .stat-value { color: var(--accent-green); }
    .stat-card.green .stat-icon { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }

    .stat-card.yellow::before { background: var(--accent-yellow); }
    .stat-card.yellow .stat-value { color: var(--accent-yellow); }
    .stat-card.yellow .stat-icon { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }

    /* Skeleton Loading Animation */
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .stat-card.loading .stat-value,
    .stat-card.loading .stat-label {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 100%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 4px;
      color: transparent !important;
    }

    .stat-card.loading .stat-value {
      min-width: 60px;
      min-height: 34px;
    }

    .stat-card.loading .stat-label {
      min-width: 100px;
      min-height: 18px;
    }

    /* Dashboard Last Updated */
    .dashboard-last-updated {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 14px;
      background: rgba(20, 20, 40, 0.6);
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .dashboard-last-updated svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    .dashboard-last-updated.refreshing svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Dashboard Header Controls */
    .dashboard-header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Version Badge Styles */
    .version-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .version-badge.up-to-date {
      background: rgba(34, 211, 160, 0.15);
      color: var(--accent-green);
      border: 1px solid rgba(34, 211, 160, 0.3);
    }

    .version-badge.outdated {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-yellow);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .version-badge.unknown {
      background: rgba(136, 136, 170, 0.15);
      color: var(--text-muted);
      border: 1px solid rgba(136, 136, 170, 0.3);
    }

    .version-badge svg {
      width: 12px;
      height: 12px;
    }

    /* Quick Actions Tooltips */
    .quick-action-btn {
      position: relative;
    }

    .quick-action-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(4px);
      background: rgba(0, 0, 0, 0.9);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 400;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      pointer-events: none;
      z-index: 100;
      border: 1px solid var(--border-color);
    }

    .quick-action-btn::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 101;
    }

    .quick-action-btn:hover::after,
    .quick-action-btn:hover::before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .quick-action-btn:hover::before {
      transform: translateX(-50%);
    }

    /* Refresh Button Loading State */
    .btn.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--text-primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    /* Uptime Display */
    .server-uptime {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .uptime-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .uptime-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Dashboard Page Header */
    #page-dashboard .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .dashboard-welcome {
      flex: 1;
    }

    /* Health Indicator */
    .health-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      background: rgba(34, 211, 160, 0.1);
      border: 1px solid rgba(34, 211, 160, 0.3);
      border-radius: 30px;
      transition: all 0.3s;
    }

    .health-indicator.offline {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .health-pulse {
      width: 10px;
      height: 10px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .health-indicator.offline .health-pulse {
      background: var(--accent-red);
      animation: none;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 211, 160, 0.6); }
      70% { box-shadow: 0 0 0 8px rgba(34, 211, 160, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 211, 160, 0); }
    }

    .health-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-green);
    }

    .health-indicator.offline .health-text {
      color: var(--accent-red);
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .quick-action-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    .quick-action-btn span {
      font-size: 13px;
      font-weight: 500;
    }

    .quick-action-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .quick-action-icon svg {
      width: 22px;
      height: 22px;
    }

    .quick-action-btn:hover .quick-action-icon {
      transform: scale(1.1);
    }

    .quick-action-icon.cyan { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }
    .quick-action-icon.purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
    .quick-action-icon.green { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }
    .quick-action-icon.yellow { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }
    .quick-action-icon.blue { background: rgba(96, 165, 250, 0.15); color: var(--accent-blue); }
    .quick-action-icon.red { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }

    /* Server Status Card */
    .server-status-card .card-header {
      margin-bottom: 16px;
    }

    .server-status-card .card-title {
      display: flex;
      align-items: center;
    }

    .server-status-grid {
      display: grid;
      gap: 12px;
    }

    .server-status-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .server-status-item:hover {
      border-color: var(--border-color);
      background: rgba(255, 255, 255, 0.02);
    }

    .status-icon-wrapper {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .status-icon-wrapper svg {
      width: 20px;
      height: 20px;
    }

    .status-icon-wrapper.cyan { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }
    .status-icon-wrapper.purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
    .status-icon-wrapper.green { background: rgba(34, 211, 160, 0.15); color: var(--accent-green); }

    .status-info {
      flex: 1;
      min-width: 0;
    }

    .status-info h4 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .status-info p {
      font-size: 14px;
      color: var(--text-primary);
      margin: 0;
      word-break: break-word;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.04);
    }

    td {
      color: var(--text-primary);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-green {
      background: rgba(34, 211, 160, 0.2);
      color: var(--accent-green);
      border: 1px solid rgba(34, 211, 160, 0.3);
    }

    .badge-yellow {
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .badge-red {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
      border: 1px solid rgba(248, 113, 113, 0.3);
    }

    .badge-cyan {
      background: rgba(0, 229, 255, 0.2);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .badge-purple {
      background: rgba(167, 139, 250, 0.2);
      color: var(--accent-purple);
      border: 1px solid rgba(167, 139, 250, 0.3);
    }

    .badge-blue {
      background: rgba(96, 165, 250, 0.2);
      color: var(--accent-blue);
      border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .date-range-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .date-range-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .date-range-btn.active {
      background: var(--accent-cyan);
      color: #0d0d1a;
    }

    .chart-view-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-view-btn:hover {
      color: var(--text-primary);
    }

    .chart-view-btn.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* ========== Usage Stats Page Styles ========== */
    .usage-page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .usage-header-left {
      flex: 1;
      min-width: 200px;
    }

    .usage-header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .usage-header-title svg {
      color: var(--accent-cyan);
    }

    .usage-header-title h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .usage-header-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0;
    }

    .usage-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .usage-last-updated {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 12px;
      background: rgba(20, 20, 40, 0.6);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .usage-last-updated svg {
      opacity: 0.7;
    }

    .date-range-selector {
      display: flex;
      gap: 4px;
      background: rgba(20, 20, 40, 0.6);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .chart-view-toggle {
      display: flex;
      gap: 2px;
      background: rgba(20, 20, 40, 0.8);
      padding: 3px;
      border-radius: 6px;
    }

    /* Usage Stats Grid */
    .usage-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .usage-stat-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .usage-stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      opacity: 0.06;
      transform: translate(40%, -40%);
      transition: all 0.3s;
    }

    .usage-stat-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    }

    .usage-stat-card:hover::before {
      opacity: 0.1;
      transform: translate(35%, -35%) scale(1.1);
    }

    .usage-stat-card.cyan::before { background: var(--accent-cyan); }
    .usage-stat-card.cyan .usage-stat-value { color: var(--accent-cyan); }
    .usage-stat-card.cyan .usage-stat-icon { background: rgba(0, 229, 255, 0.12); color: var(--accent-cyan); }

    .usage-stat-card.green::before { background: var(--accent-green); }
    .usage-stat-card.green .usage-stat-value { color: var(--accent-green); }
    .usage-stat-card.green .usage-stat-icon { background: rgba(34, 211, 160, 0.12); color: var(--accent-green); }

    .usage-stat-card.red::before { background: var(--accent-red); }
    .usage-stat-card.red .usage-stat-value { color: var(--accent-red); }
    .usage-stat-card.red .usage-stat-icon { background: rgba(248, 113, 113, 0.12); color: var(--accent-red); }

    .usage-stat-card.purple::before { background: var(--accent-purple); }
    .usage-stat-card.purple .usage-stat-value { color: var(--accent-purple); }
    .usage-stat-card.purple .usage-stat-icon { background: rgba(167, 139, 250, 0.12); color: var(--accent-purple); }

    .usage-stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .usage-stat-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .usage-stat-icon svg {
      width: 20px;
      height: 20px;
    }

    .usage-stat-badge {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(0, 229, 255, 0.1);
      color: var(--accent-cyan);
    }

    .usage-rate-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(34, 211, 160, 0.15);
      color: var(--accent-green);
    }

    .usage-rate-indicator.down {
      background: rgba(248, 113, 113, 0.15);
      color: var(--accent-red);
      transform: rotate(180deg);
    }

    .usage-stat-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .usage-stat-label {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .usage-stat-sublabel {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Usage Charts Grid */
    .usage-charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .usage-chart-card {
      background: linear-gradient(145deg, rgba(20, 20, 40, 0.7) 0%, rgba(10, 10, 25, 0.85) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: all 0.3s;
    }

    .usage-chart-card:hover {
      border-color: var(--border-glow);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    }

    .usage-chart-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .usage-chart-info {
      flex: 1;
    }

    .usage-chart-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .usage-chart-title svg {
      color: var(--accent-cyan);
    }

    .usage-chart-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-cyan);
      line-height: 1.2;
    }

    .usage-chart-value.purple {
      color: var(--accent-purple);
    }

    .usage-chart-sublabel {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .usage-chart-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .usage-chart-icon {
      padding: 8px;
      background: rgba(0, 229, 255, 0.1);
      border-radius: 8px;
      color: var(--accent-cyan);
    }

    .usage-chart-icon.purple {
      background: rgba(167, 139, 250, 0.1);
      color: var(--accent-purple);
    }

    .usage-chart-container {
      height: 220px;
      width: 100%;
      position: relative;
    }

    .usage-chart-empty {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-align: center;
      background: rgba(10, 10, 25, 0.5);
      border-radius: 8px;
      z-index: 10;
    }

    .usage-chart-empty svg {
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .usage-chart-empty p {
      font-size: 13px;
      margin: 0;
    }

    /* Responsive adjustments for Usage Stats */
    @media (max-width: 768px) {
      .usage-page-header {
        flex-direction: column;
        align-items: stretch;
      }

      .usage-header-actions {
        justify-content: flex-start;
      }

      .usage-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .usage-charts-grid {
        grid-template-columns: 1fr;
      }

      .usage-stat-value {
        font-size: 26px;
      }
    }

    @media (max-width: 480px) {
      .usage-stats-grid {
        grid-template-columns: 1fr;
      }

      .usage-header-actions {
        flex-wrap: wrap;
      }

      .date-range-selector {
        order: -1;
        width: 100%;
        justify-content: space-between;
      }
    }

    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: rgba(100, 100, 150, 0.3);
      border-radius: 26px;
      transition: all 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .toggle input:checked+.toggle-slider {
      background: var(--accent-cyan);
    }

    .toggle input:checked+.toggle-slider::before {
      transform: translateX(22px);
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .settings-row:last-child {
      border-bottom: none;
    }

    .settings-info h4 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .settings-info p {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab.active {
      color: var(--accent-cyan);
      background: rgba(0, 212, 255, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 100%;
      max-width: 500px;
      margin: 20px;
      /* removed overflow-y: auto and max-height to allow dropdowns to overflow */
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 24px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
    }

    .toast {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-left: 3px solid var(--accent-green);
    }

    .toast.error {
      border-left: 3px solid var(--accent-red);
    }

    .toast.info {
      border-left: 3px solid var(--accent-cyan);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .oauth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .oauth-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid rgba(160, 160, 240, 0.45);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .oauth-btn:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }

    /* Authentication Page Styles */
    .auth-section-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .auth-section-grid {
        grid-template-columns: 1fr;
      }
    }

    .auth-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .auth-card-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .auth-card-icon.cyan {
      background: rgba(0, 229, 255, 0.12);
      color: var(--accent-cyan);
    }

    .auth-card-icon.purple {
      background: rgba(167, 139, 250, 0.12);
      color: var(--accent-purple);
    }

    .auth-card-icon.green {
      background: rgba(34, 211, 160, 0.12);
      color: var(--accent-green);
    }

    .auth-card-icon svg {
      width: 22px;
      height: 22px;
    }

    .auth-card-title h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .auth-card-title p {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* OAuth Provider Cards */
    .auth-oauth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .auth-provider-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .auth-provider-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .auth-provider-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .auth-provider-card:hover::before {
      opacity: 1;
    }

    .auth-provider-card:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15);
    }

    .auth-provider-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .auth-provider-card.anthropic .auth-provider-icon { background: rgba(204, 119, 85, 0.15); border-color: rgba(204, 119, 85, 0.3); }
    .auth-provider-card.gemini .auth-provider-icon { background: rgba(66, 133, 244, 0.15); border-color: rgba(66, 133, 244, 0.3); }
    .auth-provider-card.codex .auth-provider-icon { background: rgba(16, 163, 127, 0.15); border-color: rgba(16, 163, 127, 0.3); }
    .auth-provider-card.antigravity .auth-provider-icon { background: rgba(167, 139, 250, 0.15); border-color: rgba(167, 139, 250, 0.3); }
    .auth-provider-card.qwen .auth-provider-icon { background: rgba(96, 165, 250, 0.15); border-color: rgba(96, 165, 250, 0.3); }
    .auth-provider-card.iflow .auth-provider-icon { background: rgba(34, 211, 160, 0.15); border-color: rgba(34, 211, 160, 0.3); }

    .auth-provider-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .auth-provider-status {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .auth-provider-status .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .auth-provider-card.connected .auth-provider-status .status-dot {
      background: var(--accent-green);
    }

    .auth-provider-card.connected .auth-provider-status {
      color: var(--accent-green);
    }

    /* Auth Dropzone */
    .auth-dropzone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: 40px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      position: relative;
    }

    .auth-dropzone:hover {
      border-color: var(--accent-cyan);
      background: rgba(0, 229, 255, 0.03);
    }

    .auth-dropzone.dragover {
      border-color: var(--accent-cyan);
      background: rgba(0, 229, 255, 0.08);
      transform: scale(1.01);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.15);
    }

    .auth-dropzone-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.1), rgba(167, 139, 250, 0.1));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-cyan);
    }

    .auth-dropzone-icon svg {
      width: 28px;
      height: 28px;
    }

    .auth-dropzone-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .auth-dropzone-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .auth-dropzone-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      border-radius: var(--radius-sm);
      color: var(--accent-cyan);
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .auth-dropzone:hover .auth-dropzone-btn {
      background: rgba(0, 229, 255, 0.15);
      border-color: var(--accent-cyan);
    }

    .auth-dropzone-formats {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .auth-upload-status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      display: none;
    }

    .auth-upload-status.show {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-upload-status.uploading {
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      color: var(--accent-cyan);
    }

    .auth-upload-status.success {
      background: rgba(34, 211, 160, 0.1);
      border: 1px solid rgba(34, 211, 160, 0.3);
      color: var(--accent-green);
    }

    .auth-upload-status.error {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--accent-red);
    }

    .auth-upload-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Auth Files Table Enhanced */
    .auth-table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
    }

    .auth-table {
      width: 100%;
      border-collapse: collapse;
    }

    .auth-table thead {
      background: rgba(0, 0, 0, 0.2);
    }

    .auth-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
    }

    .auth-table td {
      padding: 16px;
      border-bottom: 1px solid rgba(140, 140, 220, 0.15);
      vertical-align: middle;
    }

    .auth-table tbody tr {
      transition: all 0.2s;
    }

    .auth-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .auth-table tbody tr:last-child td {
      border-bottom: none;
    }

    .auth-provider-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-provider-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: rgba(167, 139, 250, 0.15);
      flex-shrink: 0;
    }

    .auth-identity-cell {
      max-width: 200px;
    }

    .auth-identity-email {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .auth-identity-filename {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .auth-metrics {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .auth-metric {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .auth-metric.requests {
      background: rgba(0, 229, 255, 0.1);
      color: var(--accent-cyan);
    }

    .auth-metric.failed {
      background: rgba(248, 113, 113, 0.1);
      color: var(--accent-red);
    }

    .auth-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .auth-status-badge.active {
      background: rgba(34, 211, 160, 0.12);
      color: var(--accent-green);
    }

    .auth-status-badge.expired {
      background: rgba(248, 113, 113, 0.12);
      color: var(--accent-red);
    }

    .auth-status-badge.expiring {
      background: rgba(251, 191, 36, 0.12);
      color: var(--accent-yellow);
    }

    .auth-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .auth-actions {
      display: flex;
      gap: 6px;
    }

    .auth-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .auth-action-btn:hover {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
      background: rgba(0, 229, 255, 0.1);
    }

    .auth-action-btn.danger:hover {
      border-color: var(--accent-red);
      color: var(--accent-red);
      background: rgba(248, 113, 113, 0.1);
    }

    .auth-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .auth-table-empty {
      padding: 48px 24px;
      text-align: center;
    }

    .auth-table-empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      border-radius: 50%;
      background: rgba(140, 140, 220, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .auth-table-empty-icon svg {
      width: 28px;
      height: 28px;
    }

    .auth-table-empty h4 {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .auth-table-empty p {
      font-size: 13px;
      color: var(--text-muted);
    }

    .code-editor {
      width: 100%;
      min-height: 400px;
      padding: 16px;
      background: rgba(5, 5, 15, 0.7);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: #e0e0f0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
    }

    .code-editor:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.1);
    }

    /* Log Viewer Enhanced Styles */
    .log-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
      background: var(--bg-card);
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }

    .log-filter-group {
      display: flex;
      gap: 4px;
      background: rgba(0, 0, 0, 0.2);
      padding: 4px;
      border-radius: var(--radius-sm);
    }

    .log-filter-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .log-filter-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .log-filter-btn.active {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .log-filter-btn.active.filter-error {
      color: var(--accent-red);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .log-filter-btn.active.filter-warn {
      color: var(--accent-yellow);
      border-color: rgba(251, 191, 36, 0.3);
    }

    .log-filter-btn.active.filter-info {
      color: var(--accent-blue);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .log-filter-btn.active.filter-debug {
      color: var(--accent-green);
      border-color: rgba(34, 211, 160, 0.3);
    }

    .log-search-container {
      flex: 1;
      position: relative;
      min-width: 200px;
    }

    .log-search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .log-search-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.1);
    }

    .log-search-input.regex-error {
      border-color: var(--accent-red);
      box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.15);
    }

    .log-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      width: 16px;
      height: 16px;
      transition: color 0.2s;
    }

    .log-search-container.has-error .log-search-icon {
      color: var(--accent-red);
    }

    .log-regex-error {
      position: absolute;
      bottom: -20px;
      left: 0;
      font-size: 11px;
      color: var(--accent-red);
      display: none;
    }

    .log-regex-error.visible {
      display: block;
    }

    /* Log Statistics Bar */
    .log-stats-bar {
      display: flex;
      gap: 16px;
      padding: 10px 16px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
      flex-wrap: wrap;
    }

    .log-stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
    }

    .log-stat-item .stat-value {
      font-weight: 600;
      font-size: 13px;
    }

    .log-stat-item.errors .stat-value { color: var(--accent-red); }
    .log-stat-item.warnings .stat-value { color: var(--accent-yellow); }
    .log-stat-item.info .stat-value { color: var(--accent-blue); }
    .log-stat-item.debug .stat-value { color: var(--accent-green); }

    .log-stat-divider {
      width: 1px;
      height: 16px;
      background: var(--border-color);
    }

    /* Time Range Filters */
    .log-time-filters {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .log-time-btn {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .log-time-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .log-time-btn.active {
      background: rgba(0, 229, 255, 0.1);
      color: var(--accent-cyan);
      border-color: rgba(0, 229, 255, 0.3);
    }

    .terminal-window {
      background: #09090b;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      height: calc(100vh - 220px);
      min-height: 450px;
    }

    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
      position: relative;
    }

    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: #181825;
      border-bottom: 1px solid var(--border-color);
    }

    .terminal-title {
      font-size: 12px;
      color: var(--text-secondary);
      font-family: 'Monaco', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .terminal-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s;
    }

    .status-dot.active {
      background: var(--accent-green);
      box-shadow: 0 0 8px rgba(34, 211, 160, 0.6);
      animation: statusPulse 2s infinite;
    }

    .log-viewer-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      scroll-behavior: smooth;
      position: relative;
    }

    .log-entry {
      display: grid;
      grid-template-columns: 85px 60px 1fr;
      gap: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: all 0.15s ease;
      align-items: start;
      border-left: 3px solid transparent;
      cursor: pointer;
      position: relative;
    }

    .log-entry:hover {
      background: rgba(255, 255, 255, 0.04);
      transform: translateX(2px);
    }

    .log-entry:hover::after {
      content: 'Click to copy  Double-click for details';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-muted);
      opacity: 0.7;
      pointer-events: none;
    }

    .log-entry.copied {
      background: rgba(0, 229, 255, 0.15) !important;
    }

    .log-entry.copied::after {
      content: ' Copied!' !important;
      color: var(--accent-cyan);
      opacity: 1;
    }

    .log-time {
      color: #6c7086;
      font-size: 11px;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    .log-lvl {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 4px;
      text-align: center;
      width: fit-content;
      letter-spacing: 0.5px;
    }

    .log-lvl.info {
      color: #89b4fa;
      background: rgba(137, 180, 250, 0.15);
    }

    .log-lvl.warn {
      color: #f9e2af;
      background: rgba(249, 226, 175, 0.15);
    }

    .log-lvl.error {
      color: #f38ba8;
      background: rgba(243, 139, 168, 0.15);
    }

    .log-lvl.debug {
      color: #a6e3a1;
      background: rgba(166, 227, 161, 0.15);
    }

    .log-msg {
      color: #cdd6f4;
      word-break: break-word;
      white-space: pre-wrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 60px;
    }

    .log-msg.expanded {
      max-height: none;
    }

    .log-entry.error {
      border-left-color: var(--accent-red);
      background: rgba(248, 113, 113, 0.06);
    }

    .log-entry.warn {
      border-left-color: var(--accent-yellow);
      background: rgba(251, 191, 36, 0.06);
    }

    .log-entry.info {
      border-left-color: transparent;
    }

    .log-entry.debug {
      border-left-color: rgba(34, 211, 160, 0.3);
    }

    /* Scrollbar customization for logs */
    .log-viewer-content::-webkit-scrollbar {
      width: 10px;
    }

    .log-viewer-content::-webkit-scrollbar-track {
      background: #09090b;
    }

    .log-viewer-content::-webkit-scrollbar-thumb {
      background: #313244;
      border-radius: 5px;
      border: 2px solid #09090b;
    }

    .log-viewer-content::-webkit-scrollbar-thumb:hover {
      background: #45475a;
    }

    .empty-logs {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      gap: 12px;
      opacity: 0.7;
    }

    .log-count-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 10px;
      margin-left: 4px;
      min-width: 18px;
      text-align: center;
    }

    .log-count-badge.error {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
    }

    .log-count-badge.warn {
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
    }

    /* Scroll to bottom indicator */
    .scroll-bottom-btn {
      position: absolute;
      bottom: 20px;
      right: 30px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .scroll-bottom-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
      transform: translateY(-2px);
    }

    .scroll-bottom-btn.visible {
      display: flex;
    }

    .scroll-bottom-btn .new-logs-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent-cyan);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
    }

    /* Log Detail Modal Styles */
    .log-detail-content {
      padding: 0;
    }

    .log-detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border-color);
    }

    .log-detail-level {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .log-detail-level.error { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
    .log-detail-level.warn { background: rgba(251, 191, 36, 0.2); color: var(--accent-yellow); }
    .log-detail-level.info { background: rgba(96, 165, 250, 0.2); color: var(--accent-blue); }
    .log-detail-level.debug { background: rgba(34, 211, 160, 0.2); color: var(--accent-green); }

    .log-detail-time {
      color: var(--text-secondary);
      font-size: 13px;
      font-family: monospace;
    }

    .log-detail-body {
      padding: 20px;
    }

    .log-detail-message {
      background: #09090b;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: #cdd6f4;
      max-height: 400px;
      overflow-y: auto;
    }

    .log-detail-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* Loading spinner for refresh */
    .btn.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes statusPulse {
      0% { opacity: 1; box-shadow: 0 0 8px rgba(34, 211, 160, 0.6); }
      50% { opacity: 0.6; box-shadow: 0 0 4px rgba(34, 211, 160, 0.3); }
      100% { opacity: 1; box-shadow: 0 0 8px rgba(34, 211, 160, 0.6); }
    }

    /* Truncation notice */
    .log-truncation-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(251, 191, 36, 0.1);
      border-top: 1px solid rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
      font-size: 12px;
    }

    .log-truncation-notice svg {
      width: 14px;
      height: 14px;
    }

    /* Keyboard shortcuts help */
    .log-shortcuts-hint {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .log-shortcuts-hint kbd {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 10px;
      border: 1px solid var(--border-color);
    }

    /* Models Page Styles */
    .models-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .models-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .models-icon-box {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.15), rgba(167, 139, 250, 0.15));
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .models-icon-box svg {
      width: 24px;
      height: 24px;
      color: var(--accent-cyan);
    }

    .models-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .models-total-count {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.15), rgba(167, 139, 250, 0.15));
      color: var(--accent-cyan);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .models-toolbar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .models-search-container {
      position: relative;
      flex: 1;
      min-width: 280px;
      max-width: 500px;
    }

    .models-search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .models-search-input {
      width: 100%;
      padding: 12px 44px 12px 44px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .models-search-input::placeholder {
      color: var(--text-muted);
    }

    .models-search-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.1);
      background: var(--bg-secondary);
    }

    .models-search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .models-search-clear:hover {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
    }

    .models-search-clear svg {
      width: 14px;
      height: 14px;
    }

    .models-filter-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .models-filter-pill {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .models-filter-pill:hover {
      border-color: var(--accent-cyan);
      color: var(--text-primary);
      background: rgba(0, 229, 255, 0.05);
    }

    .models-filter-pill.active {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
    }

    .models-grid-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .models-provider-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: all 0.3s;
    }

    .models-provider-card:hover {
      border-color: var(--border-glow);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .models-provider-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }

    .models-provider-header:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    .models-provider-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .models-provider-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .models-provider-icon.anthropic { background: rgba(255, 165, 0, 0.15); }
    .models-provider-icon.google { background: rgba(66, 133, 244, 0.15); }
    .models-provider-icon.openai { background: rgba(0, 166, 126, 0.15); }
    .models-provider-icon.other { background: rgba(167, 139, 250, 0.15); }

    .models-provider-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: capitalize;
    }

    .models-provider-count {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .models-provider-toggle {
      color: var(--text-muted);
      transition: transform 0.3s;
    }

    .models-provider-toggle svg {
      width: 20px;
      height: 20px;
    }

    .models-provider-card.collapsed .models-provider-toggle {
      transform: rotate(-90deg);
    }

    .models-provider-card.collapsed .models-list {
      display: none;
    }

    .models-list {
      padding: 16px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .model-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(167, 139, 250, 0.1);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .model-badge:hover {
      background: rgba(167, 139, 250, 0.2);
      border-color: var(--accent-purple);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 139, 250, 0.2);
    }

    .model-badge:active {
      transform: translateY(0);
    }

    .model-badge .copy-icon {
      width: 14px;
      height: 14px;
      color: var(--text-muted);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .model-badge:hover .copy-icon {
      opacity: 1;
    }

    .model-badge.copied {
      background: rgba(34, 211, 160, 0.2) !important;
      border-color: var(--accent-green) !important;
    }

    .model-badge.copied::after {
      content: 'Copied!';
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-green);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .models-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 16px;
    }

    .models-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 229, 255, 0.2);
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .models-loading p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .models-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
    }

    .models-empty-icon {
      width: 64px;
      height: 64px;
      background: rgba(251, 191, 36, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }

    .models-empty-icon svg {
      width: 32px;
      height: 32px;
      color: var(--accent-yellow);
    }

    .models-empty h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .models-empty p {
      color: var(--text-secondary);
      font-size: 13px;
      text-align: center;
      max-width: 300px;
    }

    /* API Keys Page Styles */
    .keys-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .keys-page-header .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keys-page-header .page-title svg {
      width: 28px;
      height: 28px;
      color: var(--accent-cyan);
    }

    .keys-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 6px;
      background: rgba(20, 20, 45, 0.6);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      width: fit-content;
    }

    .keys-tab {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
    }

    .keys-tab svg {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }

    .keys-tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.06);
    }

    .keys-tab.active {
      color: white;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }

    .keys-tab.active svg {
      opacity: 1;
    }

    .keys-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .keys-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .keys-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .keys-section-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keys-section-title h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .keys-section-title .key-count {
      background: rgba(0, 229, 255, 0.15);
      color: var(--accent-cyan);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .keys-grid {
      display: grid;
      gap: 12px;
    }

    .key-card {
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.9), rgba(25, 25, 55, 0.95));
      border: 1px solid rgba(160, 160, 240, 0.25);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .key-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent-cyan), var(--accent-purple));
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .key-card:hover {
      border-color: rgba(0, 229, 255, 0.4);
      transform: translateX(4px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .key-card:hover::before {
      opacity: 1;
    }

    .key-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.15), rgba(167, 139, 250, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .key-icon svg {
      width: 20px;
      height: 20px;
      color: var(--accent-cyan);
    }

    .key-info {
      flex: 1;
      min-width: 0;
    }

    .key-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .key-actions {
      display: flex;
      gap: 8px;
    }

    .key-action-btn {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid transparent;
    }

    .key-action-btn.copy {
      background: rgba(34, 211, 160, 0.15);
      color: var(--accent-green);
      border-color: rgba(34, 211, 160, 0.3);
    }

    .key-action-btn.copy:hover {
      background: rgba(34, 211, 160, 0.25);
      box-shadow: 0 0 12px rgba(34, 211, 160, 0.2);
    }

    .key-action-btn.delete {
      background: rgba(248, 113, 113, 0.15);
      color: var(--accent-red);
      border-color: rgba(248, 113, 113, 0.3);
    }

    .key-action-btn.delete:hover {
      background: rgba(248, 113, 113, 0.25);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.2);
    }

    .key-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .key-action-btn.reveal {
      background: rgba(96, 165, 250, 0.15);
      color: var(--accent-blue);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .key-action-btn.reveal:hover {
      background: rgba(96, 165, 250, 0.25);
      box-shadow: 0 0 12px rgba(96, 165, 250, 0.2);
    }

    .key-value-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .key-value {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .key-value.revealed {
      color: var(--accent-green);
    }

    .key-index {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      background: rgba(0, 229, 255, 0.1);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-cyan);
      flex-shrink: 0;
    }

    .keys-tab .tab-badge {
      background: rgba(0, 229, 255, 0.2);
      color: var(--accent-cyan);
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
    }

    .keys-tab.active .tab-badge {
      background: rgba(255, 255, 255, 0.25);
      color: white;
    }

    @keyframes keyCardEnter {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .key-card {
      animation: keyCardEnter 0.3s ease forwards;
    }

    .key-card:nth-child(1) { animation-delay: 0ms; }
    .key-card:nth-child(2) { animation-delay: 50ms; }
    .key-card:nth-child(3) { animation-delay: 100ms; }
    .key-card:nth-child(4) { animation-delay: 150ms; }
    .key-card:nth-child(5) { animation-delay: 200ms; }

    .keys-bulk-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .btn-bulk {
      padding: 8px 14px;
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-bulk:hover {
      background: rgba(40, 40, 80, 0.9);
      border-color: var(--accent-cyan);
      color: var(--text-primary);
    }

    .btn-bulk.danger:hover {
      border-color: var(--accent-red);
      color: var(--accent-red);
    }

    .btn-bulk svg {
      width: 14px;
      height: 14px;
    }

    .key-format-hint {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(0, 229, 255, 0.08);
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .key-format-hint svg {
      width: 18px;
      height: 18px;
      color: var(--accent-cyan);
      flex-shrink: 0;
    }

    .key-format-hint code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      color: var(--accent-cyan);
    }

    .keys-empty-state {
      text-align: center;
      padding: 48px 24px;
      background: linear-gradient(135deg, rgba(25, 25, 55, 0.5), rgba(20, 20, 45, 0.6));
      border: 1px dashed rgba(160, 160, 240, 0.3);
      border-radius: var(--radius-lg);
    }

    .keys-empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .keys-empty-state h4 {
      color: var(--text-secondary);
      font-size: 16px;
      margin-bottom: 8px;
    }

    .keys-empty-state p {
      color: var(--text-muted);
      font-size: 13px;
      max-width: 280px;
      margin: 0 auto;
    }

    .btn-add-key {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.25);
    }

    .btn-add-key:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.35);
    }

    .btn-add-key svg {
      width: 16px;
      height: 16px;
    }

    /* Configuration Page Styles */
    .config-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .config-page-header .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .config-page-header .page-title svg {
      width: 28px;
      height: 28px;
      color: var(--accent-purple);
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
    }

    .config-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .config-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.6), rgba(25, 25, 55, 0.4));
      border-bottom: 1px solid var(--border-color);
    }

    .config-section-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(0, 229, 255, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .config-section-icon svg {
      width: 20px;
      height: 20px;
      color: var(--accent-purple);
    }

    .config-section-icon.cyan svg {
      color: var(--accent-cyan);
    }

    .config-section-title h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .config-section-title p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .config-settings-list {
      padding: 8px 0;
    }

    .config-setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .config-setting-item:hover {
      background: rgba(255, 255, 255, 0.03);
      border-left-color: var(--accent-cyan);
    }

    .config-setting-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .config-setting-icon {
      width: 36px;
      height: 36px;
      background: rgba(100, 100, 150, 0.15);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .config-setting-icon svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    .config-setting-text h4 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .config-setting-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Enhanced Toggle Switch */
    .toggle-enhanced {
      position: relative;
      width: 52px;
      height: 28px;
      cursor: pointer;
    }

    .toggle-enhanced input {
      display: none;
    }

    .toggle-enhanced-slider {
      position: absolute;
      inset: 0;
      background: rgba(80, 80, 120, 0.4);
      border-radius: 28px;
      transition: all 0.3s ease;
      border: 1px solid rgba(120, 120, 180, 0.3);
    }

    .toggle-enhanced-slider::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      left: 2px;
      top: 2px;
      background: linear-gradient(135deg, #fff, #e8e8f0);
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-enhanced input:checked+.toggle-enhanced-slider {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-color: transparent;
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    .toggle-enhanced input:checked+.toggle-enhanced-slider::before {
      transform: translateX(24px);
    }

    /* Toggle Loading State */
    .toggle-enhanced.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .toggle-enhanced.loading .toggle-enhanced-slider::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      left: 6px;
      top: 6px;
      border: 2px solid transparent;
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: toggle-spin 0.6s linear infinite;
    }

    .toggle-enhanced.loading input:checked+.toggle-enhanced-slider::after {
      left: auto;
      right: 6px;
    }

    @keyframes toggle-spin {
      to { transform: rotate(360deg); }
    }

    /* Toggle Success Flash */
    .toggle-enhanced.success .toggle-enhanced-slider {
      animation: toggle-success 0.4s ease-out;
    }

    @keyframes toggle-success {
      0%, 100% { box-shadow: none; }
      50% { box-shadow: 0 0 20px rgba(34, 211, 160, 0.5); }
    }

    /* Config Setting Item Hover Enhancement */
    .config-setting-item {
      position: relative;
    }

    .config-setting-item::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: transparent;
      transition: background 0.2s;
    }

    .config-setting-item:hover::after {
      background: var(--accent-cyan);
    }

    /* Config Setting Status Indicator */
    .config-setting-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.2s;
    }

    .setting-status-dot.enabled {
      background: var(--accent-green);
      box-shadow: 0 0 8px rgba(34, 211, 160, 0.4);
    }

    /* Config Editor Toolbar */
    .config-editor-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(10, 10, 25, 0.6);
      border-bottom: 1px solid var(--border-color);
    }

    .config-editor-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .config-editor-info span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .config-editor-info svg {
      width: 14px;
      height: 14px;
    }

    .config-unsaved-indicator {
      display: none;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 20px;
      font-size: 11px;
      color: var(--accent-yellow);
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .config-unsaved-indicator.visible {
      display: flex;
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .config-unsaved-indicator svg {
      width: 12px;
      height: 12px;
    }

    /* Config Action Buttons */
    .config-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .btn-config-action {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-config-action:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-cyan);
      color: var(--text-primary);
    }

    .btn-config-action svg {
      width: 14px;
      height: 14px;
    }

    .btn-config-action.saving {
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-config-action.saving svg {
      animation: toggle-spin 0.6s linear infinite;
    }

    /* YAML Validation Error */
    .yaml-error-banner {
      display: none;
      padding: 12px 16px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 8px;
      margin: 12px 16px 0;
      font-size: 13px;
      color: var(--accent-red);
    }

    .yaml-error-banner.visible {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .yaml-error-banner svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .yaml-error-banner .error-details {
      flex: 1;
    }

    .yaml-error-banner .error-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .yaml-error-banner .error-message {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      opacity: 0.9;
    }

    /* Config Section Quick Status */
    .config-section-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(34, 211, 160, 0.1);
      border-radius: 20px;
      font-size: 11px;
      color: var(--accent-green);
      margin-left: auto;
    }

    .config-section-status svg {
      width: 12px;
      height: 12px;
    }

    /* Tooltip styles */
    .config-tooltip {
      position: relative;
      cursor: help;
    }

    .config-tooltip::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: rgba(20, 20, 40, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .config-tooltip::after {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(20, 20, 40, 0.95);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .config-tooltip:hover::before,
    .config-tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* Config Editor Section */
    .config-editor-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .config-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(30, 30, 65, 0.6), rgba(25, 25, 55, 0.4));
      border-bottom: 1px solid var(--border-color);
    }

    .config-editor-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .config-editor-title .icon-box {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.2), rgba(167, 139, 250, 0.15));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .config-editor-title .icon-box svg {
      width: 20px;
      height: 20px;
      color: var(--accent-cyan);
    }

    .config-editor-title h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .config-editor-title p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .btn-save-config {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent-green), #1a9a7a);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 15px rgba(34, 211, 160, 0.25);
    }

    .btn-save-config:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 211, 160, 0.35);
    }

    .btn-save-config svg {
      width: 16px;
      height: 16px;
    }

    .config-editor-content {
      padding: 0;
    }

    .config-editor-content .code-editor {
      border: none;
      border-radius: 0;
      min-height: 350px;
      background: rgba(5, 5, 15, 0.5);
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      padding: 0 16px;
      align-items: center;
      gap: 12px;
      z-index: 101;
    }

    .hamburger-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .hamburger-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent-cyan);
    }

    .hamburger-btn svg {
      width: 20px;
      height: 20px;
    }

    .mobile-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 15px;
    }

    .mobile-logo .sidebar-logo-icon {
      width: 32px;
      height: 32px;
      font-size: 13px;
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 99;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }

    /* Tablet breakpoint */
    @media (max-width: 1024px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }

      .sidebar-logo-text,
      .nav-item span {
        display: none;
      }

      .main {
        margin-left: var(--sidebar-collapsed);
      }

      .quick-actions-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      /* Show mobile header, hide sidebar by default */
      .mobile-header {
        display: flex;
      }

      .sidebar {
        width: 260px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .sidebar.mobile-open .sidebar-logo-text,
      .sidebar.mobile-open .nav-item span {
        display: inline;
      }

      .main {
        margin-left: 0;
        padding-top: 72px;
        padding-left: 16px;
        padding-right: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .page-title {
        font-size: 20px;
      }

      .card {
        padding: 16px;
      }

      /* Dashboard header mobile */
      #page-dashboard .page-header {
        flex-direction: column;
        align-items: stretch;
      }

      .dashboard-header-controls {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .dashboard-last-updated {
        font-size: 11px;
        padding: 6px 10px;
      }

      .health-indicator {
        align-self: flex-start;
      }

      /* Quick action tooltips - hide on mobile (touch) */
      .quick-action-btn::after,
      .quick-action-btn::before {
        display: none;
      }

      /* Server status mobile */
      .server-status-item {
        flex-wrap: wrap;
        gap: 10px;
      }

      .version-badge {
        order: 3;
        margin-top: 4px;
      }

      /* Auth page mobile styles */
      .auth-section-grid {
        grid-template-columns: 1fr;
      }

      .auth-oauth-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .auth-provider-card {
        padding: 16px 12px;
      }

      .auth-provider-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .auth-dropzone {
        padding: 30px 16px;
      }

      .auth-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .auth-table {
        min-width: 700px;
      }

      .auth-action-btn {
        width: 28px;
        height: 28px;
      }

      .auth-card-header {
        flex-wrap: wrap;
        gap: 8px;
      }

      /* Tables responsive */
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Modal responsive */
      .modal-content {
        width: 95%;
        max-width: none;
        margin: 10px;
        max-height: 90vh;
      }

      /* Amp page mobile */
      .amp-hero {
        flex-direction: column;
        padding: 24px;
        text-align: center;
      }

      .amp-hero-content {
        max-width: 100%;
      }

      .amp-grid {
        grid-template-columns: 1fr;
      }

      /* Logs page mobile */
      .log-entry {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .main {
        padding-left: 12px;
        padding-right: 12px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .quick-actions-grid {
        grid-template-columns: 1fr 1fr;
      }

      .stat-card {
        padding: 16px;
      }

      .stat-value {
        font-size: 24px;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
      }

      .auth-oauth-grid {
        grid-template-columns: 1fr;
      }

      .auth-provider-card {
        flex-direction: row;
        padding: 14px 16px;
        gap: 14px;
      }

      .auth-provider-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .auth-provider-name {
        font-size: 13px;
      }

      .auth-provider-status {
        display: none;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .auth-dropzone-btn {
        padding: 8px 16px;
        font-size: 12px;
      }

      .btn {
        padding: 12px 16px;
        font-size: 13px;
      }

      .page-title {
        font-size: 18px;
      }

      .page-subtitle {
        font-size: 13px;
      }

      /* Login card mobile */
      .login-card {
        padding: 32px 24px;
      }

      .login-card h1 {
        font-size: 20px;
      }
    }

    /* ========== Enhanced Mobile UX Improvements ========== */
    
    /* Safe area insets for notched devices (iPhone X+) */
    @supports (padding: max(0px)) {
      .mobile-header {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
      }
      
      .toast-container {
        bottom: max(24px, env(safe-area-inset-bottom));
        right: max(16px, env(safe-area-inset-right));
      }
      
      .main {
        padding-bottom: max(24px, env(safe-area-inset-bottom));
      }
      
      .sidebar {
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
    }

    /* Improved toast positioning on mobile */
    @media (max-width: 768px) {
      .toast-container {
        left: 16px;
        right: 16px;
        bottom: 16px;
      }
      
      .toast {
        min-width: auto;
        width: 100%;
      }
    }

    /* Touch-friendly minimum tap targets (44px per Apple HIG) */
    @media (max-width: 768px) {
      .btn {
        min-height: 44px;
      }
      
      .form-input {
        min-height: 48px;
        font-size: 16px; /* Prevents iOS zoom on focus */
      }
      
      .date-range-btn {
        min-height: 40px;
        padding: 8px 14px;
      }
      
      .chart-view-btn {
        min-height: 36px;
        padding: 6px 12px;
      }
      
      .toggle {
        width: 52px;
        height: 30px;
      }
      
      .toggle-slider::before {
        width: 24px;
        height: 24px;
      }
      
      .toggle input:checked+.toggle-slider::before {
        transform: translateX(22px);
      }
    }

    /* Horizontal scrollable tabs on mobile */
    @media (max-width: 768px) {
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        flex-wrap: nowrap;
        padding-bottom: 8px;
        margin-bottom: 16px;
      }
      
      .tabs::-webkit-scrollbar {
        display: none;
      }
      
      .tab {
        flex-shrink: 0;
        white-space: nowrap;
      }
    }

    /* Horizontal scrollable filter pills on mobile */
    @media (max-width: 768px) {
      .models-filters {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding-bottom: 4px;
      }
      
      .models-filters::-webkit-scrollbar {
        display: none;
      }
      
      .models-filter-pills {
        flex-wrap: nowrap;
      }
      
      .models-filter-pill {
        flex-shrink: 0;
      }
    }

    /* Improved modal on mobile */
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 12px;
        align-items: flex-end;
      }
      
      .modal {
        margin: 0;
        max-width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        padding: 24px 20px;
      }
      
      .modal-header {
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        margin: -24px -20px 20px -20px;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        z-index: 1;
      }
      
      .modal-footer {
        flex-direction: column;
        gap: 8px;
      }
      
      .modal-footer .btn {
        width: 100%;
      }
    }

    /* Better card header on mobile */
    @media (max-width: 600px) {
      .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .card-header .btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Settings row touch-friendly */
    @media (max-width: 768px) {
      .settings-row {
        padding: 20px 0;
      }
      
      .settings-info h4 {
        font-size: 15px;
      }
      
      .settings-info p {
        font-size: 14px;
      }
    }

    /* Date range selector on mobile */
    @media (max-width: 480px) {
      .date-range-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
      }
      
      .date-range-btn {
        text-align: center;
      }
    }

    /* Model badges on mobile - prevent text overflow */
    @media (max-width: 480px) {
      .models-list {
        padding: 12px;
      }
      
      .model-badge {
        max-width: 100%;
        overflow: hidden;
      }
      
      .model-badge span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    /* OAuth grid on mobile */
    @media (max-width: 480px) {
      .oauth-grid {
        grid-template-columns: 1fr;
      }
      
      .oauth-btn {
        padding: 14px 16px;
      }
    }

    /* Config section on mobile */
    @media (max-width: 480px) {
      .config-section-header {
        padding: 16px;
      }
      
      .config-setting-item {
        padding: 14px 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .config-setting-value {
        width: 100%;
      }
    }

    /* Server status items on mobile */
    @media (max-width: 480px) {
      .server-status-item {
        padding: 12px;
      }
      
      .status-info p {
        font-size: 13px;
        word-break: break-all;
      }
    }

    /* Better table scroll indicators */
    @media (max-width: 768px) {
      .table-container {
        position: relative;
      }
      
      .table-container::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(to right, transparent, var(--bg-primary));
        pointer-events: none;
        opacity: 0.8;
      }
    }

    /* Prevent horizontal overflow */
    @media (max-width: 768px) {
      .page {
        overflow-x: hidden;
      }
    }

    /* Amp Page Styles */
    .amp-hero {
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.1), rgba(167, 139, 250, 0.1));
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      position: relative;
      overflow: hidden;
    }

    .amp-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(0, 229, 255, 0.05) 0%, transparent 50%);
      animation: rotate 20s linear infinite;
    }

    .amp-hero-content {
      position: relative;
      z-index: 1;
      max-width: 600px;
    }

    .amp-hero h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--text-primary), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .amp-hero p {
      color: var(--text-secondary);
      font-size: 16px;
      line-height: 1.6;
    }

    /* Connection Status Indicator */
    .amp-connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .amp-connection-status.connected {
      background: rgba(34, 211, 160, 0.1);
      border: 1px solid rgba(34, 211, 160, 0.3);
      color: var(--accent-green);
    }

    .amp-connection-status.disconnected {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--accent-red);
    }

    .amp-connection-status.checking {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: var(--accent-yellow);
    }

    .amp-connection-status.not-configured {
      background: rgba(136, 136, 170, 0.1);
      border: 1px solid rgba(136, 136, 170, 0.3);
      color: var(--text-muted);
    }

    .amp-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .amp-connection-status.connected .amp-status-dot {
      animation: pulse 2s infinite;
    }

    .amp-connection-status.checking .amp-status-dot {
      animation: blink 0.6s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--text-muted);
      transition: color 0.2s;
      pointer-events: none;
    }

    .input-with-icon .form-input {
      padding-left: 44px;
    }

    .input-with-icon .form-input:focus~.input-icon {
      color: var(--accent-cyan);
    }

    /* Password toggle button */
    .password-toggle-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      z-index: 2;
    }

    .password-toggle-btn:hover {
      color: var(--accent-cyan);
    }

    .password-toggle-btn svg {
      width: 18px;
      height: 18px;
    }

    .input-with-icon.has-toggle .form-input {
      padding-right: 44px;
    }

    /* Amp action buttons */
    .amp-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .btn-save-amp {
      flex: 1;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      box-shadow: 0 4px 15px rgba(0, 229, 255, 0.2);
      color: #fff;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-save-amp:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(0, 229, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-save-amp:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn-save-amp.saving {
      pointer-events: none;
    }

    .btn-test-connection {
      padding: 14px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-test-connection:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent-cyan);
      color: var(--text-primary);
    }

    .btn-test-connection:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-test-connection.testing {
      pointer-events: none;
    }

    /* Mappings section */
    .mappings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 12px;
    }

    .mappings-search {
      position: relative;
      width: 220px;
    }

    .mappings-search input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      transition: all 0.2s;
    }

    .mappings-search input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      background: rgba(15, 15, 35, 0.8);
    }

    .mappings-search input::placeholder {
      color: var(--text-muted);
    }

    .mappings-search svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .mappings-list {
      display: grid;
      gap: 12px;
    }

    .mapping-card {
      background: rgba(20, 20, 40, 0.5);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      transition: all 0.2s;
    }

    .mapping-card:hover {
      border-color: var(--accent-cyan);
      background: rgba(30, 30, 60, 0.6);
    }

    .mapping-card.hidden {
      display: none;
    }

    .mapping-flow {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .mapping-source,
    .mapping-target {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.3);
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.2s;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mapping-source:hover,
    .mapping-target:hover {
      background: rgba(0, 229, 255, 0.1);
      border-color: var(--accent-cyan);
    }

    .mapping-source.copied,
    .mapping-target.copied {
      background: rgba(34, 211, 160, 0.2);
      border-color: var(--accent-green);
    }

    .mapping-arrow {
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .mapping-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .mapping-card:hover .mapping-actions {
      opacity: 1;
    }

    .mapping-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.05);
    }

    .mapping-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .mapping-action-btn.edit {
      color: var(--accent-cyan);
    }

    .mapping-action-btn.edit:hover {
      background: rgba(0, 229, 255, 0.15);
      border-color: var(--accent-cyan);
    }

    .mapping-action-btn.delete {
      color: var(--accent-red);
    }

    .mapping-action-btn.delete:hover {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--accent-red);
    }

    /* Setting tooltip styles */
    .setting-info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 6px;
      color: var(--text-muted);
      cursor: help;
      position: relative;
    }

    .setting-info-icon svg {
      width: 14px;
      height: 14px;
    }

    .setting-info-icon:hover {
      color: var(--accent-cyan);
    }

    .setting-info-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 14px;
      background: rgba(20, 20, 45, 0.98);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      width: 240px;
      text-align: left;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .setting-info-icon:hover .setting-info-tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Combos panel enhanced */
    .combos-panel {
      background: linear-gradient(145deg, rgba(20, 20, 40, 0.4) 0%, rgba(30, 30, 60, 0.4) 100%);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .combos-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .combo-item {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .combo-item:hover {
      border-color: var(--accent-purple);
      box-shadow: 0 2px 8px rgba(167, 139, 250, 0.1);
    }

    .combo-item:hover .combo-apply-btn {
      opacity: 1;
      transform: translateX(0);
    }

    .combo-apply-btn {
      opacity: 0;
      transform: translateX(10px);
      transition: all 0.2s;
    }

    /* No results state */
    .mappings-no-results {
      padding: 32px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      background: rgba(0, 0, 0, 0.1);
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      display: none;
    }

    .mappings-no-results.visible {
      display: block;
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* ===== Analytics Tab Styles ===== */
    
    /* Analytics Header */
    .analytics-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    
    .analytics-header-left {
      flex: 1;
    }
    
    .analytics-header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .analytics-header-title svg {
      color: var(--accent-red);
    }
    
    .analytics-header-title h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }
    
    .analytics-header-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .analytics-header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .analytics-last-updated {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* Enhanced Analytics Summary Cards */
    .analytics-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .analytics-stat-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .analytics-stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }
    
    .analytics-stat-card.red::before { background: linear-gradient(90deg, var(--accent-red), rgba(248, 113, 113, 0.3)); }
    .analytics-stat-card.yellow::before { background: linear-gradient(90deg, var(--accent-yellow), rgba(251, 191, 36, 0.3)); }
    .analytics-stat-card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), rgba(0, 229, 255, 0.3)); }
    .analytics-stat-card.purple::before { background: linear-gradient(90deg, var(--accent-purple), rgba(167, 139, 250, 0.3)); }
    
    .analytics-stat-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .analytics-stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .analytics-stat-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .analytics-stat-icon svg {
      width: 20px;
      height: 20px;
    }
    
    .analytics-stat-card.red .analytics-stat-icon { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }
    .analytics-stat-card.yellow .analytics-stat-icon { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }
    .analytics-stat-card.cyan .analytics-stat-icon { background: rgba(0, 229, 255, 0.15); color: var(--accent-cyan); }
    .analytics-stat-card.purple .analytics-stat-icon { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
    
    .analytics-stat-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 20px;
    }
    
    .analytics-stat-trend.up {
      background: rgba(248, 113, 113, 0.15);
      color: var(--accent-red);
    }
    
    .analytics-stat-trend.down {
      background: rgba(34, 211, 160, 0.15);
      color: var(--accent-green);
    }
    
    .analytics-stat-trend.neutral {
      background: rgba(136, 136, 170, 0.15);
      color: var(--text-muted);
    }
    
    .analytics-stat-trend svg {
      width: 12px;
      height: 12px;
    }
    
    .analytics-stat-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
    }
    
    .analytics-stat-card.red .analytics-stat-value { color: var(--accent-red); }
    .analytics-stat-card.yellow .analytics-stat-value { color: var(--accent-yellow); }
    .analytics-stat-card.cyan .analytics-stat-value { color: var(--accent-cyan); }
    .analytics-stat-card.purple .analytics-stat-value { color: var(--accent-purple); }
    
    .analytics-stat-label {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 12px;
    }
    
    /* Sparkline container */
    .analytics-sparkline {
      height: 32px;
      width: 100%;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }
    
    .analytics-sparkline-bar {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: all 0.3s;
    }
    
    .analytics-stat-card.red .analytics-sparkline-bar { background: rgba(248, 113, 113, 0.3); }
    .analytics-stat-card.yellow .analytics-sparkline-bar { background: rgba(251, 191, 36, 0.3); }
    .analytics-stat-card.cyan .analytics-sparkline-bar { background: rgba(0, 229, 255, 0.3); }
    .analytics-stat-card.purple .analytics-sparkline-bar { background: rgba(167, 139, 250, 0.3); }
    
    .analytics-stat-card:hover .analytics-sparkline-bar {
      opacity: 0.8;
    }
    
    /* Enhanced Filters */
    .analytics-filters-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .analytics-filters-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .analytics-filters-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .analytics-filters-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent-cyan);
    }
    
    .analytics-filters-title h3 {
      font-size: 15px;
      font-weight: 600;
      margin: 0;
    }
    
    .analytics-filters-active {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      border-radius: 20px;
      font-size: 12px;
      color: var(--accent-cyan);
    }
    
    .analytics-filters-active.visible {
      display: flex;
    }
    
    .analytics-filters-active-count {
      background: var(--accent-cyan);
      color: var(--bg-primary);
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 11px;
    }
    
    .analytics-clear-filters {
      background: none;
      border: none;
      color: var(--accent-cyan);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      padding: 0;
    }
    
    .analytics-clear-filters:hover {
      color: var(--text-primary);
    }
    
    .analytics-filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    
    .analytics-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .analytics-filter-group label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .analytics-filter-select,
    .analytics-filter-input {
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .analytics-filter-select:focus,
    .analytics-filter-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15);
    }
    
    .analytics-filter-input::placeholder {
      color: var(--text-muted);
    }
    
    .analytics-filters-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Charts Section */
    .analytics-charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .analytics-chart-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
    }
    
    .analytics-chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .analytics-chart-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .analytics-chart-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent-purple);
    }
    
    .analytics-chart-content {
      min-height: 180px;
    }
    
    /* Breakdown bars */
    .analytics-breakdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .analytics-breakdown-item:last-child {
      border-bottom: none;
    }
    
    .analytics-breakdown-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .analytics-breakdown-item:nth-child(1) .analytics-breakdown-rank {
      background: rgba(248, 113, 113, 0.2);
      color: var(--accent-red);
    }
    
    .analytics-breakdown-item:nth-child(2) .analytics-breakdown-rank {
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent-yellow);
    }
    
    .analytics-breakdown-item:nth-child(3) .analytics-breakdown-rank {
      background: rgba(167, 139, 250, 0.2);
      color: var(--accent-purple);
    }
    
    .analytics-breakdown-name {
      flex: 0 0 100px;
      font-size: 12px;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .analytics-breakdown-bar-wrapper {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .analytics-breakdown-bar {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow));
      transition: width 0.5s ease;
    }
    
    .analytics-breakdown-count {
      min-width: 50px;
      text-align: right;
    }
    
    .analytics-breakdown-count .badge {
      font-size: 11px;
      padding: 4px 10px;
    }
    
    /* Table Improvements */
    .analytics-table-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    
    .analytics-table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .analytics-table-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .analytics-table-title h3 {
      font-size: 15px;
      font-weight: 600;
      margin: 0;
    }
    
    .analytics-table-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent-red);
    }
    
    .analytics-result-count {
      background: rgba(248, 113, 113, 0.15);
      color: var(--accent-red);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .analytics-table-container {
      overflow-x: auto;
    }
    
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .analytics-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }
    
    .analytics-table th:hover {
      color: var(--accent-cyan);
      background: rgba(0, 229, 255, 0.05);
    }
    
    .analytics-table th.sorted {
      color: var(--accent-cyan);
    }
    
    .analytics-table th .sort-icon {
      display: inline-block;
      margin-left: 6px;
      opacity: 0.5;
      transition: all 0.2s;
    }
    
    .analytics-table th.sorted .sort-icon {
      opacity: 1;
    }
    
    .analytics-table th.sorted.desc .sort-icon {
      transform: rotate(180deg);
    }
    
    .analytics-table td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }
    
    .analytics-table tbody tr {
      transition: all 0.2s;
    }
    
    .analytics-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .analytics-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Severity indicators */
    .severity-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .severity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .severity-dot.critical { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
    .severity-dot.high { background: var(--accent-yellow); }
    .severity-dot.medium { background: var(--accent-cyan); }
    .severity-dot.low { background: var(--text-muted); }
    
    /* Pagination */
    .analytics-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      background: rgba(0, 0, 0, 0.1);
    }
    
    .analytics-pagination-info {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .analytics-pagination-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .analytics-page-size {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 16px;
    }
    
    .analytics-page-size label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .analytics-page-size select {
      padding: 6px 10px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 12px;
    }
    
    .analytics-pagination-btn {
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .analytics-pagination-btn:hover:not(:disabled) {
      border-color: var(--accent-cyan);
      background: rgba(0, 229, 255, 0.1);
    }
    
    .analytics-pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .analytics-pagination-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .analytics-page-numbers {
      display: flex;
      gap: 4px;
    }
    
    .analytics-page-num {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .analytics-page-num:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .analytics-page-num.active {
      background: var(--accent-cyan);
      color: var(--bg-primary);
      font-weight: 600;
    }
    
    /* Empty State */
    .analytics-empty-state {
      padding: 60px 20px;
      text-align: center;
    }
    
    .analytics-empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: rgba(34, 211, 160, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .analytics-empty-icon svg {
      width: 40px;
      height: 40px;
      color: var(--accent-green);
    }
    
    .analytics-empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .analytics-empty-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Loading skeleton */
    .analytics-skeleton {
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0.05) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .analytics-skeleton-value {
      height: 32px;
      width: 80px;
      margin-bottom: 8px;
    }
    
    .analytics-skeleton-label {
      height: 16px;
      width: 100px;
    }
    
    .analytics-skeleton-row {
      height: 50px;
      margin-bottom: 8px;
    }
    
    /* Error state */
    .analytics-error-banner {
      display: none;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }
    
    .analytics-error-banner.visible {
      display: flex;
    }
    
    .analytics-error-banner svg {
      width: 20px;
      height: 20px;
      color: var(--accent-red);
      flex-shrink: 0;
    }
    
    .analytics-error-message {
      flex: 1;
      font-size: 13px;
      color: var(--accent-red);
    }
    
    .analytics-error-retry {
      padding: 6px 14px;
      background: rgba(248, 113, 113, 0.2);
      border: 1px solid rgba(248, 113, 113, 0.4);
      border-radius: var(--radius-sm);
      color: var(--accent-red);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .analytics-error-retry:hover {
      background: rgba(248, 113, 113, 0.3);
    }
    
    /* Detail button */
    .analytics-detail-btn {
      padding: 6px 12px;
      background: rgba(167, 139, 250, 0.15);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: var(--radius-sm);
      color: var(--accent-purple);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .analytics-detail-btn:hover {
      background: rgba(167, 139, 250, 0.25);
      border-color: var(--accent-purple);
    }
    
    .analytics-detail-btn svg {
      width: 14px;
      height: 14px;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .analytics-header {
        flex-direction: column;
      }
      
      .analytics-header-actions {
        width: 100%;
        justify-content: flex-start;
      }
      
      .analytics-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .analytics-filters-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-charts-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-pagination {
        flex-direction: column;
        gap: 12px;
      }
      
      .analytics-pagination-controls {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .analytics-stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1>CLI Proxy API</h1>
      <p>Enter your management key to continue</p>
      <div class="form-group"><label>Management Key</label><input type="password" id="loginKey" class="form-input"
          placeholder="Enter your secret key" autofocus></div><button class="btn btn-primary"
        onclick="login()">Authenticate</button>
      <p id="loginError" style="color: var(--accent-red); margin-top: 16px; display: none;"></p>
    </div>
  </div>
  <div id="app" class="app">
    <!-- Mobile Header with Hamburger Menu -->
    <div class="mobile-header">
      <button class="hamburger-btn" onclick="toggleMobileSidebar()" aria-label="Toggle menu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
      </button>
      <div class="mobile-logo">
        <div class="sidebar-logo-icon">CP</div>
        <span>CLI Proxy</span>
      </div>
    </div>
    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
    <nav class="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">CP</div><span class="sidebar-logo-text">CLI Proxy</span>
      </div><a class="nav-item active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
        </svg><span>Dashboard</span></a><a class="nav-item" data-page="models"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
          <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
          <line x1="12" y1="22.08" x2="12" y2="12" />
        </svg><span>Models</span></a><a class="nav-item" data-page="auth"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
        </svg><span>Authentication</span></a><a class="nav-item" data-page="keys"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg><span>API Keys</span></a><a class="nav-item" data-page="config"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </svg><span>Configuration</span></a><a class="nav-item" data-page="usage"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 20V10m-6 10V4M6 20v-6" />
        </svg><span>Usage Stats</span></a><a class="nav-item" data-page="analytics"><svg
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg><span>Analytics</span></a><a class="nav-item" data-page="amp"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
        </svg><span>Amp Code</span></a><a class="nav-item" data-page="logs"><svg xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <path d="M14 2v6h6" />
          <path d="M16 13H8m8 4H8m2-8H8" />
        </svg><span>Logs</span></a>
      <div class="sidebar-footer"><a class="nav-item" onclick="logout()"><svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9" />
          </svg><span>Logout</span></a></div>
    </nav>
    <main class="main">
      <div id="page-dashboard" class="page active">
        <div class="page-header">
          <div class="dashboard-welcome">
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Server overview and quick actions</p>
          </div>
          <div class="dashboard-header-controls">
            <div class="dashboard-last-updated" id="dashboardLastUpdated">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="dashboardUpdateTime">Not yet updated</span>
            </div>
            <div class="health-indicator" id="healthIndicator">
              <div class="health-pulse"></div>
              <span class="health-text">Online</span>
            </div>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card cyan">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statModels">-</div>
              <div class="stat-label">Available Models</div>
            </div>
          </div>
          <div class="stat-card purple">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <path d="M9 12l2 2 4-4"></path>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statAuthFiles">-</div>
              <div class="stat-label">Auth Files</div>
            </div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statRequests">-</div>
              <div class="stat-label">Total Requests</div>
            </div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value" id="statSuccess">-</div>
              <div class="stat-label">Success Rate</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="quick-actions-grid">
            <button class="quick-action-btn" onclick="navigateTo('models')" data-tooltip="Browse all available AI models">
              <div class="quick-action-icon cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
              </div>
              <span>View Models</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('auth')" data-tooltip="Manage OAuth and auth files">
              <div class="quick-action-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
              </div>
              <span>Add Auth</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('usage')" data-tooltip="View detailed usage statistics">
              <div class="quick-action-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"></line>
                  <line x1="12" y1="20" x2="12" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
              </div>
              <span>View Usage</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('logs')" data-tooltip="Check recent request logs">
              <div class="quick-action-icon yellow">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </div>
              <span>View Logs</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('keys')" data-tooltip="Manage API access keys">
              <div class="quick-action-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                </svg>
              </div>
              <span>API Keys</span>
            </button>
            <button class="quick-action-btn" onclick="navigateTo('config')" data-tooltip="Configure server settings">
              <div class="quick-action-icon red">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
              </div>
              <span>Settings</span>
            </button>
          </div>
        </div>
        <div class="card server-status-card">
          <div class="card-header">
            <h3 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;margin-right:8px;">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                <line x1="6" y1="6" x2="6.01" y2="6"></line>
                <line x1="6" y1="18" x2="6.01" y2="18"></line>
              </svg>
              Server Status
            </h3>
            <button class="btn btn-secondary btn-sm" onclick="loadDashboard()" id="dashboardRefreshBtn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Refresh
            </button>
          </div>
          <div class="server-status-grid">
            <div class="server-status-item">
              <div class="status-icon-wrapper cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                  <line x1="16" y1="8" x2="2" y2="22"></line>
                  <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
              </div>
              <div class="status-info">
                <h4>Server Version</h4>
                <p id="serverVersion">Loading...</p>
              </div>
              <span class="badge badge-cyan" id="versionBadge">-</span>
            </div>
            <div class="server-status-item">
              <div class="status-icon-wrapper purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="status-info">
                <h4>Build Date</h4>
                <p id="buildDate">-</p>
              </div>
            </div>
            <div class="server-status-item">
              <div class="status-icon-wrapper green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </div>
              <div class="status-info">
                <h4>Latest Version</h4>
                <p id="latestVersion">-</p>
              </div>
              <span class="version-badge unknown" id="versionStatusBadge">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span id="versionStatusText">Check Update</span>
              </span>
              <button class="btn btn-secondary btn-sm" onclick="checkLatestVersion()" id="checkUpdateBtn">Check</button>
            </div>
            <div class="server-status-item">
              <div class="status-icon-wrapper cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
              </div>
              <div class="status-info">
                <h4>Server Uptime</h4>
                <p id="serverUptime">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="page-models" class="page">
        <div class="models-page-header">
          <div class="models-header-left">
            <div class="models-icon-box">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
              </svg>
            </div>
            <div>
              <h1 class="page-title" style="margin:0">Available Models</h1>
              <p class="page-subtitle">AI models accessible through the proxy</p>
            </div>
          </div>
          <div class="models-header-right">
            <span class="models-total-count" id="modelsTotalCount">0 models</span>
            <button class="btn btn-secondary btn-sm" onclick="loadModels()" id="modelsRefreshBtn" style="display:flex;align-items:center;gap:6px">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
              </svg>Refresh
            </button>
          </div>
        </div>
        
        <div class="models-toolbar">
          <div class="models-search-container">
            <svg class="models-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="modelSearch" class="models-search-input" placeholder="Search models by name or provider..." oninput="filterModels()">
            <button class="models-search-clear" id="modelSearchClear" onclick="clearModelSearch()" style="display:none">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
          <div class="models-filter-pills" id="modelsFilterPills">
            <button class="models-filter-pill active" data-provider="all" onclick="filterModelsByProvider('all')">All</button>
          </div>
        </div>
        
        <div id="modelsContainer" class="models-grid-container">
          <div class="models-loading">
            <div class="models-loading-spinner"></div>
            <p>Loading models...</p>
          </div>
        </div>
      </div>
      <div id="page-auth" class="page">
        <div class="page-header">
          <h1 class="page-title">Authentication</h1>
          <p class="page-subtitle">Manage OAuth connections, auth files, and credentials</p>
        </div>

        <!-- OAuth and Upload Grid -->
        <div class="auth-section-grid">
          <!-- OAuth Login Card -->
          <div class="card">
            <div class="auth-card-header">
              <div class="auth-card-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                  <polyline points="10 17 15 12 10 7"/>
                  <line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
              </div>
              <div class="auth-card-title">
                <h3>OAuth Login</h3>
                <p>Connect providers via OAuth authentication</p>
              </div>
            </div>
            <div class="auth-oauth-grid">
              <button class="auth-provider-card anthropic" onclick="startOAuth('anthropic')" aria-label="Connect Anthropic via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">Anthropic</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
              <button class="auth-provider-card gemini" onclick="startOAuth('gemini-cli')" aria-label="Connect Gemini CLI via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">Gemini CLI</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
              <button class="auth-provider-card codex" onclick="startOAuth('codex')" aria-label="Connect Codex via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">Codex</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
              <button class="auth-provider-card antigravity" onclick="startOAuth('antigravity')" aria-label="Connect Antigravity via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">Antigravity</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
              <button class="auth-provider-card qwen" onclick="startOAuth('qwen')" aria-label="Connect Qwen via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">Qwen</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
              <button class="auth-provider-card iflow" onclick="startOAuth('iflow')" aria-label="Connect IFlow via OAuth">
                <div class="auth-provider-icon"></div>
                <span class="auth-provider-name">IFlow</span>
                <span class="auth-provider-status"><span class="status-dot"></span>Click to connect</span>
              </button>
            </div>
          </div>

          <!-- Upload Auth File Card -->
          <div class="card">
            <div class="auth-card-header">
              <div class="auth-card-icon cyan">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <div class="auth-card-title">
                <h3>Upload Auth File</h3>
                <p>Import JSON credentials for CLI providers</p>
              </div>
            </div>
            <div id="uploadDropzone" class="auth-dropzone" role="button" tabindex="0" aria-label="Upload auth JSON file"
              onclick="document.getElementById('authFileInput').click()"
              onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('authFileInput').click();}"
              ondragover="event.preventDefault();this.classList.add('dragover');"
              ondragleave="this.classList.remove('dragover');"
              ondrop="this.classList.remove('dragover');handleFileDrop(event)">
              <div class="auth-dropzone-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <div class="auth-dropzone-title">Drop auth file here</div>
              <div class="auth-dropzone-subtitle">or click to browse your files</div>
              <div class="auth-dropzone-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
                Choose File
              </div>
              <div class="auth-dropzone-formats">Supports: claude.json, gemini.json, codex.json, etc.</div>
              <input type="file" id="authFileInput" accept=".json" style="display:none" onchange="handleFileSelect(this.files[0])">
            </div>
            <div id="uploadStatus" class="auth-upload-status" role="status" aria-live="polite"></div>
          </div>
        </div>

        <!-- Auth Files Table Card -->
        <div class="card">
          <div class="card-header">
            <div class="auth-card-header" style="margin-bottom:0">
              <div class="auth-card-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10 9 9 9 8 9"/>
                </svg>
              </div>
              <div class="auth-card-title">
                <h3>Auth Files</h3>
                <p>Manage your OAuth tokens and uploaded credentials</p>
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" onclick="loadAuthFiles()" id="authFilesRefreshBtn" title="Refresh auth files">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Refresh
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteAllAuthFiles()" title="Delete all auth files">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete All
              </button>
            </div>
          </div>
          <div class="auth-table-container">
            <table class="auth-table">
              <thead>
                <tr>
                  <th>Provider</th>
                  <th>Identity</th>
                  <th>Project / Region</th>
                  <th>Last Refresh</th>
                  <th>Usage</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="authFilesTable">
                <tr>
                  <td colspan="7">
                    <div class="auth-table-empty">
                      <div class="auth-table-empty-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                      </div>
                      <h4>Loading auth files...</h4>
                      <p>Please wait while we fetch your credentials</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="page-keys" class="page">
        <div class="keys-page-header">
          <div>
            <h1 class="page-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
              </svg>API Keys </h1>
            <p class="page-subtitle">Manage your access and provider API keys</p>
          </div>
        </div>
        <div class="keys-tabs">
          <div class="keys-tab active" data-keytab="access"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
            </svg>Access Keys <span class="tab-badge" id="accessTabBadge">0</span></div>
          <div class="keys-tab" data-keytab="gemini"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>Gemini <span class="tab-badge" id="geminiTabBadge">0</span></div>
          <div class="keys-tab" data-keytab="claude"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M8 14s1.5 2 4 2 4-2 4-2" />
              <line x1="9" y1="9" x2="9.01" y2="9" />
              <line x1="15" y1="9" x2="15.01" y2="9" />
            </svg>Claude <span class="tab-badge" id="claudeTabBadge">0</span></div>
          <div class="keys-tab" data-keytab="codex"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6" />
              <polyline points="8 6 2 12 8 18" />
            </svg>Codex <span class="tab-badge" id="codexTabBadge">0</span></div>
        </div>
        <div id="keytab-access" class="keys-content active">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Access API Keys</h3><span class="key-count" id="accessKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('access')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="accessKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-gemini" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Gemini API Keys</h3><span class="key-count" id="geminiKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('gemini')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="geminiKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-claude" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Claude API Keys</h3><span class="key-count" id="claudeKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('claude')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="claudeKeysList" class="keys-grid"></div>
          </div>
        </div>
        <div id="keytab-codex" class="keys-content">
          <div class="card">
            <div class="keys-section-header">
              <div class="keys-section-title">
                <h3>Codex API Keys</h3><span class="key-count" id="codexKeyCount">0 keys</span>
              </div><button class="btn-add-key" onclick="openAddKeyModal('codex')"><svg
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>Add Key </button>
            </div>
            <div id="codexKeysList" class="keys-grid"></div>
          </div>
        </div>
      </div>
      <div id="page-config" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
            <h1 class="page-title" style="margin:0">Configuration</h1>
          </div>
          <p class="page-subtitle">Manage server behavior and global settings</p>
        </div>
        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20h9" />
                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                </svg></div>
              <div class="config-section-title">
                <h3>General Settings</h3>
                <p>Core system toggles</p>
              </div>
              <div class="config-section-status" id="settingsStatus" style="display:none">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>Saved</span>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item" data-setting="debug">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Debug Mode</h4>
                    <p>Enable verbose logging for troubleshooting</p>
                  </div>
                </div>
                <div class="config-setting-status">
                  <span class="setting-status-dot" id="statusDebug"></span>
                  <label class="toggle-enhanced" id="toggleDebugLabel"><input type="checkbox" id="toggleDebug"
                    onchange="toggleSettingEnhanced('debug', this.checked, this)"><span class="toggle-enhanced-slider"></span></label>
                </div>
              </div>
              <div class="config-setting-item" data-setting="usage-statistics-enabled">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 20V10m-6 10V4M6 20v-6" />
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Usage Statistics</h4>
                    <p>Track request counts and token metrics</p>
                  </div>
                </div>
                <div class="config-setting-status">
                  <span class="setting-status-dot" id="statusUsageStats"></span>
                  <label class="toggle-enhanced" id="toggleUsageStatsLabel"><input type="checkbox" id="toggleUsageStats"
                    onchange="toggleSettingEnhanced('usage-statistics-enabled', this.checked, this)"><span
                    class="toggle-enhanced-slider"></span></label>
                </div>
              </div>
              <div class="config-setting-item" data-setting="logging-to-file">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Logging to File</h4>
                    <p>Persist logs to disk for later analysis</p>
                  </div>
                </div>
                <div class="config-setting-status">
                  <span class="setting-status-dot" id="statusLogging"></span>
                  <label class="toggle-enhanced" id="toggleLoggingLabel"><input type="checkbox" id="toggleLogging"
                    onchange="toggleSettingEnhanced('logging-to-file', this.checked, this)"><span
                    class="toggle-enhanced-slider"></span></label>
                </div>
              </div>
              <div class="config-setting-item" data-setting="request-log">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                      <path d="M3 3v5h5"></path>
                      <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                      <path d="M16 21h5v-5"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Request Log</h4>
                    <p>Log detailed request/response information</p>
                  </div>
                </div>
                <div class="config-setting-status">
                  <span class="setting-status-dot" id="statusRequestLog"></span>
                  <label class="toggle-enhanced" id="toggleRequestLogLabel"><input type="checkbox" id="toggleRequestLog"
                    onchange="toggleSettingEnhanced('request-log', this.checked, this)"><span
                    class="toggle-enhanced-slider"></span></label>
                </div>
              </div>
              <div class="config-setting-item" data-setting="ws-auth">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>WebSocket Auth</h4>
                    <p>Require authentication for WebSocket connections</p>
                  </div>
                </div>
                <div class="config-setting-status">
                  <span class="setting-status-dot" id="statusWsAuth"></span>
                  <label class="toggle-enhanced" id="toggleWsAuthLabel"><input type="checkbox" id="toggleWsAuth"
                    onchange="toggleSettingEnhanced('ws-auth', this.checked, this)"><span
                    class="toggle-enhanced-slider"></span></label>
                </div>
              </div>
            </div>
          </div>
          <div class="config-editor-section">
            <div class="config-editor-header">
              <div class="config-editor-title">
                <div class="icon-box"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                  </svg></div>
                <div>
                  <h3>Advanced Configuration</h3>
                  <p>Edit full YAML configuration <span class="config-tooltip" data-tooltip="Press Ctrl+S to save"></span></p>
                </div>
              </div>
              <div class="config-unsaved-indicator" id="configUnsavedIndicator">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>Unsaved changes</span>
              </div>
              <div class="config-actions">
                <button class="btn-config-action" onclick="reloadConfig()" title="Reload configuration from server">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                    <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                    <path d="M16 21h5v-5"></path>
                  </svg>
                  Reset
                </button>
                <button class="btn-save-config" id="btnSaveConfig" onclick="saveConfigEnhanced()">
                  <svg xmlns="http://www.w3.org/2000/svg" id="saveConfigIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                  </svg>
                  <span id="saveConfigText">Save</span>
                </button>
              </div>
            </div>
            <div class="yaml-error-banner" id="yamlErrorBanner">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              <div class="error-details">
                <div class="error-title">Invalid YAML syntax</div>
                <div class="error-message" id="yamlErrorMessage"></div>
              </div>
            </div>
            <div class="config-editor-toolbar">
              <div class="config-editor-info">
                <span id="configLineCount">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="17" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="17" y1="18" x2="3" y2="18"></line>
                  </svg>
                  0 lines
                </span>
                <span id="configCharCount">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                    <line x1="9" y1="20" x2="15" y2="20"></line>
                    <line x1="12" y1="4" x2="12" y2="20"></line>
                  </svg>
                  0 chars
                </span>
              </div>
            </div>
            <div class="config-editor-content"><textarea id="configEditor" class="code-editor"
                placeholder="Loading config..." style="height: 100%; min-height: 440px;" oninput="onConfigEditorInput()"></textarea></div>
          </div>
        </div>
      </div>
      <div id="page-usage" class="page">
        <div class="usage-page-header">
          <div class="usage-header-left">
            <div class="usage-header-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 20V10m-6 10V4M6 20v-6" />
              </svg>
              <h1>Usage Statistics</h1>
            </div>
            <p class="usage-header-subtitle">Monitor your API usage, token consumption, and performance metrics</p>
          </div>
          <div class="usage-header-actions">
            <span id="usageLastUpdated" class="usage-last-updated">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="usageUpdateTime">--</span>
            </span>
            <div class="date-range-selector" role="group" aria-label="Date range filter">
              <button class="date-range-btn active" data-range="all" onclick="setUsageDateRange('all')" aria-pressed="true">All</button>
              <button class="date-range-btn" data-range="30d" onclick="setUsageDateRange('30d')" aria-pressed="false">30d</button>
              <button class="date-range-btn" data-range="7d" onclick="setUsageDateRange('7d')" aria-pressed="false">7d</button>
              <button class="date-range-btn" data-range="today" onclick="setUsageDateRange('today')" aria-pressed="false">Today</button>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="exportUsageData()" title="Export usage data">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadUsageStats()" id="usageRefreshBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6" />
                <path d="M1 20v-6h6" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
              </svg>
              Refresh
            </button>
          </div>
        </div>

        <!-- Enhanced Stats Grid -->
        <div class="usage-stats-grid">
          <div class="usage-stat-card cyan">
            <div class="usage-stat-header">
              <div class="usage-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
              </div>
              <div class="usage-stat-badge" id="usageReqTrend"></div>
            </div>
            <div class="usage-stat-value" id="usageTotalRequests">-</div>
            <div class="usage-stat-label">Total Requests</div>
            <div class="usage-stat-sublabel" id="usageReqPeriod">All time</div>
          </div>

          <div class="usage-stat-card green">
            <div class="usage-stat-header">
              <div class="usage-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
            </div>
            <div class="usage-stat-value" id="usageSuccessful">-</div>
            <div class="usage-stat-label">Successful</div>
            <div class="usage-stat-sublabel" id="usageSuccessPeriod">All time</div>
          </div>

          <div class="usage-stat-card red">
            <div class="usage-stat-header">
              <div class="usage-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
            </div>
            <div class="usage-stat-value" id="usageFailed">-</div>
            <div class="usage-stat-label">Failed</div>
            <div class="usage-stat-sublabel" id="usageFailedPeriod">All time</div>
          </div>

          <div class="usage-stat-card purple">
            <div class="usage-stat-header">
              <div class="usage-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path>
                </svg>
              </div>
              <div class="usage-rate-indicator" id="usageRateIndicator">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
              </div>
            </div>
            <div class="usage-stat-value" id="usageSuccessRate">-</div>
            <div class="usage-stat-label">Success Rate</div>
            <div class="usage-stat-sublabel" id="usageRatePeriod">All time</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="usage-charts-grid">
          <div class="usage-chart-card">
            <div class="usage-chart-header">
              <div class="usage-chart-info">
                <div class="usage-chart-title">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                    <polyline points="17 18 23 18 23 12"></polyline>
                  </svg>
                  Request Trends
                </div>
                <div class="usage-chart-value" id="trendRequestTotal">-</div>
                <div class="usage-chart-sublabel" id="requestChartPeriod">Daily requests  All time</div>
              </div>
              <div class="usage-chart-controls">
                <div class="chart-view-toggle" role="group" aria-label="Chart view toggle">
                  <button class="chart-view-btn active" data-view="daily" onclick="setChartView('daily')" aria-pressed="true">Daily</button>
                  <button class="chart-view-btn" data-view="hourly" onclick="setChartView('hourly')" aria-pressed="false">Hourly</button>
                </div>
              </div>
            </div>
            <div class="usage-chart-container" id="requestsChartContainer">
              <div class="usage-chart-empty" id="requestsChartEmpty" style="display:none">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M18 20V10m-6 10V4M6 20v-6" />
                </svg>
                <p>No request data available for this period</p>
              </div>
              <canvas id="requestsChart" role="img" aria-label="Request trends chart showing API request volume over time"></canvas>
            </div>
          </div>

          <div class="usage-chart-card">
            <div class="usage-chart-header">
              <div class="usage-chart-info">
                <div class="usage-chart-title">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  </svg>
                  Token Usage
                </div>
                <div class="usage-chart-value purple" id="trendTokenTotal">-</div>
                <div class="usage-chart-sublabel" id="tokenChartPeriod">Daily tokens  All time</div>
              </div>
              <div class="usage-chart-icon purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
              </div>
            </div>
            <div class="usage-chart-container" id="tokensChartContainer">
              <div class="usage-chart-empty" id="tokensChartEmpty" style="display:none">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
                <p>No token data available for this period</p>
              </div>
              <canvas id="tokensChart" role="img" aria-label="Token usage chart showing token consumption over time"></canvas>
            </div>
          </div>
        </div>
        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <circle cx="12" cy="14" r="4"></circle>
                </svg></div>
              <div class="config-section-title">
                <h3>Token Usage</h3>
                <p>Detailed token breakdown</p>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item" style="background:rgba(0,229,255,0.05);border-radius:8px;margin-bottom:8px">
                <div class="config-setting-info">
                  <div class="config-setting-icon" style="background:rgba(0,229,255,0.15)"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                      <path d="M2 12l10 5 10-5"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4 style="color:var(--accent-cyan)">Total Tokens</h4>
                    <p>All tokens consumed</p>
                  </div>
                </div><span class="badge badge-cyan" style="font-size:14px;padding:6px 12px" id="usageTotalTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="13 17 18 12 13 7"></polyline>
                      <polyline points="6 17 11 12 6 7"></polyline>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Input Tokens</h4>
                    <p>Sent to AI providers</p>
                  </div>
                </div><span class="badge badge-cyan" id="usageInputTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="11 17 6 12 11 7"></polyline>
                      <polyline points="18 17 13 12 18 7"></polyline>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Output Tokens</h4>
                    <p>Received from AI providers</p>
                  </div>
                </div><span class="badge badge-purple" id="usageOutputTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 16v-4"></path>
                      <path d="M12 8h.01"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Reasoning Tokens</h4>
                    <p>Used for chain-of-thought reasoning</p>
                  </div>
                </div><span class="badge badge-blue" id="usageReasoningTokens">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                      </path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Cache Read</h4>
                    <p>Tokens served from cache</p>
                  </div>
                </div><span class="badge badge-green" id="usageCacheRead">-</span>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2v20M2 12h20"></path>
                    </svg></div>
                  <div class="config-setting-text">
                    <h4>Cache Write</h4>
                    <p>Tokens written to cache</p>
                  </div>
                </div><span class="badge badge-yellow" id="usageCacheWrite">-</span>
              </div>
            </div>
          </div>
          <div class="config-section">
            <div class="config-section-header">
              <div class="config-section-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg></div>
              <div class="config-section-title">
                <h3>Provider Usage</h3>
                <p>Requests by provider/key</p>
              </div>
            </div>
            <div id="providerStats" style="max-height:300px;overflow-y:auto">
              <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:20px">
          <div class="card-header">
            <div class="keys-section-title">
              <h3>Model Usage</h3>
            </div>
          </div>
          <div id="modelStats" class="table-container">
            <div style="padding:24px;text-align:center;color:var(--text-secondary)">Loading...</div>
          </div>
        </div>
      </div>
      <div id="page-analytics" class="page">
        <!-- Error Banner -->
        <div id="analyticsErrorBanner" class="analytics-error-banner">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span id="analyticsErrorMessage" class="analytics-error-message">Failed to load analytics data</span>
          <button class="analytics-error-retry" onclick="loadAnalytics()">Retry</button>
        </div>

        <!-- Enhanced Header -->
        <div class="analytics-header">
          <div class="analytics-header-left">
            <div class="analytics-header-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
              <h1>Failure Analytics</h1>
            </div>
            <p class="analytics-header-subtitle">Monitor and analyze failed API requests to identify issues and improve reliability</p>
          </div>
          <div class="analytics-header-actions">
            <span id="analyticsLastUpdated" class="analytics-last-updated">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="analyticsUpdateTime">--</span>
            </span>
            <button class="btn btn-secondary btn-sm" onclick="loadAnalytics()" id="analyticsRefreshBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Refresh
            </button>
            <button class="btn btn-secondary btn-sm" onclick="exportAnalytics()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Export
            </button>
          </div>
        </div>

        <!-- Enhanced Analytics Summary Cards -->
        <div class="analytics-stats-grid" id="analyticsStatsGrid">
          <div class="analytics-stat-card red">
            <div class="analytics-stat-header">
              <div class="analytics-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
              <div id="analyticsFailedTrend" class="analytics-stat-trend neutral">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>0%</span>
              </div>
            </div>
            <div class="analytics-stat-value" id="analyticsFailedTotal">0</div>
            <div class="analytics-stat-label">Total Failed Requests</div>
            <div class="analytics-sparkline" id="sparklineTotal"></div>
          </div>

          <div class="analytics-stat-card yellow">
            <div class="analytics-stat-header">
              <div class="analytics-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div id="analyticsTodayTrend" class="analytics-stat-trend neutral">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Today</span>
              </div>
            </div>
            <div class="analytics-stat-value" id="analyticsFailedToday">0</div>
            <div class="analytics-stat-label">Failed Today</div>
            <div class="analytics-sparkline" id="sparklineToday"></div>
          </div>

          <div class="analytics-stat-card cyan">
            <div class="analytics-stat-header">
              <div class="analytics-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              <div id="analyticsRateTrend" class="analytics-stat-trend neutral">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>--</span>
              </div>
            </div>
            <div class="analytics-stat-value" id="analyticsSuccessRate">100%</div>
            <div class="analytics-stat-label">Success Rate</div>
            <div class="analytics-sparkline" id="sparklineRate"></div>
          </div>

          <div class="analytics-stat-card purple">
            <div class="analytics-stat-header">
              <div class="analytics-stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
              </div>
            </div>
            <div class="analytics-stat-value" id="analyticsTopFailProvider" style="font-size:18px">-</div>
            <div class="analytics-stat-label">Most Failed Provider</div>
            <div id="topProviderFailCount" style="margin-top:8px;font-size:12px;color:var(--text-muted)"></div>
          </div>
        </div>

        <!-- Enhanced Filters -->
        <div class="analytics-filters-card">
          <div class="analytics-filters-header">
            <div class="analytics-filters-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
              </svg>
              <h3>Filters</h3>
            </div>
            <div id="analyticsFiltersActive" class="analytics-filters-active">
              <span class="analytics-filters-active-count" id="analyticsActiveCount">0</span>
              <span>filters active</span>
              <button class="analytics-clear-filters" onclick="clearAnalyticsFilters()">Clear all</button>
            </div>
          </div>
          <div class="analytics-filters-grid">
            <div class="analytics-filter-group">
              <label>Provider</label>
              <select id="analyticsProviderFilter" class="analytics-filter-select" onchange="filterAnalytics()">
                <option value="">All Providers</option>
              </select>
            </div>
            <div class="analytics-filter-group">
              <label>Model</label>
              <select id="analyticsModelFilter" class="analytics-filter-select" onchange="filterAnalytics()">
                <option value="">All Models</option>
              </select>
            </div>
            <div class="analytics-filter-group">
              <label>Severity</label>
              <select id="analyticsSeverityFilter" class="analytics-filter-select" onchange="filterAnalytics()">
                <option value="">All Severities</option>
                <option value="critical">Critical (5xx)</option>
                <option value="high">High (429, 408)</option>
                <option value="medium">Medium (4xx)</option>
                <option value="low">Low (Other)</option>
              </select>
            </div>
            <div class="analytics-filter-group">
              <label>Time Range</label>
              <select id="analyticsTimeFilter" class="analytics-filter-select" onchange="filterAnalytics()">
                <option value="all">All Time</option>
                <option value="hour">Last Hour</option>
                <option value="today">Today</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
              </select>
            </div>
            <div class="analytics-filter-group">
              <label>Search</label>
              <input type="text" id="analyticsSearchFilter" class="analytics-filter-input" placeholder="Search provider, model, error..." oninput="debounceFilterAnalytics()">
            </div>
          </div>
        </div>

        <!-- Failure Breakdown Charts -->
        <div class="analytics-charts-grid">
          <div class="analytics-chart-card">
            <div class="analytics-chart-header">
              <div class="analytics-chart-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                Failures by Provider
              </div>
            </div>
            <div id="failuresByProvider" class="analytics-chart-content">
              <div class="analytics-empty-state" style="padding:32px">
                <div class="analytics-skeleton analytics-skeleton-row"></div>
                <div class="analytics-skeleton analytics-skeleton-row"></div>
                <div class="analytics-skeleton analytics-skeleton-row"></div>
              </div>
            </div>
          </div>
          <div class="analytics-chart-card">
            <div class="analytics-chart-header">
              <div class="analytics-chart-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                  <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                  <line x1="6" y1="6" x2="6.01" y2="6"></line>
                  <line x1="6" y1="18" x2="6.01" y2="18"></line>
                </svg>
                Failures by Model
              </div>
            </div>
            <div id="failuresByModel" class="analytics-chart-content">
              <div class="analytics-empty-state" style="padding:32px">
                <div class="analytics-skeleton analytics-skeleton-row"></div>
                <div class="analytics-skeleton analytics-skeleton-row"></div>
                <div class="analytics-skeleton analytics-skeleton-row"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Failed Requests Table -->
        <div class="analytics-table-card">
          <div class="analytics-table-header">
            <div class="analytics-table-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              <h3>Failed Request Log</h3>
            </div>
            <span id="analyticsResultCount" class="analytics-result-count">0 failures</span>
          </div>
          <div class="analytics-table-container">
            <table class="analytics-table">
              <thead>
                <tr>
                  <th data-sort="timestamp" onclick="sortAnalyticsTable('timestamp')" class="sorted desc">
                    Timestamp
                    <span class="sort-icon"></span>
                  </th>
                  <th data-sort="severity" onclick="sortAnalyticsTable('severity')">
                    Severity
                    <span class="sort-icon"></span>
                  </th>
                  <th data-sort="provider" onclick="sortAnalyticsTable('provider')">
                    Provider
                    <span class="sort-icon"></span>
                  </th>
                  <th data-sort="model" onclick="sortAnalyticsTable('model')">
                    Model
                    <span class="sort-icon"></span>
                  </th>
                  <th data-sort="source" onclick="sortAnalyticsTable('source')">
                    Source
                    <span class="sort-icon"></span>
                  </th>
                  <th data-sort="status" onclick="sortAnalyticsTable('status')">
                    Status
                    <span class="sort-icon"></span>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="analyticsTable">
                <tr>
                  <td colspan="7">
                    <div class="analytics-empty-state" style="padding:40px">
                      <div class="analytics-skeleton analytics-skeleton-row"></div>
                      <div class="analytics-skeleton analytics-skeleton-row"></div>
                      <div class="analytics-skeleton analytics-skeleton-row"></div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Pagination -->
          <div class="analytics-pagination" id="analyticsPagination">
            <div class="analytics-pagination-info">
              <span id="analyticsPaginationInfo">Showing 0-0 of 0 failures</span>
            </div>
            <div class="analytics-pagination-controls">
              <div class="analytics-page-size">
                <label>Show:</label>
                <select id="analyticsPageSize" onchange="changeAnalyticsPageSize()">
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <button class="analytics-pagination-btn" id="analyticsPrevBtn" onclick="changeAnalyticsPage(-1)" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Previous
              </button>
              <div class="analytics-page-numbers" id="analyticsPageNumbers"></div>
              <button class="analytics-pagination-btn" id="analyticsNextBtn" onclick="changeAnalyticsPage(1)" disabled>
                Next
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="page-amp" class="page">
        <div class="config-page-header">
          <div class="page-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              style="color:var(--accent-cyan)">
              <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
              <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
              <line x1="6" y1="6" x2="6.01" y2="6"></line>
              <line x1="6" y1="18" x2="6.01" y2="18"></line>
            </svg>
            <h1>Amp Code Configuration</h1>
          </div>
        </div>
        <div class="amp-hero">
          <div class="amp-hero-content">
            <h2>Supercharge your Proxy</h2>
            <p>Connect to Amp Code upstream service to access premium models,
              fallback capabilities,
              and unified usage tracking. Enter your credentials below to get started.</p>
          </div><svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none"
            stroke="rgba(0, 229, 255, 0.1)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
            style="position:absolute;right:-20px;bottom:-20px;transform:rotate(-15deg)">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
          <div class="card">
            <div class="card-header">
              <div class="keys-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" style="color:var(--accent-green)">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="2" y1="12" x2="22" y2="12"></line>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                  </path>
                </svg>
                <h3>Upstream Connection</h3>
              </div>
            </div>
            <!-- Connection Status -->
            <div id="ampConnectionStatus" class="amp-connection-status not-configured">
              <div class="amp-status-dot"></div>
              <span id="ampConnectionText">Not configured</span>
            </div>
            <div class="form-group"><label>Upstream URL</label>
              <div class="input-with-icon"><input type="text" id="ampUpstreamUrl" class="form-input"
                  placeholder="https://api.ampcode.com"><svg class="input-icon" xmlns="http://www.w3.org/2000/svg"
                  width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg></div>
            </div>
            <div class="form-group"><label>Upstream API Key</label>
              <div class="input-with-icon has-toggle">
                <input type="password" id="ampUpstreamKey" class="form-input" placeholder="">
                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <button type="button" class="password-toggle-btn" onclick="toggleAmpKeyVisibility()" title="Toggle visibility">
                  <svg id="ampKeyEyeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
            </div>
            <div class="amp-actions">
              <button class="btn btn-test-connection" id="btnTestConnection" onclick="testAmpConnection()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <span id="testConnectionText">Test</span>
              </button>
              <button class="btn btn-save-amp" id="btnSaveAmp" onclick="saveAmpSettings()">
                <svg id="saveAmpIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span id="saveAmpText">Save Connection</span>
              </button>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="keys-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  style="color:var(--accent-blue)">
                  <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                  </path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <h3>Amp Settings</h3>
              </div>
            </div>
            <div class="config-settings-list">
              <div class="config-setting-item" style="border-bottom: 1px solid var(--border-color)">
                <div class="config-setting-info">
                  <div class="config-setting-text">
                    <h4>Force Model Mappings
                      <span class="setting-info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="10"></circle>
                          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                          <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span class="setting-info-tooltip">When enabled, model mappings will be prioritized over your local API keys. Requests will be routed to the upstream service first.</span>
                      </span>
                    </h4>
                    <p>Prioritize mappings over local keys</p>
                  </div>
                </div>
                <label class="toggle-enhanced">
                  <input type="checkbox" id="ampForce"
                    onchange="toggleAmpSetting('force-model-mappings', this.checked)">
                  <span class="toggle-enhanced-slider"></span>
                </label>
              </div>
              <div class="config-setting-item">
                <div class="config-setting-info">
                  <div class="config-setting-text">
                    <h4>Restrict Management
                      <span class="setting-info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="10"></circle>
                          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                          <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span class="setting-info-tooltip">For security, enable this to only allow management API access from localhost (127.0.0.1). Remote connections will be blocked.</span>
                      </span>
                    </h4>
                    <p>Only allow localhost for management</p>
                  </div>
                </div>
                <label class="toggle-enhanced">
                  <input type="checkbox" id="ampRestrict"
                    onchange="toggleAmpSetting('restrict-management-to-localhost', this.checked)">
                  <span class="toggle-enhanced-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Removed extra div closures here to keep next card inside page-amp -->

        <!-- Full width mappings section -->
        <div class="card" style="margin-top:24px">
          <div class="card-header">
            <div class="keys-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="color:var(--accent-purple)">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" y1="20" x2="21" y2="3"></line>
              </svg>
              <h3>Model Mappings</h3>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:32px; align-items:start">

            <!-- Section 1: Mappings List -->
            <div>
              <div class="mappings-header">
                <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap">
                  <h4 style="font-size:14px; color:var(--text-secondary); font-weight:600; margin:0">Active Mappings (<span
                      id="mappingCount">0</span>)</h4>
                  <div class="mappings-search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="mappingSearchInput" placeholder="Search mappings..." oninput="filterMappings(this.value)">
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="openAddMappingModal()">
                  <span style="margin-right:4px">+</span> Add Mapping
                </button>
              </div>
              <div id="modelMappings" class="mappings-list"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px"></div>
              <div id="mappingsNoResults" class="mappings-no-results">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:8px;opacity:0.5">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <div>No mappings found matching your search.</div>
              </div>
            </div>

            <!-- Section 2: Combos -->
            <div class="combos-panel"
              style="background: linear-gradient(145deg, rgba(20, 20, 40, 0.4) 0%, rgba(30, 30, 60, 0.4) 100%); border:1px solid var(--border-color); border-radius:var(--radius-lg); padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1)">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                <div style="display:flex; align-items:center; gap:8px">
                  <div
                    style="width:32px; height:32px; background:rgba(167, 139, 250, 0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--accent-purple)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2">
                      <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                  </div>
                  <div>
                    <h4 style="font-size:15px; color:var(--text-primary); font-weight:600; margin:0">Quick Combos</h4>
                    <p style="font-size:11px; color:var(--text-secondary); margin:0">Switch configurations instantly</p>
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm" style="font-size:12px" onclick="openManageCombosModal()">Manage
                  All</button>
              </div>

              <div id="combosSidePanel"
                style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto">
                <!-- Combos rendered here -->
                <div
                  style="padding:24px; text-align:center; color:var(--text-secondary); font-size:13px; border:1px dashed var(--border-color); border-radius:8px; background:rgba(0,0,0,0.1)">
                  No combos created yet.<br>
                  <a href="javascript:void(0)" onclick="openAddComboModal()"
                    style="color:var(--accent-cyan); text-decoration:none; display:inline-block; margin-top:4px">Create
                    your first combo</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- Close page-amp -->

      <div id="page-logs" class="page">
        <div class="page-header">
          <div class="page-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              style="color:var(--text-secondary); margin-right:12px">
              <polyline points="4 17 10 11 4 5"></polyline>
              <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            System Logs
          </div>
          <p class="page-subtitle">Monitor server activity and debug issues in real-time</p>
        </div>

        <div class="log-controls">
          <div class="log-search-container" id="logSearchContainer">
            <svg class="log-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" class="log-search-input" id="logSearch" placeholder="Search logs (regex supported)..."
              oninput="filterLogs()">
            <span class="log-regex-error" id="logRegexError">Invalid regex pattern</span>
          </div>

          <div class="log-filter-group">
            <button class="log-filter-btn active" onclick="setLogFilter('ALL')" id="filter-ALL">ALL</button>
            <button class="log-filter-btn filter-debug" onclick="setLogFilter('DEBUG')" id="filter-DEBUG">DEBUG</button>
            <button class="log-filter-btn filter-info" onclick="setLogFilter('INFO')" id="filter-INFO">INFO</button>
            <button class="log-filter-btn filter-warn" onclick="setLogFilter('WARN')" id="filter-WARN">WARN</button>
            <button class="log-filter-btn filter-error" onclick="setLogFilter('ERROR')" id="filter-ERROR">ERROR</button>
          </div>

          <div style="height:24px; width:1px; background:var(--border-color); margin:0 8px;"></div>

          <div style="display:flex; align-items:center; gap:8px; margin-right:8px">
            <label class="toggle-enhanced">
              <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh(this.checked)">
              <span class="toggle-enhanced-slider"></span>
            </label>
            <span style="font-size:12px; color:var(--text-secondary)">Live</span>
          </div>

          <button class="btn btn-secondary btn-sm" id="btnRefreshLogs" onclick="loadLogs()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Refresh
          </button>
          <button class="btn btn-secondary btn-sm" onclick="exportLogs()" title="Download logs as text file">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
          <button class="btn btn-secondary btn-sm" onclick="jumpToNextError()" title="Jump to errors">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Errors
          </button>
          <button class="btn btn-danger btn-sm" onclick="clearLogs()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear
          </button>

          <div class="log-shortcuts-hint" title="Keyboard shortcuts">
            <span><kbd>Esc</kbd> Clear search</span>
            <span><kbd></kbd> Scroll to bottom</span>
          </div>
        </div>

        <div class="terminal-window" style="position:relative;">
          <div class="terminal-header">
            <div class="terminal-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
              </svg>
              cliproxy-server  System Logs
            </div>
            <div class="terminal-status">
              <span id="logCount" style="color:var(--text-secondary);margin-right:8px">0 lines</span>
              <span id="logTruncatedHint" style="color:var(--accent-yellow);font-size:10px;margin-right:8px;display:none;">(showing last 500)</span>
              <button onclick="scrollLogsToBottom()" title="Scroll to bottom"
                style="background:none; border:none; cursor:pointer; padding:2px 6px; color:var(--text-secondary); margin-right:8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="7 13 12 18 17 13"></polyline>
                  <polyline points="7 6 12 11 17 6"></polyline>
                </svg>
              </button>
              <div id="liveStatusDot" class="status-dot"></div>
              <span id="liveStatusText" style="color:var(--text-muted)">Offline</span>
            </div>
          </div>
          
          <!-- Log Statistics Bar -->
          <div class="log-stats-bar" id="logStatsBar">
            <div class="log-stat-item">
              <span>Total:</span>
              <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="log-stat-divider"></div>
            <div class="log-stat-item errors">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
              <span class="stat-value" id="statErrors">0</span>
              <span>errors</span>
            </div>
            <div class="log-stat-item warnings">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span class="stat-value" id="statWarnings">0</span>
              <span>warnings</span>
            </div>
            <div class="log-stat-item info">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
              <span class="stat-value" id="statInfo">0</span>
              <span>info</span>
            </div>
            <div class="log-stat-item debug">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
              <span class="stat-value" id="statDebug">0</span>
              <span>debug</span>
            </div>
          </div>

          <div id="logViewer" class="log-viewer-content">
            <div class="empty-logs">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <p>Waiting for logs...</p>
            </div>
          </div>

          <!-- Scroll to bottom button -->
          <button class="scroll-bottom-btn" id="scrollBottomBtn" onclick="scrollLogsToBottom()" title="Scroll to latest">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="7 13 12 18 17 13"></polyline>
              <polyline points="7 6 12 11 17 6"></polyline>
            </svg>
            <span class="new-logs-badge" id="newLogsBadge" style="display:none;">0</span>
          </button>
        </div>
      </div>
    </main>
  </div>
  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()">&times;
        </button>
      </div>
      <div id="modalContent"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>
  <div id="toastContainer" class="toast-container"></div>
  <script>let apiKey = localStorage.getItem('managementKey') || '';

    let serverInfo = {}

      ;

    async function api(method, endpoint, body = null) {
      const opts = {
        method,
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        }
      };
      if (body) opts.body = typeof body === 'string' ? body : JSON.stringify(body);
      const res = await fetch(`/v0/management${endpoint}`, opts);
      if (!res.ok) throw new Error(await res.text() || `HTTP ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    function toast(msg, type = 'info') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    async function login() {
      const key = document.getElementById('loginKey').value;
      if (!key) return;
      apiKey = key;

      try {
        await api('GET', '/config');
        localStorage.setItem('managementKey', key);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').classList.add('active');
        loadDashboard();
        toast('Successfully authenticated', 'success');
      }

      catch (e) {
        document.getElementById('loginError').textContent = 'Invalid management key';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('managementKey');
      location.reload();
    }

    // Mobile sidebar toggle functions
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');
      document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
    }

    function closeMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close sidebar when clicking a nav item on mobile
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            closeMobileSidebar();
          }
        });
      });
    });

    async function checkAuth() {
      if (apiKey) {
        try {
          await api('GET', '/config');
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('app').classList.add('active');
          loadDashboard();
        }

        catch {
          localStorage.removeItem('managementKey');
          apiKey = '';
        }
      }
    }

    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');

        // Stop log auto-refresh when navigating away from logs tab
        if (page !== 'logs') {
          stopLogAutoRefresh();
        }

        if (page === 'dashboard') loadDashboard();
        if (page === 'models') loadModels();
        if (page === 'auth') loadAuthFiles();
        if (page === 'keys') loadKeys();
        if (page === 'config') loadConfig();
        if (page === 'usage') loadUsageStats();
        if (page === 'analytics') loadAnalytics();
        if (page === 'amp') loadAmpSettings();
        if (page === 'logs') loadLogs();
      });
    });

    function navigateTo(page) {
      const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
      if (navItem) navItem.click();
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // API Keys tabs handler
    document.querySelectorAll('.keys-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.keys-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.keys-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`keytab-${tab.dataset.keytab}`).classList.add('active');
      });
    });

    // Dashboard state
    let dashboardStartTime = Date.now();
    let currentServerVersion = '-';

    async function loadDashboard() {
      const refreshBtn = document.getElementById('dashboardRefreshBtn');
      const lastUpdatedEl = document.getElementById('dashboardLastUpdated');
      const statCards = document.querySelectorAll('.stats-grid .stat-card');
      
      // Add loading states
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
      }
      if (lastUpdatedEl) {
        lastUpdatedEl.classList.add('refreshing');
      }
      statCards.forEach(card => card.classList.add('loading'));
      
      try {

        // Fetch config with full response to get headers
        const configRes = await fetch('/v0/management/config', {
          headers: {
            'Authorization': `Bearer ${apiKey
              }

            `, 'Content-Type': 'application/json'
          }
        });
        const version = configRes.headers.get('X-CPA-VERSION') || '-';
        const commit = configRes.headers.get('X-CPA-COMMIT') || '-';
        const buildDate = configRes.headers.get('X-CPA-BUILD-DATE') || '-';
        const config = await configRes.json();
        serverInfo = config;
        accessApiKeys = config['api-keys'] || config.api_keys || [];
        currentServerVersion = version;

        // Fetch usage
        const usage = await api('GET', '/usage').catch(() => ({
          usage: {}
        }));

        // Remove loading state and update values
        statCards.forEach(card => card.classList.remove('loading'));

        document.getElementById('statRequests').textContent = (usage.usage?.total_requests || 0).toLocaleString();
        const total = usage.usage?.total_requests || 0,
          failed = usage.usage?.failed_requests || usage.failed_requests || 0;
        const successRate = total > 0 ? ((total - failed) / total * 100).toFixed(1) : '-';
        document.getElementById('statSuccess').textContent = successRate === '-' ? '-' : successRate + '%';

        document.getElementById('serverVersion').textContent = `Version: ${version
          }

    | Commit: ${commit.slice(0, 7)
          }

    `;
        document.getElementById('versionBadge').textContent = version;
        document.getElementById('buildDate').textContent = buildDate;

        // Update last updated timestamp
        const updateTimeEl = document.getElementById('dashboardUpdateTime');
        if (updateTimeEl) {
          updateTimeEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        // Update uptime (simulated since server doesn't provide it, based on build date or session)
        updateServerUptime(buildDate);

        // Load auth files count
        api('GET', '/auth-files').then(d => document.getElementById('statAuthFiles').textContent = (d.files || []).length).catch(() => { });

        // Load models count
        fetchModels().then(models => {
          document.getElementById('statModels').textContent = models.length;
          allModels = models;
        }).catch(() => document.getElementById('statModels').textContent = '-');

        // Update health indicator
        const healthIndicator = document.getElementById('healthIndicator');
        if (healthIndicator) {
          healthIndicator.classList.remove('offline');
          healthIndicator.querySelector('.health-text').textContent = 'Online';
        }
      }

      catch (e) {
        toast('Failed to load dashboard: ' + e.message, 'error');
        statCards.forEach(card => card.classList.remove('loading'));
        
        // Update health indicator to offline
        const healthIndicator = document.getElementById('healthIndicator');
        if (healthIndicator) {
          healthIndicator.classList.add('offline');
          healthIndicator.querySelector('.health-text').textContent = 'Offline';
        }
      } finally {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
        }
        if (lastUpdatedEl) {
          lastUpdatedEl.classList.remove('refreshing');
        }
      }
    }

    function updateServerUptime(buildDate) {
      const uptimeEl = document.getElementById('serverUptime');
      if (!uptimeEl) return;

      // Calculate uptime from session start or build date
      const now = Date.now();
      const uptimeMs = now - dashboardStartTime;
      
      const seconds = Math.floor(uptimeMs / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      let uptimeStr = '';
      if (days > 0) uptimeStr = `${days}d ${hours % 24}h ${minutes % 60}m`;
      else if (hours > 0) uptimeStr = `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      else if (minutes > 0) uptimeStr = `${minutes}m ${seconds % 60}s`;
      else uptimeStr = `${seconds}s`;

      uptimeEl.textContent = uptimeStr + ' (session)';
    }

    // Update uptime every second
    setInterval(() => {
      const uptimeEl = document.getElementById('serverUptime');
      if (uptimeEl && uptimeEl.textContent !== '-') {
        updateServerUptime();
      }
    }, 1000);

    let allModels = [];
    let accessApiKeys = [];

    async function fetchModels() {

      // Try with management key first
      let res = await fetch('/v1/models', {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });

      if (res.ok) {
        const data = await res.json();
        return data.data || data.models || [];
      }

      // Try with access keys from config
      if (accessApiKeys.length > 0) {
        for (const key of accessApiKeys) {
          res = await fetch('/v1/models', {
            headers: {
              'Authorization': `Bearer ${key}`
            }
          });

          if (res.ok) {
            const data = await res.json();
            return data.data || data.models || [];
          }
        }
      }

      // Try without auth
      res = await fetch('/v1/models');

      if (res.ok) {
        const data = await res.json();
        return data.data || data.models || [];
      }

      throw new Error('API authentication required');
    }

    async function loadModels() {
      const refreshBtn = document.getElementById('modelsRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
      }
      
      const container = document.getElementById('modelsContainer');
      container.innerHTML = `
        <div class="models-loading">
          <div class="models-loading-spinner"></div>
          <p>Loading models...</p>
        </div>
      `;
      
      try {
        const cfg = await api('GET', '/config').catch(() => ({}));
        accessApiKeys = cfg['api-keys'] || cfg.api_keys || [];
        const models = await fetchModels();
        allModels = models;
        currentProviderFilter = 'all';
        updateProviderFilters(models);
        renderModels(models);
      } catch (e) {
        container.innerHTML = `
          <div class="models-empty">
            <div class="models-empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
            </div>
            <h4>Could not load models</h4>
            <p>The /v1/models endpoint requires API authentication. Add access keys in the <strong>API Keys</strong> tab or check your auth files.</p>
          </div>
        `;
      } finally {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
        }
      }
    }

    let currentProviderFilter = 'all';

    function getProviderIcon(provider) {
      const p = provider.toLowerCase();
      if (p.includes('anthropic') || p.includes('claude')) return { icon: '', class: 'anthropic' };
      if (p.includes('google') || p.includes('gemini')) return { icon: '', class: 'google' };
      if (p.includes('openai') || p.includes('gpt')) return { icon: '', class: 'openai' };
      if (p.includes('meta') || p.includes('llama')) return { icon: '', class: 'other' };
      if (p.includes('mistral')) return { icon: '', class: 'other' };
      if (p.includes('codex')) return { icon: '', class: 'other' };
      return { icon: '', class: 'other' };
    }

    function updateProviderFilters(models) {
      const providers = new Set();
      models.forEach(m => {
        const owner = m.owned_by || m.provider || 'other';
        providers.add(owner);
      });
      
      const pillsContainer = document.getElementById('modelsFilterPills');
      let html = `<button class="models-filter-pill active" data-provider="all" onclick="filterModelsByProvider('all')">All</button>`;
      
      Array.from(providers).sort().forEach(provider => {
        const count = models.filter(m => (m.owned_by || m.provider || 'other') === provider).length;
        html += `<button class="models-filter-pill" data-provider="${provider}" onclick="filterModelsByProvider('${provider}')">${provider} <span style="opacity:0.7">(${count})</span></button>`;
      });
      
      pillsContainer.innerHTML = html;
    }

    function filterModelsByProvider(provider) {
      currentProviderFilter = provider;
      
      document.querySelectorAll('.models-filter-pill').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.provider === provider);
      });
      
      filterModels();
    }

    function renderModels(models) {
      const container = document.getElementById('modelsContainer');
      const countEl = document.getElementById('modelsTotalCount');
      
      countEl.textContent = `${models.length} model${models.length !== 1 ? 's' : ''}`;

      if (!models.length) {
        container.innerHTML = `
          <div class="models-empty">
            <div class="models-empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              </svg>
            </div>
            <h4>No models found</h4>
            <p>Try adjusting your search or filter criteria.</p>
          </div>
        `;
        return;
      }

      const grouped = {};
      models.forEach(m => {
        const id = m.id || m.name || 'unknown';
        const owner = m.owned_by || m.provider || 'other';
        if (!grouped[owner]) grouped[owner] = [];
        grouped[owner].push(id);
      });

      container.innerHTML = Object.entries(grouped).sort((a, b) => a[0].localeCompare(b[0])).map(([owner, modelList]) => {
        const { icon, class: iconClass } = getProviderIcon(owner);
        return `
          <div class="models-provider-card" data-provider="${owner}">
            <div class="models-provider-header" onclick="toggleProviderCard(this.parentElement)">
              <div class="models-provider-info">
                <div class="models-provider-icon ${iconClass}">${icon}</div>
                <span class="models-provider-name">${owner}</span>
                <span class="models-provider-count">${modelList.length} model${modelList.length !== 1 ? 's' : ''}</span>
              </div>
              <div class="models-provider-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </div>
            </div>
            <div class="models-list">
              ${modelList.map(id => `
                <div class="model-badge" onclick="copyModelId(this, '${id}')" title="Click to copy">
                  <span>${id}</span>
                  <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleProviderCard(card) {
      card.classList.toggle('collapsed');
    }

    function copyModelId(element, id) {
      navigator.clipboard.writeText(id).then(() => {
        element.classList.add('copied');
        setTimeout(() => {
          element.classList.remove('copied');
        }, 1500);
      }).catch(() => {
        toast('Failed to copy', 'error');
      });
    }

    function clearModelSearch() {
      document.getElementById('modelSearch').value = '';
      document.getElementById('modelSearchClear').style.display = 'none';
      filterModels();
    }

    function filterModels() {
      const search = document.getElementById('modelSearch').value.toLowerCase();
      const clearBtn = document.getElementById('modelSearchClear');
      
      clearBtn.style.display = search ? 'flex' : 'none';

      let filtered = allModels;
      
      if (currentProviderFilter !== 'all') {
        filtered = filtered.filter(m => {
          const owner = m.owned_by || m.provider || 'other';
          return owner === currentProviderFilter;
        });
      }
      
      if (search) {
        filtered = filtered.filter(m => {
          const id = (m.id || m.name || '').toLowerCase();
          const owner = (m.owned_by || m.provider || '').toLowerCase();
          return id.includes(search) || owner.includes(search);
        });
      }
      
      renderModels(filtered);
    }

    async function checkLatestVersion() {
      const checkBtn = document.getElementById('checkUpdateBtn');
      if (checkBtn) {
        checkBtn.classList.add('loading');
        checkBtn.disabled = true;
      }
      
      try {
        const d = await api('GET', '/latest-version');
        const latestVersion = d['latest-version'] || '-';
        document.getElementById('latestVersion').textContent = latestVersion;
        
        // Compare versions and update badge
        updateVersionBadge(currentServerVersion, latestVersion);
        
        toast('Version check complete', 'success');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
        
        // Reset badge to unknown
        const badge = document.getElementById('versionStatusBadge');
        const badgeText = document.getElementById('versionStatusText');
        if (badge && badgeText) {
          badge.className = 'version-badge unknown';
          badgeText.textContent = 'Check Failed';
        }
      } finally {
        if (checkBtn) {
          checkBtn.classList.remove('loading');
          checkBtn.disabled = false;
        }
      }
    }

    function updateVersionBadge(current, latest) {
      const badge = document.getElementById('versionStatusBadge');
      const badgeText = document.getElementById('versionStatusText');
      if (!badge || !badgeText) return;

      if (!current || current === '-' || !latest || latest === '-') {
        badge.className = 'version-badge unknown';
        badge.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span id="versionStatusText">Unknown</span>
        `;
        return;
      }

      // Compare versions (simple string comparison, works for semver)
      const isUpToDate = compareVersions(current, latest) >= 0;
      
      if (isUpToDate) {
        badge.className = 'version-badge up-to-date';
        badge.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span id="versionStatusText">Up to date</span>
        `;
      } else {
        badge.className = 'version-badge outdated';
        badge.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span id="versionStatusText">Update available</span>
        `;
      }
    }

    function compareVersions(v1, v2) {
      // Remove 'v' prefix if present
      v1 = v1.replace(/^v/, '');
      v2 = v2.replace(/^v/, '');
      
      const parts1 = v1.split('.').map(p => parseInt(p, 10) || 0);
      const parts2 = v2.split('.').map(p => parseInt(p, 10) || 0);
      
      for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
        const p1 = parts1[i] || 0;
        const p2 = parts2[i] || 0;
        if (p1 > p2) return 1;
        if (p1 < p2) return -1;
      }
      return 0;
    }

    // XSS protection helper
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Format numbers with appropriate suffixes
    function formatNumber(num, decimals = 1) {
      if (num >= 1000000) return (num / 1000000).toFixed(decimals) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(decimals) + 'k';
      return num.toLocaleString();
    }

    // Get period label for date range
    function getPeriodLabel(range) {
      switch (range) {
        case 'today': return 'Today';
        case '7d': return 'Last 7 days';
        case '30d': return 'Last 30 days';
        default: return 'All time';
      }
    }

    async function loadUsageStats() {
      const refreshBtn = document.getElementById('usageRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
      }

      try {
        const d = await api('GET', '/usage');
        const u = d.usage || {};

        // Store raw data for filtering
        usageState.rawData = u;

        // Update last updated timestamp
        const updateTimeEl = document.getElementById('usageUpdateTime');
        if (updateTimeEl) {
          updateTimeEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        // Render with current date range filter
        renderUsageData(u);
      } catch (e) {
        toast('Failed to load usage stats: ' + e.message, 'error');
        console.error(e);
      } finally {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
        }
      }
    }

    function renderUsageData(usageData) {
      if (!usageData) return;

      const range = usageState.dateRange;
      const periodLabel = getPeriodLabel(range);

      // Calculate filtered totals based on date range
      const reqByDay = usageData.requests_by_day || {};
      const filteredReqByDay = filterDataByDateRange(reqByDay, range);
      const filteredTotal = Object.values(filteredReqByDay).reduce((a, b) => a + b, 0);

      // Get all-time totals
      const allTimeTotal = usageData.total_requests || 0;
      const allTimeSuccess = usageData.success_count || 0;
      const allTimeFailed = usageData.failure_count || 0;

      // Calculate values for the selected period
      let total, success, failed;
      if (range === 'all') {
        total = allTimeTotal;
        success = allTimeSuccess;
        failed = allTimeFailed;
      } else {
        total = filteredTotal;
        const failRatio = allTimeTotal > 0 ? allTimeFailed / allTimeTotal : 0;
        failed = Math.round(total * failRatio);
        success = total - failed;
      }

      // Fix: Show '-' or '0%' when no requests instead of 100%
      const rate = total > 0 ? ((success / total) * 100).toFixed(1) : '-';

      // Update stat cards
      document.getElementById('usageTotalRequests').textContent = total.toLocaleString();
      document.getElementById('usageSuccessful').textContent = success.toLocaleString();
      document.getElementById('usageFailed').textContent = failed.toLocaleString();
      document.getElementById('usageSuccessRate').textContent = rate === '-' ? '-' : rate + '%';

      // Update period labels
      const periodElements = ['usageReqPeriod', 'usageSuccessPeriod', 'usageFailedPeriod', 'usageRatePeriod'];
      periodElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = periodLabel;
      });

      // Update success rate indicator
      const rateIndicator = document.getElementById('usageRateIndicator');
      if (rateIndicator) {
        if (rate === '-' || parseFloat(rate) >= 95) {
          rateIndicator.classList.remove('down');
        } else {
          rateIndicator.classList.add('down');
        }
      }

      // Deep aggregation for tokens
      let totalInput = 0;
      let totalOutput = 0;
      let totalReasoning = 0;
      let totalCacheRead = 0;
      let totalCacheWrite = 0;

      const providerUsage = {};
      const modelUsage = {};
      const apis = usageData.apis || {};

      if (typeof apis === 'object') {
        for (const [apiKey, apiStats] of Object.entries(apis)) {
          if (!apiStats || typeof apiStats !== 'object') continue;

          const pKey = apiKey || 'unknown';
          if (!providerUsage[pKey]) providerUsage[pKey] = { requests: 0, tokens: 0 };
          providerUsage[pKey].requests += (apiStats.total_requests || 0);
          providerUsage[pKey].tokens += (apiStats.total_tokens || 0);

          const models = apiStats.models || {};
          for (const [modelName, modelStats] of Object.entries(models)) {
            if (!modelStats || typeof modelStats !== 'object') continue;

            if (!modelUsage[modelName]) modelUsage[modelName] = { requests: 0, tokens: 0 };
            modelUsage[modelName].requests += (modelStats.total_requests || 0);
            modelUsage[modelName].tokens += (modelStats.total_tokens || 0);

            const details = modelStats.details || [];
            for (const detail of details) {
              const t = detail.tokens || {};
              totalInput += (t.input_tokens || 0);
              totalOutput += (t.output_tokens || 0);
              totalReasoning += (t.reasoning_tokens || 0);
              totalCacheRead += (t.cached_tokens || 0);
              // Fix: Also count cache write tokens
              totalCacheWrite += (t.cache_creation_input_tokens || t.cache_write_tokens || 0);
            }
          }
        }
      }

      document.getElementById('usageTotalTokens').textContent = formatNumber(totalInput + totalOutput + totalReasoning);
      document.getElementById('usageInputTokens').textContent = formatNumber(totalInput);
      document.getElementById('usageOutputTokens').textContent = formatNumber(totalOutput);
      document.getElementById('usageReasoningTokens').textContent = totalReasoning > 0 ? formatNumber(totalReasoning) : '-';
      document.getElementById('usageCacheRead').textContent = totalCacheRead > 0 ? formatNumber(totalCacheRead) : '-';
      document.getElementById('usageCacheWrite').textContent = totalCacheWrite > 0 ? formatNumber(totalCacheWrite) : '-';

      // Render Providers with XSS protection
      renderProviderStats(providerUsage);

      // Render Models with sortable table
      renderModelStats(modelUsage);

      // Render Charts
      renderUsageChartsUnified(usageData);
    }

    function renderProviderStats(providerUsage) {
      const providerContainer = document.getElementById('providerStats');
      if (!providerContainer) return;

      const pEntries = Object.entries(providerUsage).sort((a, b) => b[1].requests - a[1].requests);

      if (pEntries.length === 0) {
        providerContainer.innerHTML = `
          <div style="padding:32px;text-align:center;color:var(--text-secondary)">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:12px">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p style="margin:0;font-size:14px">No provider data yet</p>
          </div>`;
        return;
      }

      providerContainer.innerHTML = '<div class="config-settings-list">' + pEntries.map(([name, stats]) => `
        <div class="config-setting-item" style="padding:12px 16px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
          <div class="config-setting-info">
            <div class="config-setting-text">
              <h4 style="font-family:monospace;font-size:13px" title="${escapeHtml(name)}">${escapeHtml(name.length > 25 ? name.slice(0, 22) + '...' : name)}</h4>
              <p>${formatNumber(stats.tokens)} tokens</p>
            </div>
          </div>
          <span class="badge badge-purple">${stats.requests.toLocaleString()}</span>
        </div>
      `).join('') + '</div>';
    }

    // Model stats sorting state
    let modelSortColumn = 'requests';
    let modelSortDir = 'desc';

    function sortModelStats(column) {
      if (modelSortColumn === column) {
        modelSortDir = modelSortDir === 'desc' ? 'asc' : 'desc';
      } else {
        modelSortColumn = column;
        modelSortDir = 'desc';
      }
      if (usageState.rawData) {
        renderUsageData(usageState.rawData);
      }
    }

    function renderModelStats(modelUsage) {
      const modelContainer = document.getElementById('modelStats');
      if (!modelContainer) return;

      const mEntries = Object.entries(modelUsage);

      if (mEntries.length === 0) {
        modelContainer.innerHTML = `
          <div style="padding:32px;text-align:center;color:var(--text-secondary)">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:12px">
              <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
              <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
            </svg>
            <p style="margin:0;font-size:14px">No model usage data yet</p>
          </div>`;
        return;
      }

      // Sort entries
      mEntries.sort((a, b) => {
        let aVal, bVal;
        switch (modelSortColumn) {
          case 'name':
            aVal = a[0].toLowerCase();
            bVal = b[0].toLowerCase();
            break;
          case 'tokens':
            aVal = a[1].tokens;
            bVal = b[1].tokens;
            break;
          default:
            aVal = a[1].requests;
            bVal = b[1].requests;
        }
        if (aVal < bVal) return modelSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return modelSortDir === 'asc' ? 1 : -1;
        return 0;
      });

      const getSortIcon = (col) => {
        if (modelSortColumn !== col) return '<span style="opacity:0.3"></span>';
        return modelSortDir === 'desc' ? '' : '';
      };

      modelContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th onclick="sortModelStats('name')" style="cursor:pointer;user-select:none">
                Model Name ${getSortIcon('name')}
              </th>
              <th onclick="sortModelStats('requests')" style="cursor:pointer;user-select:none;text-align:right">
                Requests ${getSortIcon('requests')}
              </th>
              <th onclick="sortModelStats('tokens')" style="cursor:pointer;user-select:none;text-align:right">
                Tokens ${getSortIcon('tokens')}
              </th>
            </tr>
          </thead>
          <tbody>
            ${mEntries.map(([name, stats]) => `
              <tr>
                <td><span style="color:var(--accent-cyan);font-weight:500">${escapeHtml(name)}</span></td>
                <td style="text-align:right">${stats.requests.toLocaleString()}</td>
                <td style="font-family:monospace;text-align:right">${formatNumber(stats.tokens)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    }

    let requestsChartInstance = null;
    let tokensChartInstance = null;

    function renderUsageChartsUnified(usageData) {
      const view = usageState.chartView;
      const range = usageState.dateRange;

      let reqData, tokData, labelFormatter;

      if (view === 'hourly') {
        reqData = usageData.requests_by_hour || {};
        tokData = usageData.tokens_by_hour || {};
        // Fix: Sort hourly keys numerically
        labelFormatter = (h) => {
          const hour = parseInt(h, 10);
          return isNaN(hour) ? h : `${hour}:00`;
        };
      } else {
        reqData = filterDataByDateRange(usageData.requests_by_day || {}, range);
        tokData = filterDataByDateRange(usageData.tokens_by_day || {}, range);
        labelFormatter = (d) => {
          // Better date formatting
          try {
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          } catch {
            return d.slice(5);
          }
        };
      }

      // Fix: Sort keys properly (numerically for hours, lexicographically for dates)
      let keys = [...new Set([...Object.keys(reqData), ...Object.keys(tokData)])];
      if (view === 'hourly') {
        keys = keys.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
      } else {
        keys = keys.sort();
      }

      const reqValues = keys.map(k => reqData[k] || 0);
      const tokValues = keys.map(k => tokData[k] || 0);

      // Update chart period labels
      const viewLabel = view === 'hourly' ? 'Hourly' : 'Daily';
      const periodLabel = getPeriodLabel(range);
      const reqPeriodEl = document.getElementById('requestChartPeriod');
      const tokPeriodEl = document.getElementById('tokenChartPeriod');
      if (reqPeriodEl) reqPeriodEl.textContent = `${viewLabel} requests  ${periodLabel}`;
      if (tokPeriodEl) tokPeriodEl.textContent = `${viewLabel} tokens  ${periodLabel}`;

      // Update totals
      const totalReq = reqValues.reduce((a, b) => a + b, 0);
      const totalTok = tokValues.reduce((a, b) => a + b, 0);

      const trendReqEl = document.getElementById('trendRequestTotal');
      const trendTokEl = document.getElementById('trendTokenTotal');
      if (trendReqEl) trendReqEl.textContent = totalReq.toLocaleString();
      if (trendTokEl) trendTokEl.textContent = formatNumber(totalTok);

      // Show/hide empty state
      const reqEmptyEl = document.getElementById('requestsChartEmpty');
      const tokEmptyEl = document.getElementById('tokensChartEmpty');
      const hasReqData = reqValues.some(v => v > 0);
      const hasTokData = tokValues.some(v => v > 0);

      if (reqEmptyEl) reqEmptyEl.style.display = hasReqData ? 'none' : 'flex';
      if (tokEmptyEl) tokEmptyEl.style.display = hasTokData ? 'none' : 'flex';

      // Chart styling
      Chart.defaults.color = '#8888aa';
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';

      // Requests Chart
      const ctxReq = document.getElementById('requestsChart')?.getContext('2d');
      if (ctxReq) {
        const gradReq = ctxReq.createLinearGradient(0, 0, 0, 200);
        gradReq.addColorStop(0, 'rgba(0, 229, 255, 0.25)');
        gradReq.addColorStop(1, 'rgba(0, 229, 255, 0)');

        if (requestsChartInstance) requestsChartInstance.destroy();
        requestsChartInstance = new Chart(ctxReq, {
          type: 'line',
          data: {
            labels: keys.map(labelFormatter),
            datasets: [{
              label: 'Requests',
              data: reqValues,
              borderColor: '#00e5ff',
              backgroundColor: gradReq,
              borderWidth: 2,
              tension: 0.4,
              fill: true,
              pointRadius: 0,
              pointHoverRadius: 5,
              pointBackgroundColor: '#0d0d1a',
              pointBorderColor: '#00e5ff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(20, 20, 35, 0.95)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                borderColor: 'rgba(0, 229, 255, 0.3)',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                displayColors: false,
                callbacks: {
                  title: function(items) {
                    return items[0]?.label || '';
                  },
                  label: function(context) {
                    return `${context.parsed.y.toLocaleString()} requests`;
                  }
                }
              }
            },
            scales: {
              x: { grid: { display: false }, ticks: { maxRotation: 0 } },
              y: { beginAtZero: true, border: { display: false } }
            }
          }
        });
      }

      // Tokens Chart
      const ctxTok = document.getElementById('tokensChart')?.getContext('2d');
      if (ctxTok) {
        const gradTok = ctxTok.createLinearGradient(0, 0, 0, 200);
        gradTok.addColorStop(0, '#a78bfa');
        gradTok.addColorStop(1, 'rgba(167, 139, 250, 0.1)');

        if (tokensChartInstance) tokensChartInstance.destroy();
        tokensChartInstance = new Chart(ctxTok, {
          type: 'bar',
          data: {
            labels: keys.map(labelFormatter),
            datasets: [{
              label: 'Tokens',
              data: tokValues,
              backgroundColor: gradTok,
              borderRadius: 4,
              borderSkipped: false,
              barThickness: 'flex',
              maxBarThickness: 32,
              hoverBackgroundColor: '#8b5cf6'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(20, 20, 35, 0.95)',
                titleColor: '#fff',
                bodyColor: '#ccc',
                borderColor: 'rgba(167, 139, 250, 0.3)',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                displayColors: false,
                callbacks: {
                  label: function(context) {
                    return `${formatNumber(context.parsed.y)} tokens`;
                  }
                }
              }
            },
            scales: {
              x: { grid: { display: false }, ticks: { maxRotation: 0 } },
              y: { 
                beginAtZero: true, 
                border: { display: false }, 
                ticks: { 
                  callback: function(value) { 
                    return formatNumber(value); 
                  } 
                } 
              }
            }
          }
        });
      }
    }

    // Usage stats state
    let usageState = {
      dateRange: 'all',
      chartView: 'daily',
      rawData: null
    };

    function setUsageDateRange(range) {
      usageState.dateRange = range;
      
      // Update button states and ARIA
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        const isActive = btn.dataset.range === range;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      
      // Re-render with new date range
      if (usageState.rawData) {
        renderUsageData(usageState.rawData);
      }
    }

    function setChartView(view) {
      usageState.chartView = view;
      
      // Update button states and ARIA
      document.querySelectorAll('.chart-view-btn').forEach(btn => {
        const isActive = btn.dataset.view === view;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      
      // Re-render charts with new view
      if (usageState.rawData) {
        renderUsageChartsUnified(usageState.rawData);
      }
    }

    function filterDataByDateRange(data, range) {
      if (range === 'all' || !data) return data;
      
      const now = new Date();
      let cutoff;
      
      if (range === 'today') {
        cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      } else if (range === '7d') {
        cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else if (range === '30d') {
        cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      } else {
        return data;
      }
      
      const filtered = {};
      for (const [key, value] of Object.entries(data)) {
        try {
          const date = new Date(key);
          if (!isNaN(date.getTime()) && date >= cutoff) {
            filtered[key] = value;
          }
        } catch {
          // Skip invalid date keys
        }
      }
      return filtered;
    }

    function exportUsageData() {
      if (!usageState.rawData) {
        toast('No usage data available to export', 'info');
        return;
      }
      
      const range = usageState.dateRange;
      const data = usageState.rawData;
      
      // Export filtered data based on current range
      const filteredReqByDay = filterDataByDateRange(data.requests_by_day || {}, range);
      const filteredTokByDay = filterDataByDateRange(data.tokens_by_day || {}, range);
      
      const exportObj = {
        exported_at: new Date().toISOString(),
        date_range: getPeriodLabel(range),
        summary: {
          total_requests: data.total_requests || 0,
          success_count: data.success_count || 0,
          failure_count: data.failure_count || 0,
          total_tokens: data.total_tokens || 0
        },
        requests_by_day: filteredReqByDay,
        tokens_by_day: filteredTokByDay,
        apis: data.apis || {}
      };
      
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cliproxy-usage-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Usage data exported successfully', 'success');
    }

    // Analytics page state
    let analyticsData = { 
      failures: [], 
      allFailures: [],
      currentPage: 1,
      pageSize: 50,
      sortBy: 'timestamp',
      sortDir: 'desc',
      totalRequests: 0,
      failureCount: 0,
      providerFailures: {},
      dailyFailures: []
    };
    
    let analyticsFilterTimeout = null;

    // Debounced filter for search input
    function debounceFilterAnalytics() {
      clearTimeout(analyticsFilterTimeout);
      analyticsFilterTimeout = setTimeout(filterAnalytics, 300);
    }

    // Get severity level from HTTP status
    function getSeverity(httpStatus) {
      if (!httpStatus) return { level: 'low', label: 'Unknown', class: 'low' };
      if (httpStatus >= 500) return { level: 'critical', label: 'Critical', class: 'critical' };
      if (httpStatus === 429 || httpStatus === 408) return { level: 'high', label: 'High', class: 'high' };
      if (httpStatus >= 400) return { level: 'medium', label: 'Medium', class: 'medium' };
      return { level: 'low', label: 'Low', class: 'low' };
    }

    // Generate sparkline data
    function generateSparklineData(failures, days = 7) {
      const now = new Date();
      const data = [];
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const dateStr = date.toISOString().split('T')[0];
        const count = failures.filter(f => f.timestamp.split('T')[0] === dateStr).length;
        data.push(count);
      }
      return data;
    }

    // Render sparkline
    function renderSparkline(containerId, data, color) {
      const container = document.getElementById(containerId);
      if (!container || !data.length) return;
      
      const maxVal = Math.max(...data, 1);
      container.innerHTML = data.map(val => {
        const height = Math.max(4, (val / maxVal) * 100);
        return `<div class="analytics-sparkline-bar" style="height:${height}%"></div>`;
      }).join('');
    }

    // Update active filters indicator
    function updateActiveFiltersIndicator() {
      const provider = document.getElementById('analyticsProviderFilter')?.value || '';
      const model = document.getElementById('analyticsModelFilter')?.value || '';
      const severity = document.getElementById('analyticsSeverityFilter')?.value || '';
      const timeRange = document.getElementById('analyticsTimeFilter')?.value || 'all';
      const search = document.getElementById('analyticsSearchFilter')?.value || '';
      
      let count = 0;
      if (provider) count++;
      if (model) count++;
      if (severity) count++;
      if (timeRange !== 'all') count++;
      if (search) count++;
      
      const indicator = document.getElementById('analyticsFiltersActive');
      const countEl = document.getElementById('analyticsActiveCount');
      
      if (indicator && countEl) {
        if (count > 0) {
          countEl.textContent = count;
          indicator.classList.add('visible');
        } else {
          indicator.classList.remove('visible');
        }
      }
    }

    // Clear all filters
    function clearAnalyticsFilters() {
      const providerEl = document.getElementById('analyticsProviderFilter');
      const modelEl = document.getElementById('analyticsModelFilter');
      const severityEl = document.getElementById('analyticsSeverityFilter');
      const timeEl = document.getElementById('analyticsTimeFilter');
      const searchEl = document.getElementById('analyticsSearchFilter');
      
      if (providerEl) providerEl.value = '';
      if (modelEl) modelEl.value = '';
      if (severityEl) severityEl.value = '';
      if (timeEl) timeEl.value = 'all';
      if (searchEl) searchEl.value = '';
      
      analyticsData.currentPage = 1;
      filterAnalytics();
    }

    // Show/hide error banner
    function showAnalyticsError(message) {
      const banner = document.getElementById('analyticsErrorBanner');
      const msgEl = document.getElementById('analyticsErrorMessage');
      if (banner && msgEl) {
        msgEl.textContent = message;
        banner.classList.add('visible');
      }
    }

    function hideAnalyticsError() {
      const banner = document.getElementById('analyticsErrorBanner');
      if (banner) banner.classList.remove('visible');
    }

    async function loadAnalytics() {
      const refreshBtn = document.getElementById('analyticsRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
      }
      
      hideAnalyticsError();
      
      try {
        const d = await api('GET', '/usage');
        const u = d.usage || {};
        const apis = u.apis || {};

        // Collect all failed requests
        const failures = [];
        const providerFailures = {};
        const modelFailures = {};
        const providers = new Set();
        const models = new Set();

        const total = u.total_requests || 0;
        const failed = u.failure_count || 0;
        const today = new Date().toISOString().split('T')[0];
        let failedToday = 0;
        let failedYesterday = 0;
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        for (const [apiKey, apiStats] of Object.entries(apis)) {
          const modelsData = apiStats.models || {};

          for (const [modelName, modelStats] of Object.entries(modelsData)) {
            const details = modelStats.details || [];

            for (const detail of details) {
              models.add(modelName);

              // Determine provider from source or apiKey
              const provider = detail.source || apiKey || 'unknown';
              providers.add(provider);

              if (detail.failed) {
                const timestamp = detail.timestamp || new Date().toISOString();
                const dateOnly = timestamp.split('T')[0];
                const severity = getSeverity(detail.http_status || 0);

                failures.push({
                  timestamp,
                  provider,
                  model: modelName,
                  source: detail.source || '-',
                  authIndex: detail.auth_index,
                  tokens: detail.tokens || {},
                  errorCode: detail.error_code || '',
                  errorMessage: detail.error_message || '',
                  httpStatus: detail.http_status || 0,
                  severity: severity
                });

                // Count by provider
                providerFailures[provider] = (providerFailures[provider] || 0) + 1;
                // Count by model
                modelFailures[modelName] = (modelFailures[modelName] || 0) + 1;

                // Count today's and yesterday's failures
                if (dateOnly === today) failedToday++;
                if (dateOnly === yesterday) failedYesterday++;
              }
            }
          }
        }

        // Sort failures by timestamp descending (most recent first)
        failures.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // Store for filtering
        analyticsData.failures = failures;
        analyticsData.allFailures = failures;
        analyticsData.totalRequests = total;
        analyticsData.failureCount = failed;
        analyticsData.providerFailures = providerFailures;
        analyticsData.currentPage = 1;

        // Update summary cards with enhanced data
        const failedTotalEl = document.getElementById('analyticsFailedTotal');
        const failedTodayEl = document.getElementById('analyticsFailedToday');
        const successRateEl = document.getElementById('analyticsSuccessRate');
        const topProviderEl = document.getElementById('analyticsTopFailProvider');
        
        if (failedTotalEl) failedTotalEl.textContent = failed.toLocaleString();
        if (failedTodayEl) failedTodayEl.textContent = failedToday.toLocaleString();
        
        const successRate = total > 0 ? (((total - failed) / total) * 100).toFixed(1) : '100';
        if (successRateEl) successRateEl.textContent = successRate + '%';

        // Find top failed provider with count
        const topProvider = Object.entries(providerFailures).sort((a, b) => b[1] - a[1])[0];
        if (topProviderEl) {
          topProviderEl.textContent = topProvider ?
            (topProvider[0].length > 18 ? topProvider[0].slice(0, 15) + '...' : topProvider[0]) : '-';
        }
        
        const topProviderCountEl = document.getElementById('topProviderFailCount');
        if (topProviderCountEl && topProvider) {
          topProviderCountEl.textContent = `${topProvider[1]} failures`;
        }

        // Update trend indicators
        updateTrendIndicator('analyticsFailedTrend', failedToday, failedYesterday, true);
        
        // Generate and render sparklines
        const sparklineData = generateSparklineData(failures, 7);
        renderSparkline('sparklineTotal', sparklineData);
        renderSparkline('sparklineToday', sparklineData);
        renderSparkline('sparklineRate', sparklineData);

        // Update last updated time
        const updateTimeEl = document.getElementById('analyticsUpdateTime');
        if (updateTimeEl) {
          updateTimeEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        // Populate filter dropdowns
        const providerSelect = document.getElementById('analyticsProviderFilter');
        if (providerSelect) {
          providerSelect.innerHTML = '<option value="">All Providers</option>' +
            [...providers].sort().map(p => `<option value="${p}">${p.length > 30 ? p.slice(0, 27) + '...' : p}</option>`).join('');
        }

        const modelSelect = document.getElementById('analyticsModelFilter');
        if (modelSelect) {
          modelSelect.innerHTML = '<option value="">All Models</option>' +
            [...models].sort().map(m => `<option value="${m}">${m}</option>`).join('');
        }

        // Render failure breakdown by provider
        renderFailureBreakdown('failuresByProvider', providerFailures, 'No provider failures');

        // Render failure breakdown by model
        renderFailureBreakdown('failuresByModel', modelFailures, 'No model failures');

        // Render table with pagination
        renderAnalyticsTable(failures);

      } catch (e) {
        showAnalyticsError('Failed to load analytics: ' + e.message);
        toast('Failed to load analytics: ' + e.message, 'error');
        console.error(e);
      } finally {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
        }
      }
    }

    function updateTrendIndicator(elementId, current, previous, higherIsBad) {
      const el = document.getElementById(elementId);
      if (!el) return;
      
      let change = 0;
      if (previous > 0) {
        change = ((current - previous) / previous * 100).toFixed(0);
      } else if (current > 0) {
        change = 100;
      }
      
      let className = 'neutral';
      let icon = '<line x1="5" y1="12" x2="19" y2="12"></line>';
      
      if (change > 0) {
        className = higherIsBad ? 'up' : 'down';
        icon = '<polyline points="18 15 12 9 6 15"></polyline>';
      } else if (change < 0) {
        className = higherIsBad ? 'down' : 'up';
        icon = '<polyline points="6 9 12 15 18 9"></polyline>';
      }
      
      el.className = `analytics-stat-trend ${className}`;
      el.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${icon}
        </svg>
        <span>${change > 0 ? '+' : ''}${change}%</span>
      `;
    }

    function renderFailureBreakdown(containerId, data, emptyMessage) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);

      if (entries.length === 0) {
        container.innerHTML = `
          <div class="analytics-empty-state" style="padding:32px">
            <div class="analytics-empty-icon" style="width:48px;height:48px;margin-bottom:12px">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <div class="analytics-empty-title" style="font-size:14px">${emptyMessage}</div>
            <div class="analytics-empty-subtitle" style="font-size:12px">All systems operating normally</div>
          </div>`;
        return;
      }

      const maxVal = entries[0][1];
      container.innerHTML = entries.slice(0, 6).map(([name, count], idx) => {
        const pct = maxVal > 0 ? (count / maxVal * 100) : 0;
        const displayName = name.length > 20 ? name.slice(0, 17) + '...' : name;
        return `
          <div class="analytics-breakdown-item">
            <span class="analytics-breakdown-rank">${idx + 1}</span>
            <span class="analytics-breakdown-name" title="${name}">${displayName}</span>
            <div class="analytics-breakdown-bar-wrapper">
              <div class="analytics-breakdown-bar" style="width:${pct}%"></div>
            </div>
            <div class="analytics-breakdown-count">
              <span class="badge badge-red">${count}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAnalyticsTable(failures) {
      const tbody = document.getElementById('analyticsTable');
      const resultCountEl = document.getElementById('analyticsResultCount');
      
      if (!tbody) return;
      
      if (resultCountEl) {
        resultCountEl.textContent = `${failures.length} failure${failures.length !== 1 ? 's' : ''}`;
      }

      if (failures.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7">
          <div class="analytics-empty-state">
            <div class="analytics-empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <h3 class="analytics-empty-title">No Failed Requests</h3>
            <p class="analytics-empty-subtitle">Great news! No failures match your current filters. Your API is running smoothly.</p>
            <button class="btn btn-secondary btn-sm" onclick="clearAnalyticsFilters()">Reset Filters</button>
          </div>
        </td></tr>`;
        updatePagination(0);
        return;
      }

      // Apply sorting
      const sortedFailures = [...failures].sort((a, b) => {
        let aVal, bVal;
        switch(analyticsData.sortBy) {
          case 'timestamp':
            aVal = new Date(a.timestamp);
            bVal = new Date(b.timestamp);
            break;
          case 'severity':
            const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
            aVal = severityOrder[a.severity?.level] || 4;
            bVal = severityOrder[b.severity?.level] || 4;
            break;
          case 'provider':
            aVal = a.provider.toLowerCase();
            bVal = b.provider.toLowerCase();
            break;
          case 'model':
            aVal = a.model.toLowerCase();
            bVal = b.model.toLowerCase();
            break;
          case 'source':
            aVal = a.source.toLowerCase();
            bVal = b.source.toLowerCase();
            break;
          case 'status':
            aVal = a.httpStatus || 0;
            bVal = b.httpStatus || 0;
            break;
          default:
            aVal = a.timestamp;
            bVal = b.timestamp;
        }
        
        if (aVal < bVal) return analyticsData.sortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return analyticsData.sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      // Paginate
      const { currentPage, pageSize } = analyticsData;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = sortedFailures.slice(start, end);

      tbody.innerHTML = pageData.map(f => {
        const ts = new Date(f.timestamp);
        const timeStr = isNaN(ts) ? f.timestamp : ts.toLocaleString();
        const shortSource = f.source.length > 20 ? f.source.slice(0, 17) + '...' : f.source;
        const shortProvider = f.provider.length > 15 ? f.provider.slice(0, 12) + '...' : f.provider;

        // Severity indicator
        const severity = f.severity || getSeverity(f.httpStatus);
        const severityHtml = `
          <span class="severity-indicator">
            <span class="severity-dot ${severity.class}"></span>
            ${severity.label}
          </span>
        `;

        // Status badge
        let statusBadge = '<span class="badge badge-red">Error</span>';
        if (f.httpStatus) {
          const badgeClass = f.httpStatus >= 500 ? 'badge-red' : f.httpStatus >= 400 ? 'badge-yellow' : 'badge-cyan';
          statusBadge = `<span class="badge ${badgeClass}">${f.httpStatus}</span>`;
        } else if (f.errorCode) {
          const shortCode = f.errorCode.length > 12 ? f.errorCode.slice(0, 10) + '..' : f.errorCode;
          statusBadge = `<span class="badge badge-red" title="${f.errorCode}">${shortCode}</span>`;
        }

        const escapedF = JSON.stringify(f).replace(/"/g, '&quot;').replace(/'/g, '&#39;');

        return `<tr>
          <td style="font-size:12px;color:var(--text-secondary)">${timeStr}</td>
          <td>${severityHtml}</td>
          <td><span class="badge badge-purple">${shortProvider}</span></td>
          <td><span style="color:var(--accent-cyan);font-weight:500;font-size:13px">${f.model}</span></td>
          <td title="${f.source}" style="font-size:12px">${shortSource}</td>
          <td>${statusBadge}</td>
          <td>
            <button class="analytics-detail-btn" onclick='showFailureDetails(${escapedF})'>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              Details
            </button>
          </td>
        </tr>`;
      }).join('');

      updatePagination(sortedFailures.length);
    }

    function updatePagination(totalItems) {
      const { currentPage, pageSize } = analyticsData;
      const totalPages = Math.ceil(totalItems / pageSize);
      const start = totalItems === 0 ? 0 : (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, totalItems);
      
      const infoEl = document.getElementById('analyticsPaginationInfo');
      const prevBtn = document.getElementById('analyticsPrevBtn');
      const nextBtn = document.getElementById('analyticsNextBtn');
      const pageNumbersEl = document.getElementById('analyticsPageNumbers');
      
      if (infoEl) {
        infoEl.textContent = `Showing ${start}-${end} of ${totalItems} failures`;
      }
      
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      
      // Render page numbers
      if (pageNumbersEl) {
        let pages = [];
        const maxVisiblePages = 5;
        
        if (totalPages <= maxVisiblePages) {
          for (let i = 1; i <= totalPages; i++) pages.push(i);
        } else {
          if (currentPage <= 3) {
            pages = [1, 2, 3, 4, '...', totalPages];
          } else if (currentPage >= totalPages - 2) {
            pages = [1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
          } else {
            pages = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages];
          }
        }
        
        pageNumbersEl.innerHTML = pages.map(p => {
          if (p === '...') {
            return '<span class="analytics-page-num" style="cursor:default">...</span>';
          }
          return `<span class="analytics-page-num ${p === currentPage ? 'active' : ''}" onclick="goToAnalyticsPage(${p})">${p}</span>`;
        }).join('');
      }
    }

    function goToAnalyticsPage(page) {
      analyticsData.currentPage = page;
      renderAnalyticsTable(analyticsData.failures);
    }

    function changeAnalyticsPage(delta) {
      analyticsData.currentPage += delta;
      renderAnalyticsTable(analyticsData.failures);
    }

    function changeAnalyticsPageSize() {
      const select = document.getElementById('analyticsPageSize');
      if (select) {
        analyticsData.pageSize = parseInt(select.value, 10);
        analyticsData.currentPage = 1;
        renderAnalyticsTable(analyticsData.failures);
      }
    }

    function sortAnalyticsTable(column) {
      // Update sort direction
      if (analyticsData.sortBy === column) {
        analyticsData.sortDir = analyticsData.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        analyticsData.sortBy = column;
        analyticsData.sortDir = 'desc';
      }
      
      // Update header styling
      document.querySelectorAll('.analytics-table th').forEach(th => {
        th.classList.remove('sorted', 'desc', 'asc');
        if (th.dataset.sort === column) {
          th.classList.add('sorted', analyticsData.sortDir);
        }
      });
      
      analyticsData.currentPage = 1;
      renderAnalyticsTable(analyticsData.failures);
    }

    function filterAnalytics() {
      const providerEl = document.getElementById('analyticsProviderFilter');
      const modelEl = document.getElementById('analyticsModelFilter');
      const severityEl = document.getElementById('analyticsSeverityFilter');
      const timeEl = document.getElementById('analyticsTimeFilter');
      const searchEl = document.getElementById('analyticsSearchFilter');
      
      const provider = providerEl?.value || '';
      const model = modelEl?.value || '';
      const severity = severityEl?.value || '';
      const timeRange = timeEl?.value || 'all';
      const search = (searchEl?.value || '').toLowerCase();

      let filtered = [...analyticsData.allFailures];

      // Filter by provider
      if (provider) {
        filtered = filtered.filter(f => f.provider === provider);
      }

      // Filter by model
      if (model) {
        filtered = filtered.filter(f => f.model === model);
      }

      // Filter by severity
      if (severity) {
        filtered = filtered.filter(f => f.severity?.level === severity);
      }

      // Filter by time range
      if (timeRange !== 'all') {
        const now = new Date();
        let cutoff;
        if (timeRange === 'hour') {
          cutoff = new Date(now.getTime() - 60 * 60 * 1000);
        } else if (timeRange === 'today') {
          cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        } else if (timeRange === 'week') {
          cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (timeRange === 'month') {
          cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        if (cutoff) {
          filtered = filtered.filter(f => new Date(f.timestamp) >= cutoff);
        }
      }

      // Filter by search term
      if (search) {
        filtered = filtered.filter(f =>
          f.provider.toLowerCase().includes(search) ||
          f.model.toLowerCase().includes(search) ||
          f.source.toLowerCase().includes(search) ||
          (f.errorCode || '').toLowerCase().includes(search) ||
          (f.errorMessage || '').toLowerCase().includes(search)
        );
      }

      analyticsData.failures = filtered;
      analyticsData.currentPage = 1;
      updateActiveFiltersIndicator();
      renderAnalyticsTable(filtered);
    }

    function showFailureDetails(failure) {
      document.getElementById('modalTitle').textContent = 'Failure Details';
      
      // Get severity info
      const severity = failure.severity || getSeverity(failure.httpStatus);
      const severityColors = {
        critical: { bg: 'rgba(248, 113, 113, 0.1)', border: 'rgba(248, 113, 113, 0.3)', text: 'var(--accent-red)' },
        high: { bg: 'rgba(251, 191, 36, 0.1)', border: 'rgba(251, 191, 36, 0.3)', text: 'var(--accent-yellow)' },
        medium: { bg: 'rgba(0, 229, 255, 0.1)', border: 'rgba(0, 229, 255, 0.3)', text: 'var(--accent-cyan)' },
        low: { bg: 'rgba(136, 136, 170, 0.1)', border: 'rgba(136, 136, 170, 0.3)', text: 'var(--text-muted)' }
      };
      const colors = severityColors[severity.level] || severityColors.low;

      // Build header with severity badge
      const headerHtml = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border-color)">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:48px;height:48px;border-radius:12px;background:${colors.bg};display:flex;align-items:center;justify-content:center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${colors.text}" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
            </div>
            <div>
              <div style="font-weight:600;font-size:16px;margin-bottom:4px">${failure.model}</div>
              <div style="font-size:12px;color:var(--text-secondary)">${new Date(failure.timestamp).toLocaleString()}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="severity-indicator">
              <span class="severity-dot ${severity.class}"></span>
              ${severity.label}
            </span>
            ${failure.httpStatus ? `<span class="badge ${failure.httpStatus >= 500 ? 'badge-red' : failure.httpStatus >= 400 ? 'badge-yellow' : 'badge-cyan'}">${failure.httpStatus}</span>` : ''}
          </div>
        </div>
      `;

      // Build error section HTML
      let errorSection = '';
      if (failure.httpStatus || failure.errorCode || failure.errorMessage) {
        errorSection = `
          <div style="background:${colors.bg};border:1px solid ${colors.border};border-radius:12px;padding:16px;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${colors.text}" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span style="font-weight:600;color:${colors.text};font-size:14px">Error Details</span>
            </div>
            <div style="display:grid;gap:10px">
              ${failure.errorCode ? `
                <div style="display:flex;align-items:center;gap:12px">
                  <span style="color:var(--text-secondary);font-size:12px;min-width:90px">Error Code</span>
                  <code style="background:rgba(0,0,0,0.3);padding:6px 12px;border-radius:6px;font-size:12px;font-family:monospace">${failure.errorCode}</code>
                </div>
              ` : ''}
              ${failure.errorMessage ? `
                <div>
                  <span style="color:var(--text-secondary);font-size:12px;display:block;margin-bottom:8px">Message</span>
                  <pre style="background:rgba(0,0,0,0.4);padding:14px;border-radius:8px;overflow-x:auto;font-size:12px;white-space:pre-wrap;word-break:break-word;max-height:160px;overflow-y:auto;margin:0;color:var(--text-primary);border:1px solid rgba(255,255,255,0.05)">${failure.errorMessage}</pre>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      } else {
        errorSection = `
          <div style="background:rgba(136,136,170,0.08);border:1px dashed rgba(136,136,170,0.3);border-radius:12px;padding:24px;margin-bottom:20px;text-align:center">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin-bottom:12px">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <p style="color:var(--text-muted);font-size:13px;margin:0">No detailed error information captured.<br><span style="font-size:12px;opacity:0.8">Error details will be available for future failures.</span></p>
          </div>
        `;
      }

      // Build info grid
      const infoGridHtml = `
        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:16px;margin-bottom:20px">
          <div style="background:rgba(167, 139, 250, 0.08);border:1px solid rgba(167, 139, 250, 0.2);border-radius:10px;padding:14px">
            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Provider</div>
            <div style="font-weight:500;color:var(--accent-purple)">${failure.provider}</div>
          </div>
          <div style="background:rgba(0, 229, 255, 0.08);border:1px solid rgba(0, 229, 255, 0.2);border-radius:10px;padding:14px">
            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Model</div>
            <div style="font-weight:500;color:var(--accent-cyan)">${failure.model}</div>
          </div>
          <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:10px;padding:14px">
            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Source</div>
            <div style="font-size:13px;word-break:break-all;color:var(--text-primary)">${failure.source}</div>
          </div>
          <div style="background:rgba(251, 191, 36, 0.08);border:1px solid rgba(251, 191, 36, 0.2);border-radius:10px;padding:14px">
            <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Auth Index</div>
            <div style="font-weight:500;color:var(--accent-yellow)">${failure.authIndex !== undefined ? failure.authIndex : 'N/A'}</div>
          </div>
        </div>
      `;

      // Token info section
      const tokensHtml = (failure.tokens && Object.keys(failure.tokens).length > 0) ? `
        <div style="background:rgba(255,255,255,0.02);border:1px solid var(--border-color);border-radius:10px;padding:14px">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Token Usage
          </div>
          <pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;font-size:12px;margin:0;overflow-x:auto;color:var(--text-secondary)">${JSON.stringify(failure.tokens, null, 2)}</pre>
        </div>
      ` : '';

      document.getElementById('modalContent').innerHTML = `
        <div>
          ${headerHtml}
          ${errorSection}
          ${infoGridHtml}
          ${tokensHtml}
        </div>
      `;
      
      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="copyFailureToClipboard()" style="margin-right:auto">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy Details
        </button>
        <button class="btn btn-primary" onclick="closeModal()">Close</button>
      `;
      
      // Store failure for copy function
      window._currentFailureDetails = failure;
      
      document.getElementById('modal').classList.add('active');
    }
    
    function copyFailureToClipboard() {
      const f = window._currentFailureDetails;
      if (!f) return;
      
      const text = `Failure Details
================
Timestamp: ${new Date(f.timestamp).toLocaleString()}
Provider: ${f.provider}
Model: ${f.model}
Source: ${f.source}
Auth Index: ${f.authIndex !== undefined ? f.authIndex : 'N/A'}
HTTP Status: ${f.httpStatus || 'N/A'}
Error Code: ${f.errorCode || 'N/A'}
Error Message: ${f.errorMessage || 'N/A'}
Tokens: ${JSON.stringify(f.tokens, null, 2)}`;
      
      navigator.clipboard.writeText(text).then(() => {
        toast('Failure details copied to clipboard', 'success');
      }).catch(() => {
        toast('Failed to copy to clipboard', 'error');
      });
    }

    function exportAnalytics() {
      const failures = analyticsData.failures;
      if (failures.length === 0) {
        toast('No data to export', 'info');
        return;
      }

      // Create CSV content
      const headers = ['Timestamp', 'Provider', 'Model', 'Source', 'Auth Index', 'HTTP Status', 'Error Code', 'Error Message', 'Input Tokens', 'Output Tokens'];
      const rows = failures.map(f => [
        new Date(f.timestamp).toISOString(),
        f.provider,
        f.model,
        f.source,
        f.authIndex !== undefined ? f.authIndex : '',
        f.httpStatus || '',
        f.errorCode || '',
        f.errorMessage || '',
        f.tokens?.input_tokens || 0,
        f.tokens?.output_tokens || 0
      ]);

      const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))].join('\n');

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `failure-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      toast(`Exported ${failures.length} failures to CSV`, 'success');
    }

    async function loadAuthFiles() {
      const refreshBtn = document.getElementById('authFilesRefreshBtn');
      if (refreshBtn) {
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
      }
      
      try {
        const [d, usageRes] = await Promise.all([
          api('GET', '/auth-files'),
          api('GET', '/usage').catch(() => ({ usage: {} }))
        ]);

        const usageApis = (usageRes.usage && usageRes.usage.apis) || {};
        const tbody = document.getElementById('authFilesTable');

        if (!d.files?.length) {
          tbody.innerHTML = `<tr><td colspan="7">
            <div class="auth-table-empty">
              <div class="auth-table-empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
              </div>
              <h4>No auth files yet</h4>
              <p>Connect via OAuth or upload an auth file to get started</p>
            </div>
          </td></tr>`;
          return;
        }

        const statsByAuthIndex = {};
        Object.values(usageApis).forEach(apiStats => {
          if (apiStats.models) {
            Object.values(apiStats.models).forEach(modelStats => {
              if (modelStats.details) {
                modelStats.details.forEach(detail => {
                  const idx = detail.auth_index;
                  if (idx !== undefined && idx !== null) {
                    if (!statsByAuthIndex[idx]) {
                      statsByAuthIndex[idx] = { requests: 0, failed: 0 };
                    }
                    statsByAuthIndex[idx].requests++;
                    if (detail.failed) {
                      statsByAuthIndex[idx].failed++;
                    }
                  }
                });
              }
            });
          }
        });

        const providerEmojis = {
          'anthropic': '', 'claude': '',
          'gemini': '', 'gemini-cli': '',
          'codex': '', 'openai': '',
          'antigravity': '',
          'qwen': '',
          'iflow': ''
        };

        tbody.innerHTML = d.files.map(f => {
          const provider = f.provider || f.type || 'unknown';
          const email = f.email || '-';
          const filename = f.name || '-';
          const project = f.project || f.project_id || '-';
          const region = f.region || '-';
          const emoji = providerEmojis[provider.toLowerCase()] || '';

          let stats = usageApis[f.id] || usageApis[f.name] || usageApis[f.email] || usageApis[f.account] || usageApis[project] || {};
          let requests = stats.total_requests || 0;
          let failed = 0;

          if (stats.models) {
            Object.values(stats.models).forEach(m => {
              if (m.details) {
                m.details.forEach(d => {
                  if (d.failed) failed++;
                });
              }
            });
          }

          const authIndex = f.auth_index;
          if (authIndex !== undefined && authIndex !== null && statsByAuthIndex[authIndex]) {
            requests = statsByAuthIndex[authIndex].requests;
            failed = statsByAuthIndex[authIndex].failed;
          }

          const projectRegion = project !== '-' ? `${project}${region !== '-' ? ' / ' + region : ''}` : (region !== '-' ? region : '-');
          
          let lastRefresh = '-';
          const lr = f.last_refresh || f.lastRefresh || f.last_refreshed_at || f.lastRefreshedAt;
          if (lr) {
            const date = new Date(lr);
            if (!isNaN(date)) {
              lastRefresh = date.toLocaleString();
            } else {
              lastRefresh = lr;
            }
          }

          const statusClass = f.expired ? 'expired' : 'active';
          const statusText = f.expired ? 'Expired' : 'Active';

          return `<tr>
            <td>
              <div class="auth-provider-cell">
                <div class="auth-provider-badge">${emoji}</div>
                <span style="font-weight:500;text-transform:capitalize">${provider}</span>
              </div>
            </td>
            <td>
              <div class="auth-identity-cell">
                <div class="auth-identity-email" title="${email}">${email}</div>
                <div class="auth-identity-filename" title="${filename}">${filename}</div>
              </div>
            </td>
            <td style="font-size:13px;color:var(--text-secondary)">${projectRegion}</td>
            <td style="font-size:12px;color:var(--text-muted)">${lastRefresh}</td>
            <td>
              <div class="auth-metrics">
                <span class="auth-metric requests" title="Total Requests">${requests.toLocaleString()}</span>
                ${failed > 0 ? `<span class="auth-metric failed" title="Failed Requests">${failed.toLocaleString()}</span>` : ''}
              </div>
            </td>
            <td>
              <span class="auth-status-badge ${statusClass}">
                <span class="auth-status-dot"></span>
                ${statusText}
              </span>
            </td>
            <td>
              <div class="auth-actions">
                <button class="auth-action-btn" onclick="viewAuthFile('${f.name}')" title="View contents">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
                <button class="auth-action-btn" onclick="downloadAuth('${f.name}')" title="Download">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                </button>
                <button class="auth-action-btn danger" onclick="deleteAuth('${f.name}')" title="Delete">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      } finally {
        if (refreshBtn) {
          refreshBtn.classList.remove('loading');
          refreshBtn.disabled = false;
        }
      }
    }

    async function viewAuthFile(name) {
      try {
        const res = await fetch(`/v0/management/auth-files/download?name=${encodeURIComponent(name)}`, {
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        });
        const data = await res.json();

        document.getElementById('modalTitle').textContent = `Auth File: ${name}`;

        document.getElementById('modalContent').innerHTML = `<pre style="background:rgba(0,0,0,0.4);padding:16px;border-radius:8px;overflow-x:auto;font-size:12px;max-height:400px;overflow-y:auto">${JSON.stringify(data, null, 2)}</pre>`;
        document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
        document.getElementById('modal').classList.add('active');
      }

      catch (e) {
        toast('Failed to view: ' + e.message, 'error');
      }
    }

    function downloadAuth(name) {
      window.open(`/v0/management/auth-files/download?name=${encodeURIComponent(name)}`, '_blank');
    }

    async function deleteAuth(name) {
      if (!confirm(`Delete ${name}?`)) return;

      try {
        await api('DELETE', `/auth-files?name=${encodeURIComponent(name)}`);
        toast('Deleted', 'success');
        loadAuthFiles();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function deleteAllAuthFiles() {
      if (!confirm('Delete ALL auth files? This cannot be undone!')) return;

      try {
        const d = await api('GET', '/auth-files');

        for (const f of (d.files || [])) {
          await api('DELETE', `/auth-files?name=${encodeURIComponent(f.name)}`);
        }

        toast('All auth files deleted', 'success');
        loadAuthFiles();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function handleFileDrop(e) {
      e.preventDefault();
      e.target.style.borderColor = 'var(--border-color)';
      e.target.style.background = 'transparent';
      const file = e.dataTransfer.files[0];
      if (file) handleFileSelect(file);
    }

    async function handleFileSelect(file) {
      if (!file) return;

      if (!file.name.endsWith('.json')) {
        toast('Please upload a JSON file', 'error');
        return;
      }

      const status = document.getElementById('uploadStatus');
      status.className = 'auth-upload-status show uploading';
      status.innerHTML = `
        <div class="auth-upload-spinner"></div>
        <span>Uploading ${file.name}...</span>
      `;

      try {
        await uploadAuthFile(file);

        status.className = 'auth-upload-status show success';
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span>${file.name} uploaded successfully!</span>
        `;
        toast('Auth file uploaded', 'success');
        loadAuthFiles();
        document.getElementById('authFileInput').value = '';
        setTimeout(() => {
          status.className = 'auth-upload-status';
          status.innerHTML = '';
        }, 4000);
      }

      catch (e) {
        status.className = 'auth-upload-status show error';
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <span>Failed: ${e.message}</span>
        `;
        toast('Upload failed: ' + e.message, 'error');
      }
    }

    async function uploadAuthFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      const res = await fetch('/v0/management/auth-files', {

        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }

        ,
        body: formData
      });

      if (!res.ok) {
        const text = await res.text();

        throw new Error(text || `HTTP ${res.status}`);
      }

      return res.json();
    }

    async function startOAuth(provider) {
      const ep = {
        'anthropic': '/anthropic-auth-url', 'gemini-cli': '/gemini-cli-auth-url', 'codex': '/codex-auth-url', 'antigravity': '/antigravity-auth-url', 'qwen': '/qwen-auth-url', 'iflow': '/iflow-auth-url'
      }

      [provider];

      try {
        toast(`Starting ${provider} OAuth...`, 'info');
        const d = await api('GET', ep);

        if (d.url || d.auth_url) {
          window.open(d.url || d.auth_url, '_blank');
          toast('Complete login in new window', 'info');
        }

        else if (d.message) toast(d.message, 'info');
      }

      catch (e) {
        toast('OAuth failed: ' + e.message, 'error');
      }
    }

    // Track revealed keys state
    let revealedKeys = {};

    async function loadKeys() {
      try {
        const [a, g, c, x] = await Promise.all([
          api('GET', '/api-keys').catch(() => ({})),
          api('GET', '/gemini-api-key').catch(() => ({})),
          api('GET', '/claude-api-key').catch(() => ({})),
          api('GET', '/codex-api-key').catch(() => ({}))
        ]);
        
        const accessKeys = a['api-keys'] || [];
        const geminiKeys = g['gemini-api-key'] || [];
        const claudeKeys = c['claude-api-key'] || [];
        const codexKeys = x['codex-api-key'] || [];

        renderKeyList('accessKeysList', accessKeys, 'access');
        renderKeyList('geminiKeysList', geminiKeys, 'gemini');
        renderKeyList('claudeKeysList', claudeKeys, 'claude');
        renderKeyList('codexKeysList', codexKeys, 'codex');

        // Update key counts in section headers
        document.getElementById('accessKeyCount').textContent = `${accessKeys.length} key${accessKeys.length !== 1 ? 's' : ''}`;
        document.getElementById('geminiKeyCount').textContent = `${geminiKeys.length} key${geminiKeys.length !== 1 ? 's' : ''}`;
        document.getElementById('claudeKeyCount').textContent = `${claudeKeys.length} key${claudeKeys.length !== 1 ? 's' : ''}`;
        document.getElementById('codexKeyCount').textContent = `${codexKeys.length} key${codexKeys.length !== 1 ? 's' : ''}`;

        // Update tab badges
        document.getElementById('accessTabBadge').textContent = accessKeys.length;
        document.getElementById('geminiTabBadge').textContent = geminiKeys.length;
        document.getElementById('claudeTabBadge').textContent = claudeKeys.length;
        document.getElementById('codexTabBadge').textContent = codexKeys.length;
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function getKeyTypeInfo(type) {
      const info = {
        access: { name: 'Access', hint: 'Used for authenticating API requests to this proxy', prefix: '' },
        gemini: { name: 'Gemini', hint: 'Google AI Studio key starting with AIza...', prefix: 'AIza' },
        claude: { name: 'Claude', hint: 'Anthropic key starting with sk-ant-...', prefix: 'sk-ant-' },
        codex: { name: 'Codex', hint: 'OpenAI Codex key starting with sk-...', prefix: 'sk-' }
      };
      return info[type] || info.access;
    }

    function renderKeyList(id, keys, type) {
      const container = document.getElementById(id);
      const typeInfo = getKeyTypeInfo(type);

      if (!keys.length) {
        container.innerHTML = `
          <div class="keys-empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />
            </svg>
            <h4>No ${typeInfo.name} Keys</h4>
            <p>Add your first API key to get started. Keys are stored securely and used for authentication.</p>
            <button class="btn btn-secondary btn-sm" onclick="openAddKeyModal('${type}')" style="margin-top:16px">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              Add Key
            </button>
          </div>`;
        return;
      }

      container.innerHTML = keys.map((k, i) => {
        const fullKey = typeof k === 'string' ? k : (k.key || k.api_key || JSON.stringify(k));
        const maskedKey = fullKey.length > 12 ? fullKey.slice(0, 6) + '' + fullKey.slice(-4) : '';
        const keyMeta = typeof k === 'object' ? (k.project || k.name || typeInfo.name + ' Key') : typeInfo.name + ' Key #' + (i + 1);
        const keyId = type + '-' + i;
        const isRevealed = revealedKeys[keyId];
        const displayKey = isRevealed ? fullKey : maskedKey;
        const escapedKey = fullKey.replace(/'/g, "\\'").replace(/"/g, '\\"');

        return '<div class="key-card">' +
            '<span class="key-index">' + (i + 1) + '</span>' +
            '<div class="key-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></svg></div>' +
            '<div class="key-info">' +
              '<div class="key-value ' + (isRevealed ? 'revealed' : '') + '" id="key-display-' + keyId + '">' + displayKey + '</div>' +
              '<div class="key-meta">' + keyMeta + '</div>' +
            '</div>' +
            '<div class="key-actions">' +
              '<button class="key-action-btn reveal" onclick="toggleKeyReveal(\'' + keyId + '\', \'' + escapedKey + '\', \'' + maskedKey + '\')" title="' + (isRevealed ? 'Hide' : 'Reveal') + ' key">' +
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                  (isRevealed ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>' : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>') +
                '</svg>' +
              '</button>' +
              '<button class="key-action-btn copy" onclick="copyToClipboard(\'' + escapedKey + '\')">' +
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></svg>Copy' +
              '</button>' +
              '<button class="key-action-btn delete" onclick="confirmDeleteKey(\'' + type + '\', ' + i + ')">' +
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>Delete' +
              '</button>' +
            '</div>' +
          '</div>';
      }).join('');
    }

    function toggleKeyReveal(keyId, fullKey, maskedKey) {
      revealedKeys[keyId] = !revealedKeys[keyId];
      const displayEl = document.getElementById('key-display-' + keyId);
      if (displayEl) {
        displayEl.textContent = revealedKeys[keyId] ? fullKey : maskedKey;
        displayEl.classList.toggle('revealed', revealedKeys[keyId]);
      }
      loadKeys();
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('Copied to clipboard', 'success');

      }).catch(() => {
        toast('Failed to copy', 'error');
      });
    }

    function openAddKeyModal(type) {
      const typeInfo = getKeyTypeInfo(type);
      document.getElementById('modalTitle').textContent = `Add ${typeInfo.name} Key`;
      document.getElementById('modalContent').innerHTML = `
        <div class="key-format-hint">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          <span>${typeInfo.hint}</span>
        </div>
        <div class="form-group">
          <label>API Key</label>
          <input type="text" id="newKeyValue" class="form-input" placeholder="${typeInfo.prefix ? 'e.g. ' + typeInfo.prefix + '...' : 'Enter your API key'}" autocomplete="off" spellcheck="false">
        </div>`;
      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addKey('${type}')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Key
        </button>`;
      document.getElementById('modal').classList.add('active');
      setTimeout(() => document.getElementById('newKeyValue')?.focus(), 100);
    }

    async function addKey(type) {
      const v = document.getElementById('newKeyValue').value.trim();
      if (!v) {
        toast('Please enter an API key', 'error');
        return;
      }

      try {
        const epMap = {
          access: '/api-keys', gemini: '/gemini-api-key', claude: '/claude-api-key', codex: '/codex-api-key'
        };
        const ep = epMap[type];

        await api('PATCH', ep, {
          old: '',
          new: v
        });
        closeModal();
        toast('API key added successfully', 'success');
        loadKeys();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function confirmDeleteKey(type, idx) {
      const typeInfo = getKeyTypeInfo(type);
      document.getElementById('modalTitle').textContent = 'Delete API Key';
      document.getElementById('modalContent').innerHTML = `
        <div style="text-align:center; padding: 24px 0;">
          <div style="width:64px; height:64px; background:rgba(248, 113, 113, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </div>
          <h4 style="margin-bottom:8px; font-size:18px;">Delete ${typeInfo.name} Key #${idx + 1}?</h4>
          <p style="color:var(--text-secondary); font-size:14px; max-width:300px; margin:0 auto;">This action cannot be undone. The key will be permanently removed from your configuration.</p>
        </div>`;
      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-danger" onclick="deleteKey('${type}', ${idx})">Yes, Delete</button>`;
      document.getElementById('modal').classList.add('active');
    }

    async function deleteKey(type, idx) {
      try {
        const epMap = {
          access: '/api-keys', gemini: '/gemini-api-key', claude: '/claude-api-key', codex: '/codex-api-key'
        };
        const ep = epMap[type];
        await api('DELETE', `${ep}?index=${idx}`);
        closeModal();
        toast('API key deleted successfully', 'success');
        loadKeys();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // Configuration state management
    let configState = {
      originalYaml: '',
      hasUnsavedChanges: false
    };

    async function loadConfig() {
      try {
        const [cfg, yaml] = await Promise.all([api('GET', '/config'), api('GET', '/config.yaml')]);
        
        // Set toggle states and update status dots
        const debugChecked = cfg.debug || false;
        const usageStatsChecked = cfg.usage_statistics_enabled || cfg['usage-statistics-enabled'] || false;
        const loggingChecked = cfg.logging_to_file || cfg['logging-to-file'] || false;
        const requestLogChecked = cfg.request_log || cfg['request-log'] || false;
        const wsAuthChecked = cfg.websocket_auth || cfg['websocket-auth'] || false;
        
        document.getElementById('toggleDebug').checked = debugChecked;
        document.getElementById('toggleUsageStats').checked = usageStatsChecked;
        document.getElementById('toggleLogging').checked = loggingChecked;
        document.getElementById('toggleRequestLog').checked = requestLogChecked;
        document.getElementById('toggleWsAuth').checked = wsAuthChecked;
        
        // Update status dots
        updateStatusDot('statusDebug', debugChecked);
        updateStatusDot('statusUsageStats', usageStatsChecked);
        updateStatusDot('statusLogging', loggingChecked);
        updateStatusDot('statusRequestLog', requestLogChecked);
        updateStatusDot('statusWsAuth', wsAuthChecked);
        
        // Set YAML editor
        document.getElementById('configEditor').value = yaml;
        configState.originalYaml = yaml;
        configState.hasUnsavedChanges = false;
        updateConfigEditorInfo();
        hideUnsavedIndicator();
        hideYamlError();
      } catch (e) {
        toast('Failed to load config: ' + e.message, 'error');
      }
    }
    
    function updateStatusDot(id, enabled) {
      const dot = document.getElementById(id);
      if (dot) {
        dot.classList.toggle('enabled', enabled);
      }
    }
    
    function updateConfigEditorInfo() {
      const editor = document.getElementById('configEditor');
      if (!editor) return;
      
      const content = editor.value;
      const lines = content.split('\n').length;
      const chars = content.length;
      
      const lineCountEl = document.getElementById('configLineCount');
      const charCountEl = document.getElementById('configCharCount');
      
      if (lineCountEl) {
        lineCountEl.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="17" y1="10" x2="3" y2="10"></line>
            <line x1="21" y1="6" x2="3" y2="6"></line>
            <line x1="21" y1="14" x2="3" y2="14"></line>
            <line x1="17" y1="18" x2="3" y2="18"></line>
          </svg>
          ${lines} lines`;
      }
      
      if (charCountEl) {
        charCountEl.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="4 7 4 4 20 4 20 7"></polyline>
            <line x1="9" y1="20" x2="15" y2="20"></line>
            <line x1="12" y1="4" x2="12" y2="20"></line>
          </svg>
          ${chars.toLocaleString()} chars`;
      }
    }
    
    function onConfigEditorInput() {
      const editor = document.getElementById('configEditor');
      if (!editor) return;
      
      updateConfigEditorInfo();
      
      // Check for unsaved changes
      if (editor.value !== configState.originalYaml) {
        configState.hasUnsavedChanges = true;
        showUnsavedIndicator();
      } else {
        configState.hasUnsavedChanges = false;
        hideUnsavedIndicator();
      }
      
      // Validate YAML on input (debounced)
      clearTimeout(configState.validateTimeout);
      configState.validateTimeout = setTimeout(() => {
        validateYaml(editor.value);
      }, 500);
    }
    
    function showUnsavedIndicator() {
      const indicator = document.getElementById('configUnsavedIndicator');
      if (indicator) indicator.classList.add('visible');
    }
    
    function hideUnsavedIndicator() {
      const indicator = document.getElementById('configUnsavedIndicator');
      if (indicator) indicator.classList.remove('visible');
    }
    
    function validateYaml(content) {
      // Basic YAML validation
      try {
        // Check for common YAML syntax errors
        const lines = content.split('\n');
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          // Check for tabs (YAML uses spaces)
          if (line.includes('\t')) {
            showYamlError(`Line ${i + 1}: Tab characters are not allowed in YAML. Use spaces for indentation.`);
            return false;
          }
          // Check for inconsistent indentation
          const leadingSpaces = line.match(/^(\s*)/)[1].length;
          if (leadingSpaces % 2 !== 0 && line.trim().length > 0) {
            showYamlError(`Line ${i + 1}: Indentation should use 2 spaces.`);
            return false;
          }
        }
        hideYamlError();
        return true;
      } catch (e) {
        showYamlError(e.message);
        return false;
      }
    }
    
    function showYamlError(message) {
      const banner = document.getElementById('yamlErrorBanner');
      const msgEl = document.getElementById('yamlErrorMessage');
      if (banner && msgEl) {
        msgEl.textContent = message;
        banner.classList.add('visible');
      }
    }
    
    function hideYamlError() {
      const banner = document.getElementById('yamlErrorBanner');
      if (banner) banner.classList.remove('visible');
    }
    
    async function reloadConfig() {
      if (configState.hasUnsavedChanges) {
        if (!confirm('You have unsaved changes. Reload and discard them?')) {
          return;
        }
      }
      toast('Reloading configuration...', 'info');
      await loadConfig();
      toast('Configuration reloaded', 'success');
    }
    
    async function toggleSettingEnhanced(setting, value, inputEl) {
      const label = inputEl.closest('.toggle-enhanced');
      const statusDotId = {
        'debug': 'statusDebug',
        'usage-statistics-enabled': 'statusUsageStats',
        'logging-to-file': 'statusLogging',
        'request-log': 'statusRequestLog',
        'ws-auth': 'statusWsAuth'
      }[setting];
      
      // Add loading state
      if (label) label.classList.add('loading');
      
      try {
        await api('PUT', `/${setting}`, { value });
        
        // Update status dot
        updateStatusDot(statusDotId, value);
        
        // Show success state
        if (label) {
          label.classList.remove('loading');
          label.classList.add('success');
          setTimeout(() => label.classList.remove('success'), 400);
        }
        
        // Show saved indicator briefly
        const statusEl = document.getElementById('settingsStatus');
        if (statusEl) {
          statusEl.style.display = 'flex';
          setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
        }
        
        toast(`${setting.replace(/-/g, ' ')} ${value ? 'enabled' : 'disabled'}`, 'success');
      } catch (e) {
        // Revert toggle on error
        inputEl.checked = !value;
        if (label) label.classList.remove('loading');
        toast('Failed: ' + e.message, 'error');
      }
    }
    
    async function saveConfigEnhanced() {
      const editor = document.getElementById('configEditor');
      const btn = document.getElementById('btnSaveConfig');
      const btnText = document.getElementById('saveConfigText');
      const btnIcon = document.getElementById('saveConfigIcon');
      
      if (!editor) return;
      
      // Validate YAML first
      if (!validateYaml(editor.value)) {
        toast('Please fix YAML errors before saving', 'error');
        return;
      }
      
      // Set saving state
      if (btn) btn.classList.add('saving');
      if (btnText) btnText.textContent = 'Saving...';
      if (btnIcon) {
        btnIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="0"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></circle>';
      }
      
      try {
        const response = await fetch('/v0/management/config.yaml', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/yaml'
          },
          body: editor.value
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Failed to save configuration');
        }
        
        // Update state
        configState.originalYaml = editor.value;
        configState.hasUnsavedChanges = false;
        hideUnsavedIndicator();
        
        // Show success
        if (btnIcon) {
          btnIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
        }
        if (btnText) btnText.textContent = 'Saved!';
        
        toast('Configuration saved successfully', 'success');
        
        // Reset button after delay
        setTimeout(() => {
          if (btn) btn.classList.remove('saving');
          if (btnText) btnText.textContent = 'Save';
          if (btnIcon) {
            btnIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
          }
        }, 2000);
        
      } catch (e) {
        if (btn) btn.classList.remove('saving');
        if (btnText) btnText.textContent = 'Save';
        if (btnIcon) {
          btnIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
        }
        toast('Failed to save: ' + e.message, 'error');
      }
    }
    
    // Keep old function for backwards compatibility
    async function saveConfig() {
      await saveConfigEnhanced();
    }
    
    // Keep old function for backwards compatibility
    async function toggleSetting(s, v) {
      const inputEl = document.querySelector(`input[onchange*="${s}"]`);
      if (inputEl) {
        await toggleSettingEnhanced(s, v, inputEl);
      } else {
        // Fallback to basic implementation
        try {
          await api('PUT', `/${s}`, { value: v });
          toast(`${s} updated`, 'success');
        } catch (e) {
          toast('Failed: ' + e.message, 'error');
        }
      }
    }
    
    // Keyboard shortcut for save (Ctrl+S)
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        const configEditor = document.getElementById('configEditor');
        if (configEditor && document.activeElement === configEditor) {
          e.preventDefault();
          saveConfigEnhanced();
        }
      }
    });

    async function loadAmpSettings() {
      try {
        const res = await api('GET', '/ampcode');
        const d = res.ampcode || {};
        const upstreamUrl = d.upstream_url || d['upstream-url'] || '';
        const upstreamKey = d.upstream_api_key || d['upstream-api-key'] || '';
        
        document.getElementById('ampUpstreamUrl').value = upstreamUrl;
        document.getElementById('ampUpstreamKey').value = upstreamKey;

        // Update connection status
        updateAmpConnectionStatus(upstreamUrl, upstreamKey);

        // Toggles
        document.getElementById('ampForce').checked = d.force_model_mappings || d['force-model-mappings'] || false;
        document.getElementById('ampRestrict').checked = d.restrict_management_to_localhost || d['restrict-management-to-localhost'] || false;

        const m = d.model_mappings || d['model-mappings'] || [];
        const c = document.getElementById('modelMappings');
        const countEl = document.getElementById('mappingCount');

        if (countEl) countEl.textContent = m.length;

        // Helper to escape HTML to prevent XSS
        function escapeHtmlAttr(str) {
          if (!str) return '';
          return str.replace(/&/g, '&amp;')
                    .replace(/'/g, '&#39;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
        }

        // Helper to parse reasoning effort from target
        function parseTarget(to) {
          const match = to.match(/:reasoning=(\w+)$/);
          if (match) {
            return { model: to.replace(/:reasoning=\w+$/, ''), reasoning: match[1] };
          }
          return { model: to, reasoning: null };
        }

        // Helper to format reasoning effort badge
        function reasoningBadge(effort) {
          if (!effort) return '';
          const colors = { low: 'yellow', medium: 'blue', high: 'purple' };
          return `<span class="badge badge-${colors[effort] || 'cyan'}" style="margin-left:8px;font-size:10px;"> ${effort}</span>`;
        }

        if (m.length === 0) {
          c.innerHTML = ` <div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:16px;opacity:0.5;color:var(--text-secondary)"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg><h4>No Model Mappings</h4><p>Configure model aliases to map incoming model names to upstream models.</p></div>`;
        } else {
          c.innerHTML = m.map(item => {
            const parsed = parseTarget(item.to);
            const escapedFrom = escapeHtmlAttr(item.from);
            const escapedTo = escapeHtmlAttr(item.to);
            const escapedModel = escapeHtmlAttr(parsed.model);
            return `
            <div class="mapping-card" data-from="${escapedFrom}" data-to="${escapedTo}">
              <div class="mapping-flow">
                <div class="mapping-source" onclick="copyMappingText(this, '${escapedFrom}')" title="Click to copy">${escapeHtmlAttr(item.from)}</div>
                <svg class="mapping-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <div class="mapping-target" onclick="copyMappingText(this, '${escapedModel}')" title="Click to copy">${escapedModel}${reasoningBadge(parsed.reasoning)}</div>
              </div>
              <div class="mapping-actions">
                <button class="mapping-action-btn edit" onclick="openEditMappingModal('${escapedFrom}', '${escapedTo}')" title="Edit mapping">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="mapping-action-btn delete" onclick="deleteAmpMapping('${escapedFrom}')" title="Delete mapping">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </div>
          `}).join('');
        }

        // Clear search input
        const searchInput = document.getElementById('mappingSearchInput');
        if (searchInput) searchInput.value = '';
        
        // Hide no results message
        const noResults = document.getElementById('mappingsNoResults');
        if (noResults) noResults.classList.remove('visible');

        // Render combos side panel
        renderCombosSidePanel();
      }

      catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    // Copy mapping text to clipboard
    function copyMappingText(el, text) {
      navigator.clipboard.writeText(text).then(() => {
        el.classList.add('copied');
        setTimeout(() => el.classList.remove('copied'), 1000);
        toast('Copied to clipboard', 'success');
      }).catch(() => {
        toast('Failed to copy', 'error');
      });
    }

    // Filter mappings by search term
    function filterMappings(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const cards = document.querySelectorAll('#modelMappings .mapping-card');
      const noResults = document.getElementById('mappingsNoResults');
      let visibleCount = 0;

      cards.forEach(card => {
        const from = (card.dataset.from || '').toLowerCase();
        const to = (card.dataset.to || '').toLowerCase();
        
        if (!term || from.includes(term) || to.includes(term)) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });

      // Show/hide no results message
      if (noResults) {
        if (visibleCount === 0 && term && cards.length > 0) {
          noResults.classList.add('visible');
        } else {
          noResults.classList.remove('visible');
        }
      }
    }

    // Update connection status indicator
    function updateAmpConnectionStatus(url, key) {
      const statusEl = document.getElementById('ampConnectionStatus');
      const textEl = document.getElementById('ampConnectionText');
      
      if (!statusEl || !textEl) return;
      
      // Remove all status classes
      statusEl.classList.remove('connected', 'disconnected', 'checking', 'not-configured');
      
      if (!url || !key) {
        statusEl.classList.add('not-configured');
        textEl.textContent = 'Not configured';
      } else {
        statusEl.classList.add('connected');
        textEl.textContent = 'Configured';
      }
    }

    // Toggle password visibility
    function toggleAmpKeyVisibility() {
      const input = document.getElementById('ampUpstreamKey');
      const icon = document.getElementById('ampKeyEyeIcon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    }

    // Test upstream connection
    async function testAmpConnection() {
      const url = document.getElementById('ampUpstreamUrl').value.trim();
      const key = document.getElementById('ampUpstreamKey').value.trim();
      const btn = document.getElementById('btnTestConnection');
      const textEl = document.getElementById('testConnectionText');
      const statusEl = document.getElementById('ampConnectionStatus');
      const statusTextEl = document.getElementById('ampConnectionText');
      
      if (!url) {
        toast('Please enter an upstream URL', 'error');
        return;
      }
      
      // Set testing state
      btn.classList.add('testing');
      btn.disabled = true;
      textEl.textContent = 'Testing...';
      statusEl.classList.remove('connected', 'disconnected', 'not-configured');
      statusEl.classList.add('checking');
      statusTextEl.textContent = 'Checking...';
      
      try {
        // Try to reach the upstream models endpoint
        const testUrl = url.replace(/\/$/, '') + '/v1/models';
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: key ? { 'Authorization': `Bearer ${key}` } : {},
          signal: AbortSignal.timeout(10000)
        });
        
        if (response.ok) {
          statusEl.classList.remove('checking');
          statusEl.classList.add('connected');
          statusTextEl.textContent = 'Connected';
          toast('Connection successful!', 'success');
        } else {
          statusEl.classList.remove('checking');
          statusEl.classList.add('disconnected');
          statusTextEl.textContent = 'Connection failed';
          toast(`Connection failed: HTTP ${response.status}`, 'error');
        }
      } catch (e) {
        statusEl.classList.remove('checking');
        statusEl.classList.add('disconnected');
        statusTextEl.textContent = 'Connection failed';
        
        if (e.name === 'TimeoutError') {
          toast('Connection timed out', 'error');
        } else if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
          // CORS or network error - could still be valid
          statusEl.classList.remove('disconnected');
          statusEl.classList.add('connected');
          statusTextEl.textContent = 'Configured (CORS blocked test)';
          toast('Note: Direct test blocked by CORS, but config saved', 'info');
        } else {
          toast('Connection error: ' + e.message, 'error');
        }
      } finally {
        btn.classList.remove('testing');
        btn.disabled = false;
        textEl.textContent = 'Test';
      }
    }

    async function saveAmpSettings() {
      const btn = document.getElementById('btnSaveAmp');
      const textEl = document.getElementById('saveAmpText');
      const iconEl = document.getElementById('saveAmpIcon');
      
      // Set saving state
      btn.classList.add('saving');
      btn.disabled = true;
      textEl.textContent = 'Saving...';
      iconEl.innerHTML = '<circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="0"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></circle>';
      
      try {
        const u = document.getElementById('ampUpstreamUrl').value,
          k = document.getElementById('ampUpstreamKey').value;

        if (u) await api('PUT', '/ampcode/upstream-url', {
          value: u
        });

        if (k) await api('PUT', '/ampcode/upstream-api-key', {
          value: k
        });
        
        // Update status
        updateAmpConnectionStatus(u, k);
        
        // Show success
        iconEl.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
        textEl.textContent = 'Saved!';
        toast('Connection settings saved', 'success');
        
        // Reset button after delay
        setTimeout(() => {
          btn.classList.remove('saving');
          btn.disabled = false;
          textEl.textContent = 'Save Connection';
          iconEl.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
        }, 2000);
      }

      catch (e) {
        btn.classList.remove('saving');
        btn.disabled = false;
        textEl.textContent = 'Save Connection';
        iconEl.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
        toast('Failed: ' + e.message, 'error');
      }
    }



    async function toggleAmpSetting(key, value) {
      try {
        await api('PUT', `/ampcode/${key}`, { value });
        toast('Setting updated', 'success');
      } catch (e) {
        toast('Failed to update: ' + e.message, 'error');
        // Revert toggle visually if failed
        loadAmpSettings();
      }
    }

    async function openAddMappingModal(oldFrom = null, oldTo = null, oldReasoningEffort = null) {
      document.getElementById('modalTitle').textContent = 'Add Model Mapping';

      // Always try to fetch fresh models if list is empty
      if (!allModels || allModels.length === 0) {
        try {
          // Try to load config to get access keys first if needed
          const cfg = await api('GET', '/config').catch(() => ({}));
          accessApiKeys = cfg['api-keys'] || cfg.api_keys || [];
          allModels = await fetchModels();
        } catch (e) {
          console.error("Failed to fetch models for dropdown", e);
          // Fallback: allow manual entry if fetch fails
        }
      }

      const presets = getPresets();
      const presetOptions = presets.map(p => `<option value="${p.value}">${p.label}</option>`).join('');

      // If no models available, show a placeholder or just let it be empty
      // Group models by provider
      const groupedModels = {};
      if (allModels && allModels.length > 0) {
        allModels.forEach(m => {
          const owner = m.owned_by || m.provider || 'Other';
          if (!groupedModels[owner]) groupedModels[owner] = [];
          groupedModels[owner].push(m.id || m.name);
        });
      }

      // Models that support reasoning effort
      const reasoningModels = [
        'o1', 'o1-preview', 'o1-mini', 'o3', 'o3-mini', 'o4-mini',
        'claude-3-7-sonnet', 'claude-sonnet-4',
        'gemini-2.0-flash-thinking', 'gemini-2.5-pro', 'gemini-2.5-flash'
      ];

      document.getElementById('modalContent').innerHTML = `
        <style>
          .model-selector { position: relative; }
          .model-search { width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; }
          .model-list { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; z-index: 100; margin-top: 4px; }
          .model-list.active { display: block; }
          .model-group-title { padding: 8px 12px; background: rgba(255,255,255,0.05); font-weight: bold; font-size: 12px; color: var(--accent-cyan); text-transform: uppercase; }
          .model-option { padding: 8px 12px; cursor: pointer; transition: background 0.2s; }
          .model-option:hover { background: rgba(255,255,255,0.1); }
          .model-option.selected { background: var(--accent-purple); color: white; }
          .input-mode-toggle { display: flex; gap: 8px; margin-bottom: 8px; }
          .input-mode-btn { padding: 6px 12px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
          .input-mode-btn.active { background: var(--accent-cyan); color: #0d0d1a; border-color: var(--accent-cyan); }
          .input-mode-btn:hover:not(.active) { border-color: var(--accent-cyan); color: var(--text-primary); }
          .reasoning-effort-group { margin-top: 12px; padding: 12px; background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3); border-radius: 8px; display: none; }
          .reasoning-effort-group.visible { display: block; }
          .reasoning-effort-group label { color: var(--accent-purple); font-size: 13px; margin-bottom: 8px; display: block; }
          .reasoning-effort-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        </style>
        <div class="form-group">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin-bottom:0">Source Model (From)</label>
            <a href="javascript:void(0)" onclick="openManagePresetsModal()" style="font-size:12px; color:var(--accent-cyan); text-decoration:none; display:flex; align-items:center; gap:4px">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                Manage Presets
            </a>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
             <select class="form-input" style="flex:1" onchange="if(this.value) document.getElementById('mappingFrom').value = this.value">
                <option value="">Select a preset...</option>
                ${presetOptions}
             </select>
          </div>
          <input type="text" id="mappingFrom" class="form-input" placeholder="Or type manually (e.g. gpt-4)">
        </div>
        <div class="form-group">
          <label>Target Model (To)</label>
          <div class="input-mode-toggle">
            <button type="button" class="input-mode-btn active" onclick="setTargetInputMode('select')">Select from list</button>
            <button type="button" class="input-mode-btn" onclick="setTargetInputMode('manual')">Manual input</button>
          </div>
          <div id="targetSelectMode" class="model-selector">
            <input type="text" id="modelSearchInput" class="model-search" placeholder="Search and select model..." autocomplete="off">
            <div id="modelListDropdown" class="model-list"></div>
          </div>
          <div id="targetManualMode" style="display:none;">
            <input type="text" id="mappingToManual" class="form-input" placeholder="Enter model ID (e.g. gpt-4o, claude-sonnet-4)" oninput="updateReasoningEffortVisibility(this.value)">
          </div>
          <input type="hidden" id="mappingTo">
          <div id="reasoningEffortGroup" class="reasoning-effort-group">
            <label>
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
              Reasoning Effort (Extended Thinking)
            </label>
            <select id="reasoningEffort" class="form-input">
              <option value="">Default (model decides)</option>
              <option value="low">Low - Faster responses</option>
              <option value="medium">Medium - Balanced</option>
              <option value="high">High - More thorough reasoning</option>
            </select>
            <div class="reasoning-effort-hint">
              Controls how much time the model spends on extended thinking. Higher effort = more thorough but slower.
            </div>
          </div>
        </div>
      `;

      // Render the custom list
      const listContainer = document.getElementById('modelListDropdown');
      const searchInput = document.getElementById('modelSearchInput');
      const hiddenInput = document.getElementById('mappingTo');

      function renderList(filter = '') {
        const f = filter.toLowerCase();
        let html = '';
        const sortedOwners = Object.keys(groupedModels).sort();

        let hasMatches = false;

        sortedOwners.forEach(owner => {
          const models = groupedModels[owner].filter(id => id.toLowerCase().includes(f));
          if (models.length > 0) {
            hasMatches = true;
            html += `<div class="model-group-title">${owner}</div>`;
            models.forEach(id => {
              html += `<div class="model-option" onclick="selectModel('${id}')">${id}</div>`;
            });
          }
        });

        if (!hasMatches) {
          html = '<div style="padding:12px;color:var(--text-secondary);text-align:center">No models found</div>';
        }

        listContainer.innerHTML = html;
      }

      // Initial render (hidden until focus)
      renderList();

      // Event Listeners
      searchInput.addEventListener('focus', () => listContainer.classList.add('active'));
      searchInput.addEventListener('input', (e) => {
        listContainer.classList.add('active');
        renderList(e.target.value);
        // Update hidden input for manual typing in search
        hiddenInput.value = e.target.value;
        updateReasoningEffortVisibility(e.target.value);
      });

      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeList(e) {
          if (!e.target.closest('.model-selector')) {
            listContainer.classList.remove('active');
          }
        });
      }, 0);

      // Check if a model supports reasoning effort
      window.modelSupportsReasoning = function(modelId) {
        if (!modelId) return false;
        const m = modelId.toLowerCase();
        return reasoningModels.some(rm => m.includes(rm.toLowerCase()));
      };

      window.updateReasoningEffortVisibility = function(modelId) {
        const group = document.getElementById('reasoningEffortGroup');
        if (modelSupportsReasoning(modelId)) {
          group.classList.add('visible');
        } else {
          group.classList.remove('visible');
        }
      };

      window.setTargetInputMode = function(mode) {
        const btns = document.querySelectorAll('.input-mode-toggle .input-mode-btn');
        btns.forEach(b => b.classList.remove('active'));
        if (mode === 'select') {
          btns[0].classList.add('active');
          document.getElementById('targetSelectMode').style.display = 'block';
          document.getElementById('targetManualMode').style.display = 'none';
          // Sync value
          hiddenInput.value = searchInput.value;
          updateReasoningEffortVisibility(searchInput.value);
        } else {
          btns[1].classList.add('active');
          document.getElementById('targetSelectMode').style.display = 'none';
          document.getElementById('targetManualMode').style.display = 'block';
          // Sync value
          const manualInput = document.getElementById('mappingToManual');
          hiddenInput.value = manualInput.value;
          updateReasoningEffortVisibility(manualInput.value);
        }
      };

      window.selectModel = function (id) {
        hiddenInput.value = id;
        searchInput.value = id;
        listContainer.classList.remove('active');
        updateReasoningEffortVisibility(id);
      };

      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveAmpMapping('${oldFrom || ''}')">${oldFrom ? 'Save Changes' : 'Add Mapping'}</button>
      `;
      document.getElementById('modal').classList.add('active');

      // Pre-fill values if editing
      if (oldFrom) {
        document.getElementById('mappingFrom').value = oldFrom;
        // Trigger search/select logic for target
        if (oldTo) {
          selectModel(oldTo);
          document.getElementById('mappingToManual').value = oldTo;
        }
      }
      // Pre-fill reasoning effort
      if (oldReasoningEffort) {
        document.getElementById('reasoningEffort').value = oldReasoningEffort;
      }
    }

    async function openEditMappingModal(from, to) {
      // Parse reasoning effort from target if present
      let reasoningEffort = '';
      let cleanTo = to;
      const reasoningMatch = to.match(/:reasoning=(\w+)$/);
      if (reasoningMatch) {
        reasoningEffort = reasoningMatch[1];
        cleanTo = to.replace(/:reasoning=\w+$/, '');
      }
      await openAddMappingModal(from, cleanTo, reasoningEffort);
      document.getElementById('modalTitle').textContent = 'Edit Model Mapping';
    }

    // --- Preset Management ---

    function getPresets() {
      let p = localStorage.getItem('amp_source_presets');
      if (!p) {
        const defaults = [
          { id: 1, label: 'Smart', value: 'claude-opus-4-5-20251101' },
          { id: 2, label: 'Librarian', value: 'claude-sonnet-4-5-20250929' },
          { id: 3, label: 'Search and title', value: 'claude-haiku-4-5-20251001' }
        ];
        localStorage.setItem('amp_source_presets', JSON.stringify(defaults));
        return defaults;
      }
      return JSON.parse(p);
    }

    function openManagePresetsModal() {
      const presets = getPresets();
      document.getElementById('modalTitle').textContent = 'Manage Source Presets';

      const content = `
            <div class="presets-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;">
                <table style="width:100%; border-collapse: separate; border-spacing: 0 8px;">
                    <thead>
                        <tr style="color: var(--text-secondary); font-size: 12px;">
                            <th style="padding: 0 8px; text-align: left;">Label</th>
                            <th style="padding: 0 8px; text-align: left;">Source Model ID</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="presetsTableBody">
                        ${presets.map(p => `
                            <tr class="preset-row" id="preset-${p.id}">
                                <td>
                                    <input type="text" class="form-input" value="${p.label}" placeholder="Label" onchange="markUnsaved()">
                                </td>
                                <td>
                                    <input type="text" class="form-input" value="${p.value}" placeholder="Model ID" onchange="markUnsaved()">
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); markUnsaved();" style="padding: 8px 12px;"></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="addPresetRow()" style="width: 100%; border-style: dashed;">+ Add New Preset</button>
            <p id="presetStatus" style="font-size:12px; color:var(--text-muted); margin-top:8px; text-align:right; opacity:0; transition:opacity 0.2s">Unsaved changes</p>
        `;

      document.getElementById('modalContent').innerHTML = content;

      document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="openAddMappingModal()">Back</button>
            <button class="btn btn-primary" onclick="saveAllPresets()">Save Changes</button>
        `;
    }

    function addPresetRow() {
      const tbody = document.getElementById('presetsTableBody');
      const tr = document.createElement('tr');
      tr.className = 'preset-row';
      tr.innerHTML = `
            <td><input type="text" class="form-input" placeholder="Label" autofocus></td>
            <td><input type="text" class="form-input" placeholder="Model ID"></td>
            <td style="text-align: right;">
                <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); markUnsaved();" style="padding: 8px 12px;"></button>
            </td>
        `;
      tbody.appendChild(tr);
      markUnsaved();
    }

    function markUnsaved() {
      const el = document.getElementById('presetStatus');
      if (el) el.style.opacity = '1';
    }

    function saveAllPresets() {
      const rows = document.querySelectorAll('.preset-row');
      const newPresets = [];
      let valid = true;

      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const label = inputs[0].value.trim();
        const value = inputs[1].value.trim();

        if (label && value) {
          newPresets.push({
            id: Date.now() + Math.random(),
            label,
            value
          });
        } else if (label || value) {
          // If one is filled but not the other, it's an error
          valid = false;
          inputs[0].style.borderColor = !label ? 'var(--accent-red)' : '';
          inputs[1].style.borderColor = !value ? 'var(--accent-red)' : '';
        }
      });

      if (!valid) {
        toast('Please fill in both fields for all presets', 'error');
        return;
      }

      localStorage.setItem('amp_source_presets', JSON.stringify(newPresets));
      toast('Presets saved', 'success');
      openAddMappingModal(); // Go back to the main modal
    }

    // -------------------------

    async function saveAmpMapping(oldFromKey) {
      const from = document.getElementById('mappingFrom').value.trim();
      // Get target value from hidden input (synced by both modes) or fallback to manual input
      let to = document.getElementById('mappingTo').value.trim();
      const manualInput = document.getElementById('mappingToManual');
      if (!to && manualInput) {
        to = manualInput.value.trim();
      }
      // Get reasoning effort if set
      const reasoningEffortEl = document.getElementById('reasoningEffort');
      const reasoningEffort = reasoningEffortEl ? reasoningEffortEl.value : '';

      if (!from || !to) {
        toast('Both fields are required', 'error');
        return;
      }

      // Append reasoning effort to target if specified
      let finalTo = to;
      if (reasoningEffort) {
        // Format: model_id:reasoning=effort (e.g., o3-mini:reasoning=high)
        // Remove any existing reasoning suffix first
        finalTo = to.replace(/:reasoning=\w+$/, '');
        finalTo = `${finalTo}:reasoning=${reasoningEffort}`;
      }

      try {
        // Check for duplicates
        // Note: We need to fetch current mappings to verify because the list in DOM might be stale or incomplete
        const res = await api('GET', '/ampcode/model-mappings');
        const currentMappings = res['model-mappings'] || [];

        const exists = currentMappings.some(m => m.from === from);

        // If it's a new mapping (no oldKey) AND it exists -> Duplicate
        // If it's an edit (oldKey present) AND key changed (oldKey != from) AND new key exists -> Duplicate
        if ((!oldFromKey && exists) || (oldFromKey && oldFromKey !== from && exists)) {
          toast(`Mapping for source "${from}" already exists.`, 'error');
          return;
        }
        // If editing and key changed, delete old one first
        if (oldFromKey && oldFromKey !== from) {
          await api('DELETE', '/ampcode/model-mappings', { value: [oldFromKey] });
        }

        await api('PATCH', '/ampcode/model-mappings', {
          value: [{ from, to: finalTo }]
        });
        closeModal();
        toast('Mapping saved', 'success');
        loadAmpSettings();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    async function deleteAmpMapping(from) {
      if (!confirm(`Delete mapping for ${from}?`)) return;
      try {
        // DELETE requires a body with the list of 'from' values to remove
        await fetch('/v0/management/ampcode/model-mappings', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: [from] })
        });
        toast('Mapping deleted', 'success');
        loadAmpSettings();
      } catch (e) {
        toast('Failed: ' + e.message, 'error');
      }
    }

    // --- Combo Management ---

    function getCombos() {
      const c = localStorage.getItem('amp_mapping_combos');
      return c ? JSON.parse(c) : [];
    }

    function saveCombos(combos) {
      localStorage.setItem('amp_mapping_combos', JSON.stringify(combos));
      renderCombosSidePanel();
    }

    function renderCombosSidePanel() {
      const combos = getCombos();
      const el = document.getElementById('combosSidePanel');
      if (!el) return;

      if (combos.length === 0) {
        el.innerHTML = `
                <div style="padding:24px; text-align:center; color:var(--text-secondary); font-size:13px; border:1px dashed var(--border-color); border-radius:8px; background:rgba(0,0,0,0.1)">
                  No combos created yet.<br>
                  <a href="javascript:void(0)" onclick="openAddComboModal()" style="color:var(--accent-cyan); text-decoration:none; display:inline-block; margin-top:4px">Create your first combo</a>
                </div>
            `;
        return;
      }

      el.innerHTML = combos.map(c => `
            <div class="combo-item" style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:12px; display:flex; align-items:center; justify-content:space-between; transition:all 0.2s; cursor:default; position:relative; overflow:hidden">
                <div style="display:flex; align-items:center; gap:12px">
                    <div style="width:32px; height:32px; background:rgba(255,255,255,0.03); border-radius:6px; display:flex; align-items:center; justify-content:center; color:var(--text-secondary)">
                        <span style="font-weight:bold; font-size:14px">${c.name.charAt(0).toUpperCase()}</span>
                    </div>
                    <div>
                        <div style="font-size:14px; font-weight:600; color:var(--text-primary); margin-bottom:2px">${c.name}</div>
                        <div style="font-size:11px; color:var(--text-secondary)">${c.mappings.length} mapping${c.mappings.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" style="padding:4px 12px; font-size:12px; opacity:0; transform:translateX(10px); transition:all 0.2s" onclick="applyCombo('${c.id}')">Apply</button>
                <style>
                    .combo-item:hover { border-color: var(--accent-purple); box-shadow: 0 2px 8px rgba(167, 139, 250, 0.1); }
                    .combo-item:hover .btn-primary { opacity: 1; transform: translateX(0); }
                </style>
            </div>
        `).join('');
    }

    function openManageCombosModal() {
      const combos = getCombos();
      document.getElementById('modalTitle').textContent = 'Model Mapping Combos';

      const content = `
            <div style="margin-bottom:16px">
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">Combos allow you to apply multiple model mappings at once. Applying a combo will update existing mappings with matching source models.</p>
                ${combos.length === 0 ?
          `<div class="empty-state" style="padding:24px;border:1px dashed var(--border-color);border-radius:8px">No combos saved</div>` :
          `<div class="combos-list" style="display:grid;gap:12px">
                        ${combos.map(c => `
                            <div class="mapping-card">
                                <div style="flex:1">
                                    <div style="font-weight:600;color:var(--text-primary)">${c.name}</div>
                                    <div style="font-size:12px;color:var(--text-secondary)">${c.mappings.length} mappings</div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn btn-secondary btn-sm" onclick="openAddComboModal('${c.id}')" title="Edit"></button>
                                    <button class="btn btn-primary btn-sm" onclick="applyCombo('${c.id}')" title="Apply Combo">Apply</button>
                                    <button class="btn btn-secondary btn-sm" onclick="deleteCombo('${c.id}')" title="Delete"></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`
        }
            </div>
            <button class="btn btn-secondary btn-sm" style="width:100%;border-style:dashed" onclick="openAddComboModal()">+ Create New Combo</button>
        `;

      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modalFooter').innerHTML = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
      document.getElementById('modal').classList.add('active');
    }

    function openAddComboModal(editId = null) {
      // Setup simple combo editor
      document.getElementById('modalTitle').textContent = editId ? 'Edit Combo' : 'Create Combo';

      // We need the presets for the dropdowns
      const presets = getPresets();
      const presetOptions = presets.map(p => `<option value="${p.value}">${p.label} (${p.value})</option>`).join('');

      let comboName = '';
      let mappings = [];

      if (editId) {
        const combos = getCombos();
        const c = combos.find(x => x.id === editId);
        if (c) {
          comboName = c.name;
          mappings = c.mappings;
        }
      }

      document.getElementById('modalContent').innerHTML = `
            <div class="form-group">
                <label>Combo Name</label>
                <input type="text" id="comboName" class="form-input" placeholder="e.g. Creative Suite" value="${comboName}">
            </div>
            <label style="display:block;margin-bottom:8px;font-size:14px;font-weight:500">Mappings</label>
            <div id="comboMappingsList" style="max-height:300px;overflow-y:auto;margin-bottom:12px;display:grid;gap:8px">
                <!-- Rows will be added here -->
            </div>
            <button class="btn btn-secondary btn-sm" onclick="addComboRow()" style="width:100%">+ Add Row</button>
            <template id="comboRowTemplate">
                <div class="combo-row" style="display:flex;gap:8px;align-items:center">
                    <select class="form-input" style="flex:1" onchange="this.nextElementSibling.value=this.value">
                        <option value="">Select source...</option>
                        ${presetOptions}
                    </select>
                    <input type="text" class="form-input" style="flex:1" placeholder="Source (From)">
                    <input type="text" class="form-input" style="flex:1" placeholder="Target (To)">
                    <button class="btn btn-danger btn-sm" onclick="this.closest('.combo-row').remove()"></button>
                </div>
            </template>
        `;

      document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="openManageCombosModal()">Back</button>
            <button class="btn btn-primary" onclick="saveCombo('${editId || ''}')">${editId ? 'Save Changes' : 'Save Combo'}</button>
        `;

      // Add rows
      if (mappings.length > 0) {
        mappings.forEach(m => addComboRow(m.from, m.to));
      } else {
        addComboRow();
      }
    }

    function addComboRow(from = '', to = '') {
      const tmpl = document.getElementById('comboRowTemplate');
      const div = tmpl.content.cloneNode(true);
      const inputs = div.querySelectorAll('input');
      if (from) inputs[0].value = from;
      if (to) inputs[1].value = to;
      document.getElementById('comboMappingsList').appendChild(div);
    }

    function saveCombo(editId) {
      const name = document.getElementById('comboName').value.trim();
      if (!name) return toast('Combo name is required', 'error');

      const rows = document.querySelectorAll('.combo-row');
      const mappings = [];

      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const from = inputs[0].value.trim();
        const to = inputs[1].value.trim();
        if (from && to) mappings.push({ from, to });
      });

      if (mappings.length === 0) return toast('Add at least one mapping', 'error');

      const combos = getCombos();

      if (editId) {
        const idx = combos.findIndex(c => c.id === editId);
        if (idx >= 0) {
          combos[idx].name = name;
          combos[idx].mappings = mappings;
        }
      } else {
        combos.push({
          id: Date.now().toString(),
          name,
          mappings
        });
      }

      saveCombos(combos);
      toast('Combo saved', 'success');
      openManageCombosModal();
    }

    function deleteCombo(id) {
      if (!confirm('Delete this combo?')) return;
      const combos = getCombos().filter(c => c.id !== id);
      saveCombos(combos);
      openManageCombosModal();
    }

    async function applyCombo(id) {
      if (!confirm('Apply this combo? This will update target models for any matching sources.')) return;

      try {
        const combo = getCombos().find(c => c.id === id);
        if (!combo) return;

        // Get current mappings
        const res = await api('GET', '/ampcode/model-mappings');
        const currentMappings = res['model-mappings'] || [];

        // Merge logic
        let updatedCount = 0;
        let addedCount = 0;
        const newMappings = [...currentMappings];

        combo.mappings.forEach(cm => {
          const idx = newMappings.findIndex(m => m.from === cm.from);
          if (idx >= 0) {
            // Update target if different
            if (newMappings[idx].to !== cm.to) {
              newMappings[idx].to = cm.to;
              updatedCount++;
            }
          } else {
            // Add new
            newMappings.push({ from: cm.from, to: cm.to });
            addedCount++;
          }
        });

        if (updatedCount === 0 && addedCount === 0) {
          toast('No changes needed', 'info');
          return;
        }

        // DELETE all existing first to handle clean slate for the merge?
        // Wait, we need to be careful. The patch logic I wrote in `saveAmpMapping` was deleting one-offs.
        // The API likely just overwrites the list if we use PUT, or appends if PATCH?
        // Checking previous `saveAmpMapping`: it deletes old then PATCHes.
        // The backend endpoint `/v0/management/ampcode/model-mappings` likely accepts a list to ADD/UPDATE.
        // But to be safe and ensure clean state matching our "merged" view, we might need a way to set the whole list.
        // However, the user asked for *replace*.
        // Let's rely on patching individually or batch patching.
        // Re-reading `saveAmpMapping`: `await api('PATCH', ... { value: [{from, to}] })`
        // So PATCH takes a list. It probably upserts.

        // Let's just send the `combo.mappings` to PATCH. This will update existing keys and add new ones.
        // It won't remove keys that are NOT in the combo (which is correct for "Update").

        await api('PATCH', '/ampcode/model-mappings', { value: combo.mappings });
        toast(`Applied: ${updatedCount} updated, ${addedCount} added`, 'success');
        closeModal();
        loadAmpSettings();

      } catch (e) {
        toast('Failed to apply combo: ' + e.message, 'error');
      }
    }
    // Enhanced Log Management
    let logState = {
      allLogs: [],
      filter: 'ALL',
      search: '',
      autoRefreshInterval: null,
      latestTimestamp: 0,
      searchDebounceTimer: null,
      errorCount: 0,
      warnCount: 0,
      infoCount: 0,
      debugCount: 0,
      isAtBottom: true,
      newLogsWhileScrolled: 0,
      regexError: false
    };

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function parseLogLine(line) {
      let level = 'INFO';
      let time = '';
      let message = line; // Default to full line

      // Parse bracket-style log format: [2025-12-12 18:35:19] [level] [source:line] message
      const bracketMatch = line.match(/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]\s*\[(\w+)\]\s*(?:\[[^\]]+\]\s*)?(.*)$/);

      if (bracketMatch) {
        time = bracketMatch[1];
        const levelStr = bracketMatch[2].toLowerCase();
        if (levelStr === 'error' || levelStr === 'erro') level = 'ERROR';
        else if (levelStr === 'warn' || levelStr === 'warning') level = 'WARN';
        else if (levelStr === 'debug' || levelStr === 'debu') level = 'DEBUG';
        else if (levelStr === 'info') level = 'INFO';
        message = bracketMatch[3] || '';
      } else {
        // Fallback: Heuristic for log level
        if (line.includes('level=error') || line.includes('ERROR') || line.includes('[ERRO')) level = 'ERROR';
        else if (line.includes('level=warn') || line.includes('WARN') || line.includes('[WARN')) level = 'WARN';
        else if (line.includes('level=debug') || line.includes('DEBUG') || line.includes('[DEBU')) level = 'DEBUG';

        // Fallback: Heuristic for timestamp
        // Match ISO strings like 2024-12-11T... or Go default format
        const timeMatch = line.match(/time="([^"]+)"/) ||
          line.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})/) ||
          line.match(/(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})/);

        if (timeMatch) {
          time = timeMatch[1] || timeMatch[0];
        }
      }

      return { raw: line, time, level, message };
    }

    async function loadLogs(isAuto = false) {
      const v = document.getElementById('logViewer');
      const btn = document.getElementById('btnRefreshLogs');
      
      // Add loading state to button
      if (!isAuto && btn) {
        btn.classList.add('loading');
      }
      
      if (!isAuto && (!logState.allLogs.length)) {
        v.innerHTML = '<div class="empty-logs"><div class="spinner" style="width:32px;height:32px;border:3px solid var(--border-color);border-top-color:var(--accent-cyan);border-radius:50%;animation:spin 1s linear infinite;"></div><p>Loading logs...</p></div>';
      }

      try {
        // Use incremental loading if we have a latest timestamp
        let url = '/logs?limit=500';
        if (isAuto && logState.latestTimestamp > 0) {
          url += '&after=' + logState.latestTimestamp;
        }

        const d = await api('GET', url);
        const lines = d.lines || [];
        const newLogs = lines
          .filter(l => !l.includes('/v0/management/logs'))
          .map(parseLogLine);

        if (isAuto && logState.latestTimestamp > 0 && newLogs.length > 0) {
          // Incremental update - append new logs
          const previousLength = logState.allLogs.length;
          logState.allLogs = [...logState.allLogs, ...newLogs].slice(-1000);
          
          // Track new logs if user is scrolled up
          if (!logState.isAtBottom) {
            logState.newLogsWhileScrolled += newLogs.length;
            updateNewLogsBadge();
          }
        } else {
          // Full refresh
          logState.allLogs = newLogs;
        }

        // Update latest timestamp for incremental loading
        if (d['latest-timestamp']) {
          logState.latestTimestamp = d['latest-timestamp'];
        }

        // Update counts by level
        logState.errorCount = logState.allLogs.filter(l => l.level === 'ERROR').length;
        logState.warnCount = logState.allLogs.filter(l => l.level === 'WARN').length;
        logState.infoCount = logState.allLogs.filter(l => l.level === 'INFO').length;
        logState.debugCount = logState.allLogs.filter(l => l.level === 'DEBUG').length;

        renderLogs();

        // Update live status UI
        updateLogStatusUI();
        updateLogStats();

      } catch (e) {
        if (!isAuto) toast('Failed to load logs: ' + e.message, 'error');
      } finally {
        if (btn) btn.classList.remove('loading');
      }
    }

    function updateLogStats() {
      const totalEl = document.getElementById('statTotal');
      const errorsEl = document.getElementById('statErrors');
      const warningsEl = document.getElementById('statWarnings');
      const infoEl = document.getElementById('statInfo');
      const debugEl = document.getElementById('statDebug');
      const truncatedHint = document.getElementById('logTruncatedHint');
      
      if (totalEl) totalEl.textContent = logState.allLogs.length;
      if (errorsEl) errorsEl.textContent = logState.errorCount;
      if (warningsEl) warningsEl.textContent = logState.warnCount;
      if (infoEl) infoEl.textContent = logState.infoCount;
      if (debugEl) debugEl.textContent = logState.debugCount;
      
      // Show truncation hint if we have 500+ logs
      if (truncatedHint) {
        truncatedHint.style.display = logState.allLogs.length >= 500 ? 'inline' : 'none';
      }
    }

    function updateNewLogsBadge() {
      const badge = document.getElementById('newLogsBadge');
      const btn = document.getElementById('scrollBottomBtn');
      
      if (badge && btn) {
        if (logState.newLogsWhileScrolled > 0) {
          badge.textContent = logState.newLogsWhileScrolled > 99 ? '99+' : logState.newLogsWhileScrolled;
          badge.style.display = 'block';
          btn.classList.add('visible');
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function updateLogStatusUI() {
      const statusText = document.getElementById('liveStatusText');
      if (logState.autoRefreshInterval) {
        statusText.innerText = 'Live';
        statusText.style.color = 'var(--accent-green)';
      } else {
        statusText.innerText = 'Last updated: ' + new Date().toLocaleTimeString();
        statusText.style.color = 'var(--text-muted)';
      }

      // Update error count badge on ERROR filter button
      const errorBtn = document.getElementById('filter-ERROR');
      if (errorBtn) {
        if (logState.errorCount > 0) {
          errorBtn.innerHTML = `ERROR <span class="log-count-badge error">${logState.errorCount}</span>`;
        } else {
          errorBtn.textContent = 'ERROR';
        }
      }

      const warnBtn = document.getElementById('filter-WARN');
      if (warnBtn) {
        if (logState.warnCount > 0) {
          warnBtn.innerHTML = `WARN <span class="log-count-badge warn">${logState.warnCount}</span>`;
        } else {
          warnBtn.textContent = 'WARN';
        }
      }
    }

    function renderLogs() {
      const v = document.getElementById('logViewer');
      const filter = logState.filter;
      const search = logState.search.toLowerCase();
      let searchRegex = null;
      
      // Clear regex error state
      const searchInput = document.getElementById('logSearch');
      const searchContainer = document.getElementById('logSearchContainer');
      const regexError = document.getElementById('logRegexError');

      try {
        if (search) {
          searchRegex = new RegExp(search, 'i');
          logState.regexError = false;
          if (searchInput) searchInput.classList.remove('regex-error');
          if (searchContainer) searchContainer.classList.remove('has-error');
          if (regexError) regexError.classList.remove('visible');
        }
      } catch (e) {
        logState.regexError = true;
        if (searchInput) searchInput.classList.add('regex-error');
        if (searchContainer) searchContainer.classList.add('has-error');
        if (regexError) {
          regexError.textContent = 'Invalid regex: ' + e.message;
          regexError.classList.add('visible');
        }
        // Fall back to literal search
        searchRegex = null;
      }

      const filtered = logState.allLogs.filter(l => {
        if (filter !== 'ALL' && l.level !== filter) return false;
        if (search) {
          if (searchRegex) return searchRegex.test(l.raw);
          return l.raw.toLowerCase().includes(search);
        }
        return true;
      });

      document.getElementById('logCount').innerText = `${filtered.length} lines`;

      if (filtered.length === 0) {
        v.innerHTML = `<div class="empty-logs">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <p>No logs found matching filters</p>
          <button class="btn btn-secondary btn-sm" onclick="clearLogFilters()">Clear filters</button>
        </div>`;
        return;
      }

      // We only render the last 500 filtered items to prevent DOM overload if array is huge
      const linesToRender = filtered.slice(-500);

      const html = linesToRender.map((l, idx) => {
        let lvlClass = l.level.toLowerCase();
        // Use the extracted message (without timestamp/level prefix) for cleaner display
        let displayTime = l.time ? (l.time.length > 15 ? l.time.substring(11, 19) : l.time) : '--:--:--';
        const isLongMessage = l.message && l.message.length > 200;

        return `
           <div class="log-entry ${lvlClass}" data-log-idx="${idx}" onclick="copyLogEntry(this)" ondblclick="showLogDetail(${idx})" title="Click to copy  Double-click for details">
             <div class="log-time" title="${escapeHtml(l.time)}">${escapeHtml(displayTime)}</div>
             <div class="log-lvl ${lvlClass}">${l.level}</div>
             <div class="log-msg${isLongMessage ? '' : ''}">${escapeHtml(l.message)}</div>
           </div>
         `;
      }).join('');

      const wasAtBottom = v.scrollTop + v.clientHeight >= v.scrollHeight - 50;
      v.innerHTML = html;

      // Scroll to bottom if we were at bottom or if it's the first load
      if (wasAtBottom || !v.getAttribute('data-loaded')) {
        v.scrollTop = v.scrollHeight;
        v.setAttribute('data-loaded', 'true');
        logState.isAtBottom = true;
      }
    }

    function clearLogFilters() {
      const searchInput = document.getElementById('logSearch');
      if (searchInput) searchInput.value = '';
      logState.search = '';
      logState.filter = 'ALL';
      document.querySelectorAll('.log-filter-btn').forEach(b => {
        b.classList.toggle('active', b.id === 'filter-ALL');
      });
      renderLogs();
    }

    function showLogDetail(idx) {
      const linesToRender = getFilteredLogs().slice(-500);
      const log = linesToRender[idx];
      if (!log) return;
      
      const lvlClass = log.level.toLowerCase();
      
      document.getElementById('modalTitle').textContent = 'Log Entry Details';
      document.getElementById('modalContent').innerHTML = `
        <div class="log-detail-content">
          <div class="log-detail-header">
            <span class="log-detail-level ${lvlClass}">${log.level}</span>
            <span class="log-detail-time">${escapeHtml(log.time || 'N/A')}</span>
          </div>
          <div class="log-detail-body">
            <div class="log-detail-message">${escapeHtml(log.raw)}</div>
            <div class="log-detail-actions">
              <button class="btn btn-secondary btn-sm" onclick="copyLogToClipboard(\`${escapeHtml(log.raw).replace(/`/g, '\\`')}\`)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy Full Log
              </button>
              <button class="btn btn-secondary btn-sm" onclick="copyLogToClipboard(\`${escapeHtml(log.message).replace(/`/g, '\\`')}\`)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy Message Only
              </button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('modalFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      `;
      document.getElementById('modal').classList.add('active');
    }

    function getFilteredLogs() {
      const filter = logState.filter;
      const search = logState.search.toLowerCase();
      let searchRegex = null;
      
      try {
        if (search) searchRegex = new RegExp(search, 'i');
      } catch (e) { }
      
      return logState.allLogs.filter(l => {
        if (filter !== 'ALL' && l.level !== filter) return false;
        if (search) {
          if (searchRegex) return searchRegex.test(l.raw);
          return l.raw.toLowerCase().includes(search);
        }
        return true;
      });
    }

    function copyLogToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('Copied to clipboard', 'success');
      }).catch(() => {
        toast('Failed to copy', 'error');
      });
    }

    function copyLogEntry(element) {
      const timeEl = element.querySelector('.log-time');
      const levelEl = element.querySelector('.log-lvl');
      const msgEl = element.querySelector('.log-msg');

      const logText = `[${timeEl?.getAttribute('title') || timeEl?.textContent || ''}] [${levelEl?.textContent || ''}] ${msgEl?.textContent || ''}`;

      navigator.clipboard.writeText(logText).then(() => {
        // Visual feedback - brief highlight with class
        element.classList.add('copied');
        setTimeout(() => {
          element.classList.remove('copied');
        }, 600);
      }).catch(() => {
        toast('Failed to copy log entry', 'error');
      });
    }

    function setLogFilter(filter) {
      logState.filter = filter;
      document.querySelectorAll('.log-filter-btn').forEach(b => {
        b.classList.toggle('active', b.id === 'filter-' + filter);
      });
      renderLogs();
    }

    function filterLogs() {
      // Debounce search to avoid excessive re-renders
      if (logState.searchDebounceTimer) {
        clearTimeout(logState.searchDebounceTimer);
      }
      logState.searchDebounceTimer = setTimeout(() => {
        logState.search = document.getElementById('logSearch').value;
        renderLogs();
      }, 150);
    }

    function toggleAutoRefresh(enabled) {
      if (logState.autoRefreshInterval) clearInterval(logState.autoRefreshInterval);
      logState.autoRefreshInterval = null;

      const dot = document.getElementById('liveStatusDot');
      if (dot) dot.classList.toggle('active', enabled);

      if (enabled) {
        loadLogs(true);
        logState.autoRefreshInterval = setInterval(() => loadLogs(true), 2000);
      } else {
        updateLogStatusUI(); // Update status text properly when toggled off
      }
    }

    function stopLogAutoRefresh() {
      // Called when navigating away from logs tab
      if (logState.autoRefreshInterval) {
        clearInterval(logState.autoRefreshInterval);
        logState.autoRefreshInterval = null;
        const toggle = document.getElementById('autoRefreshToggle');
        if (toggle) toggle.checked = false;
        const dot = document.getElementById('liveStatusDot');
        if (dot) dot.classList.remove('active');
      }
      // Clear debounce timer
      if (logState.searchDebounceTimer) {
        clearTimeout(logState.searchDebounceTimer);
        logState.searchDebounceTimer = null;
      }
    }

    function scrollLogsToBottom() {
      const v = document.getElementById('logViewer');
      if (v) {
        v.scrollTop = v.scrollHeight;
        logState.isAtBottom = true;
        logState.newLogsWhileScrolled = 0;
        
        // Hide the scroll button and badge
        const btn = document.getElementById('scrollBottomBtn');
        const badge = document.getElementById('newLogsBadge');
        if (btn) btn.classList.remove('visible');
        if (badge) badge.style.display = 'none';
      }
    }

    // Track scroll position
    function setupLogScrollTracking() {
      const v = document.getElementById('logViewer');
      if (v) {
        v.addEventListener('scroll', () => {
          const isAtBottom = v.scrollTop + v.clientHeight >= v.scrollHeight - 50;
          logState.isAtBottom = isAtBottom;
          
          const btn = document.getElementById('scrollBottomBtn');
          if (btn) {
            if (!isAtBottom && logState.allLogs.length > 10) {
              btn.classList.add('visible');
            } else {
              btn.classList.remove('visible');
              logState.newLogsWhileScrolled = 0;
              const badge = document.getElementById('newLogsBadge');
              if (badge) badge.style.display = 'none';
            }
          }
        });
      }
    }

    // Initialize scroll tracking when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(setupLogScrollTracking, 500);
    });

    function exportLogs() {
      if (logState.allLogs.length === 0) {
        toast('No logs to export', 'info');
        return;
      }

      const logText = logState.allLogs.map(l => `[${l.time || ''}] [${l.level}] ${l.message}`).join('\n');
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cliproxy-logs-${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Logs exported successfully', 'success');
    }

    function jumpToNextError() {
      const errorLogs = logState.allLogs.filter(l => l.level === 'ERROR');
      if (errorLogs.length === 0) {
        toast('No errors found', 'info');
        return;
      }
      setLogFilter('ERROR');
      scrollLogsToBottom();
    }

    // Add keyboard shortcuts for logs
    document.addEventListener('keydown', (e) => {
      // Only when logs tab is active
      const logsPage = document.getElementById('page-logs');
      if (!logsPage || !logsPage.classList.contains('active')) return;

      if (e.key === 'Escape') {
        // Clear search on Escape
        const searchInput = document.getElementById('logSearch');
        if (searchInput && searchInput.value) {
          searchInput.value = '';
          filterLogs();
        }
      }
      
      // Ctrl/Cmd + Down to scroll to bottom
      if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowDown') {
        e.preventDefault();
        scrollLogsToBottom();
      }
    });

    function clearLogs(confirmed = false) {
      if (!confirmed) {
        document.getElementById('modalTitle').textContent = 'Clear System Logs';
        document.getElementById('modalContent').innerHTML = `
            <div style="text-align:center; padding: 24px 0;">
                <div style="width:64px; height:64px; background:rgba(248, 113, 113, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </div>
                <h4 style="margin-bottom:8px; font-size:18px;">Clear all logs?</h4>
                <p style="color:var(--text-secondary); font-size:14px; max-width:300px; margin:0 auto;">This action will permanently delete the current log history. This cannot be undone.</p>
            </div>
         `;
        document.getElementById('modalFooter').innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-danger" onclick="clearLogs(true)">Yes, Clear All</button>
         `;
        document.getElementById('modal').classList.add('active');
        return;
      }

      closeModal();
      api('DELETE', '/logs')
        .then(() => {
          toast('Logs cleared successfully', 'success');
          // Reset log state for fresh start
          logState.latestTimestamp = 0;
          logState.allLogs = [];
          logState.errorCount = 0;
          logState.warnCount = 0;
          loadLogs();
        })
        .catch(e => {
          toast('Failed to clear logs: ' + e.message, 'error');
        });
    }

    document.getElementById('loginKey').addEventListener('keypress', e => {
      if (e.key === 'Enter') login();
    });
    checkAuth();
  </script>
</body>

</html>